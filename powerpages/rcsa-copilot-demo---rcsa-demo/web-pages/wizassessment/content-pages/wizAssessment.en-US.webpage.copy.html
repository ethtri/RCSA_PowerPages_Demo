<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Wizard - RCSA Copilot</title>
    
    <!-- Bootstrap 5 Foundation -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- RCSA Design System -->
    <link rel="stylesheet" href="rcsa-styles.css">
    
    <!-- RCSA Wizard Styles -->
    <link rel="stylesheet" href="css/rcsa-wizard-core.css">
    <link rel="stylesheet" href="css/rcsa-wizard-components.css">
    
    <!-- Minimal fallback styles in case CSS doesn't load -->
    <style>
        /* Critical fallback styles for core functionality */
        .residual-assessment-progress {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            border: 1px solid #B3D7FF;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .heat-map-cell {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        /* Heat map color fallbacks */
        .heat-map-cell.risk-1, .heat-map-cell.risk-2, .heat-map-cell.risk-3, .heat-map-cell.risk-4, .heat-map-cell.risk-5 { 
            background: #d4edda !important; color: #155724 !important; 
        }
        .heat-map-cell.risk-6, .heat-map-cell.risk-7, .heat-map-cell.risk-8, .heat-map-cell.risk-9, .heat-map-cell.risk-10 { 
            background: #d1ecf1 !important; color: #0c5460 !important; 
        }
        .heat-map-cell.risk-11, .heat-map-cell.risk-12, .heat-map-cell.risk-13, .heat-map-cell.risk-14, .heat-map-cell.risk-15 { 
            background: #fff3cd !important; color: #856404 !important; 
        }
        .heat-map-cell.risk-16, .heat-map-cell.risk-17, .heat-map-cell.risk-18, .heat-map-cell.risk-19, .heat-map-cell.risk-20 { 
            background: #f8d7da !important; color: #721c24 !important; 
        }
        .heat-map-cell.risk-21, .heat-map-cell.risk-22, .heat-map-cell.risk-23, .heat-map-cell.risk-24, .heat-map-cell.risk-25 { 
            background: #f5c6cb !important; color: #721c24 !important; 
        }
        
        .heat-map-cell:hover {
            transform: scale(1.05);
            border-color: #0066CC;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,102,204,0.2);
        }
        
        .heat-map-cell.selected {
            border-color: #0066CC;
            border-width: 3px;
            background: #e3f2fd;
        }
        
        .residual-assessment-card {
            background: white;
            border: 2px solid #E5E8EC;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background-color: #0066CC;
            border-color: #0066CC;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0052A3;
            border-color: #0052A3;
        }
    </style>
    
    <!-- All other styles now loaded from external CSS files -->
    <style>
        /* Emergency fallback for critical variables only */
        :root {
            --captech-primary: #0066CC;
            --captech-success: #0D7F3F;
            --captech-warning: #CC6600;
            --captech-danger: #CC0000;
            --captech-light: #F5F5F5;
            --captech-border: #E5E5E5;
            --captech-orange: #FEA002;
        }
        
        /* All other styles moved to external CSS files for better maintainability */
    </style>
</head>
<body>
    <header class="rcsa-header">
        <div class="rcsa-header-content">
            <!-- Brand Section -->
            <div class="rcsa-brand">
                <a href="/scrDashboard_1LoD" class="rcsa-logo" title="Back to Dashboard">
                    RC
                </a>
                <div class="rcsa-brand-text">
                    <h1 class="rcsa-title">RCSA Copilot</h1>
                    <p class="rcsa-subtitle">AI-Powered Risk & Control Self-Assessment</p>
                    <p class="rcsa-tagline">by CapTech</p>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="wizard-help">
                <a href="/scrHelp" class="help-btn">
                    <i class="bi bi-question-circle me-1"></i>
                    Help
                </a>
            </div>
        </div>
    </header>

    <!-- Assessment Context -->
    <div class="assessment-context">
        <div class="context-info">
            <div class="process-info">
                <div class="process-icon">
                    <i class="bi bi-arrow-left-right"></i>
                </div>
                <div class="process-details">
                    <h2 id="process-name">Wire Transfer Assessment</h2>
                    <p class="process-meta">Retail Banking • Due Today • Last assessed 3 months ago</p>
                </div>
            </div>
            <div class="assessment-meta">
                <div><strong>Assessment Period:</strong> December 2024</div>
                <div><strong>Estimated Time:</strong> 8-12 minutes</div>
                <div><strong>Auto-saved:</strong> <span id="last-saved">Starting...</span></div>
            </div>
        </div>
    </div>

    <div class="container" style="max-width: 1200px;">
        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-header">
                <h3 class="progress-title" id="progress-title">Assessment Progress - Step 1 of 7</h3>
                <span class="current-step-name" id="current-step-name">Risk Review</span>
            </div>
            <div class="progress-indicator">
                <div class="step" data-step="1">
                    <div class="step-circle current">1</div>
                    <div class="step-connector"></div>
                    <div class="step-label current">Risk Review</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle future">2</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Inherent Risk</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle future">3</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Control Mapping</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle future">4</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Control Effectiveness</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle future">5</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Residual Risk</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-circle future">6</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Risk Response</div>
                </div>
                <div class="step" data-step="7">
                    <div class="step-circle future">7</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Review & Submit</div>
                </div>
            </div>
        </div>

        <!-- Wizard Content -->
        <div class="wizard-content">
            <!-- Pane 1: Risk Review -->
            <div class="wizard-pane active" id="pane-1">
                <div class="pane-header">
                    <h2 class="pane-title">Risk Review</h2>
                    <p class="pane-subtitle">Review and select risks for your Wire Transfer process assessment</p>
                </div>

                <!-- Risk Library -->
                <div class="risk-library">
                    <h4 class="mb-3">
                        <i class="bi bi-shield-exclamation text-primary me-2"></i>
                        Select Risks for Assessment
                    </h4>
                    
                    <div class="risk-card selected" data-risk="system-failure">
                        <div class="risk-title">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Wire Transfer System Failure
                        </div>
                        <div class="risk-description">
                            System outages, connectivity issues, or technical failures preventing wire transfer processing or causing processing delays.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Technology Risk</span>
                            <span>Typically L:3, I:4 | Operational disruption</span>
                        </div>
                    </div>

                    <div class="risk-card" data-risk="compliance-violation">
                        <div class="risk-title">
                            <i class="bi bi-square me-2"></i>
                            Regulatory Compliance Violation
                        </div>
                        <div class="risk-description">
                            Failure to comply with AML, BSA, OFAC, or other regulatory requirements for wire transfer reporting and monitoring.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Compliance Risk</span>
                            <span>Typically L:2, I:5 | Regulatory penalties</span>
                        </div>
                    </div>

                    <div class="risk-card" data-risk="processing-error">
                        <div class="risk-title">
                            <i class="bi bi-square me-2"></i>
                            Wire Processing Error
                        </div>
                        <div class="risk-description">
                            Manual processing errors, incorrect account numbers, wrong amounts, or misdirected transfers due to human error.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Operational Risk</span>
                            <span>Typically L:3, I:3 | Customer impact</span>
                        </div>
                    </div>
                </div>

                <!-- AI Risk Suggestions -->
                <div class="ai-suggestions">
                    <div class="ai-header">
                        <i class="bi bi-robot text-warning"></i>
                        <span class="ai-title">AI Risk Intelligence</span>
                        <div class="loading-spinner d-none" id="ai-spinner"></div>
                        <small class="text-muted ms-2">Analyzing industry trends...</small>
                    </div>
                    <p class="mb-3">Based on recent industry events and your organization's profile:</p>
                    
                    <div class="ai-risk-suggestion" data-risk="deepfake-voice">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="suggestion-header">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                    <strong>Deepfake Voice Authorization</strong>
                                    <span class="badge bg-danger ms-2">TRENDING</span>
                                </div>
                                <p class="suggestion-description mb-2">
                                    AI-generated voice mimicking customers to authorize fraudulent wire transfers. 
                                    <strong>3 incidents at peer banks this month</strong> with $2.8M in losses.
                                </p>
                                <div class="suggestion-meta">
                                    <span class="text-muted">
                                        <i class="bi bi-graph-up me-1"></i>
                                        ↑ 340% increase in reported cases (Dec 2024)
                                    </span>
                                    <span class="text-muted ms-3">
                                        <i class="bi bi-people me-1"></i>
                                        Added by 12 similar banks
                                    </span>
                                </div>
                            </div>
                            <div class="suggestion-actions">
                                <button class="btn btn-success btn-sm" onclick="acceptAISuggestion('deepfake-voice')">
                                    <i class="bi bi-check me-1"></i>Add
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="modifyAISuggestion('deepfake-voice')">
                                    <i class="bi bi-pencil me-1"></i>Modify
                                </button>
                                <button class="btn btn-outline-danger btn-sm ms-1" onclick="rejectAISuggestion('deepfake-voice')">
                                    <i class="bi bi-x me-1"></i>Dismiss
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="ai-risk-suggestion mt-3" data-risk="realtime-reversal">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="suggestion-header">
                                    <i class="bi bi-shield-exclamation text-info me-2"></i>
                                    <strong>Real-time Payment Reversal Risk</strong>
                                    <span class="badge bg-info ms-2">REGULATORY</span>
                                </div>
                                <p class="suggestion-description mb-2">
                                    New FedNow reversal requirements may create operational risks in wire transfer processes.
            background: linear-gradient(135deg, var(--captech-primary) 0%, #004499 100%);
            color: white;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .rcsa-header-content {
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .rcsa-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .rcsa-logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--captech-orange) 0%, #FF8C00 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .rcsa-brand-text {
            display: flex;
            flex-direction: column;
        }
        
        .rcsa-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            color: white;
            text-decoration: none;
        }
        
        .rcsa-subtitle {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.85);
            margin: 0;
            font-weight: 400;
        }
        
        .rcsa-tagline {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.7);
            margin: 0;
            font-weight: 300;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .wizard-help {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .help-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .help-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        /* Assessment Context Bar */
        .assessment-context {
            background: white;
            border-bottom: 1px solid var(--captech-border);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        
        .context-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .process-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .process-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--captech-primary) 0%, #004499 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .process-details h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2B2B2B;
        }
        
        .process-meta {
            font-size: 0.875rem;
            color: #666;
            margin: 0;
        }
        
        .assessment-meta {
            text-align: right;
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Progress Indicator */
        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--captech-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .progress-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0;
        }
        
        .current-step-name {
            font-size: 1rem;
            font-weight: 500;
            color: var(--captech-primary);
            background: rgba(0,102,204,0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            border: 1px solid rgba(0,102,204,0.2);
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        
        .step-circle.completed {
            background: var(--captech-success);
            color: white;
        }
        
        .step-circle.current {
            background: var(--captech-primary);
            color: white;
            box-shadow: 0 0 0 4px rgba(0,102,204,0.2);
        }
        
        .step-circle.future {
            background: #F5F5F5;
            color: #999;
            border: 2px solid #E5E5E5;
        }
        
        .step-label {
            font-size: 0.75rem;
            text-align: center;
            margin-top: 0.5rem;
            max-width: 80px;
        }
        
        .step-label.completed {
            color: var(--captech-success);
            font-weight: 600;
        }
        
        .step-label.current {
            color: var(--captech-primary);
            font-weight: 600;
        }
        
        .step-label.future {
            color: #999;
        }
        
        .step-connector {
            position: absolute;
            top: 20px;
            left: calc(50% + 20px);
            width: calc(100% - 40px);
            height: 2px;
            background: #E5E5E5;
            z-index: 1;
            transform: translateY(-50%);
        }
        
        .step-connector.completed {
            background: var(--captech-success);
        }
        
        .step:last-child .step-connector {
            display: none;
        }
        
        /* Wizard Content */
        .wizard-content {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--captech-border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 600px;
            margin-bottom: 2rem;
        }
        
        .wizard-pane {
            padding: 2rem;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .wizard-pane.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.8); }
        }
        
        .pane-header {
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--captech-border);
            padding-bottom: 1rem;
        }
        
        .pane-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0 0 0.5rem 0;
        }
        
        .pane-subtitle {
            color: #666;
            margin: 0;
        }
        
        /* Risk Cards */
        .risk-library {
            margin-bottom: 2rem;
        }
        
        .risk-card {
            background: #F8F9FA;
            border: 2px solid var(--captech-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .risk-card:hover {
            border-color: var(--captech-primary);
            box-shadow: 0 4px 8px rgba(0,102,204,0.1);
        }
        
        .risk-card.selected {
            border-color: var(--captech-success);
            background: #F0F8F4;
        }
        
        .risk-title {
            font-weight: 600;
            color: #2B2B2B;
            margin-bottom: 0.5rem;
        }
        
        .risk-description {
            color: #666;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .risk-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #999;
        }
        
        .risk-category {
            background: var(--captech-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        /* AI Suggestions */
        .ai-suggestions {
            background: linear-gradient(135deg, #F0F7FF 0%, #E3F2FD 100%);
            border: 1px solid #BBDEFB;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .ai-title {
            font-weight: 600;
            color: var(--captech-primary);
        }
        
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #E3F2FD;
            border-top: 2px solid var(--captech-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* AI Suggestion Styles */
        .ai-risk-suggestion {
            background: white;
            border: 2px solid #E3F2FD;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .ai-risk-suggestion:hover {
            border-color: var(--captech-primary);
            box-shadow: 0 4px 8px rgba(0,102,204,0.1);
        }
        
        .suggestion-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .suggestion-description {
            color: #333;
            font-size: 0.9rem;
        }
        
        .suggestion-meta {
            font-size: 0.8rem;
        }
        
        .suggestion-actions {
            min-width: 220px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }
        
        .suggestion-actions .btn {
            width: 100%;
            justify-content: center;
        }
        
        .insight-metric .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .insight-metric .metric-label {
            font-size: 0.75rem;
            color: #666;
        }
        
        /* Risk Assessment Card Styles */
        .risk-assessment-card {
            background: white;
            border: 1px solid var(--captech-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .risk-assessment-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--captech-border);
            padding-bottom: 1rem;
        }
        
        .risk-assessment-header h4 {
            margin: 0;
            font-size: 1.25rem;
            flex-grow: 1;
        }
        
        .context-panel, .ai-analysis-panel, .scoring-panel {
            background: #F8F9FA;
            border: 1px solid var(--captech-border);
            border-radius: 8px;
            padding: 1rem;
            height: 100%;
        }
        
        .context-panel h6, .ai-analysis-panel h6, .scoring-panel h6 {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .history-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }
        
        .score-pill {
            background: var(--captech-primary);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .score-pill.current {
            background: #CCC;
            color: #666;
        }
        
        .trend-stable {
            color: var(--captech-primary);
            font-size: 0.8rem;
        }
        
        .suggested-score {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #E5E5E5;
            border-radius: 3px;
            margin: 0.5rem 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--captech-warning) 0%, var(--captech-success) 100%);
            transition: width 0.3s ease;
        }
        
        .ai-reasoning p {
            font-size: 0.85rem;
            font-style: italic;
            color: #333;
        }
        
        /* Modern Risk Matrix Styles - Based on frontend-examples/residual-risk-assessment */
        .risk-matrix {
            position: relative;
        }
        
        /* Heat map with perfect axis alignment using CSS Grid */
        .heat-map-wrapper {
            display: grid;
            grid-template-columns: 80px 1fr;
            grid-template-rows: 1fr auto;
            gap: 8px;
            margin: 1rem 0;
            align-items: start;
        }

        .impact-axis-container {
            grid-column: 1;
            grid-row: 1;
            display: flex;
            position: relative;
            height: 300px;
        }

        .impact-axis-title {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            text-align: center;
        }

        .impact-labels-container {
            display: grid;
            grid-template-rows: repeat(5, 1fr);
            height: 300px;
            padding-right: 8px;
            padding-left: 25px;
            align-items: center;
        }

        .impact-labels-container .impact-label {
            font-size: 0.65rem;
            color: #6c757d;
            font-weight: 500;
            text-align: right;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .heat-map-grid-container {
            grid-column: 2;
            grid-row: 1;
            display: flex;
            justify-content: flex-start;
        }

        .likelihood-labels-container {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }

        .likelihood-axis {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.65rem;
            color: #6c757d;
            font-weight: 500;
            padding: 8px 0;
            gap: 4px;
            max-width: 300px;
        }

        .likelihood-axis .axis-title {
            font-weight: 600;
            color: #495057;
            margin-top: 8px;
            text-align: center;
            width: 100%;
            font-size: 0.8rem;
        }
        
        .heat-map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 2px;
            width: 100%;
            max-width: 300px;
            aspect-ratio: 1;
        }

        .heat-map-cell {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .heat-map-cell:hover {
            transform: scale(1.05);
            border-color: var(--captech-primary);
            z-index: 10;
        }

        .heat-map-cell.selected {
            border-color: var(--captech-primary);
            border-width: 3px;
            transform: scale(1.1);
            z-index: 10;
        }

        /* Risk Level Colors - matching the screenshot */
        .heat-map-cell.risk-1 { background: #d4edda; color: #155724; }
        .heat-map-cell.risk-2 { background: #d1ecf1; color: #0c5460; }
        .heat-map-cell.risk-3 { background: #fff3cd; color: #856404; }
        .heat-map-cell.risk-4 { background: #f8d7da; color: #721c24; }
        .heat-map-cell.risk-5 { background: #f5c6cb; color: #721c24; }

        /* AI Recommended Score Badge */
        .heat-map-cell.ai-suggested {
            border: 2px solid var(--captech-primary) !important;
            box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2) !important;
            animation: ai-glow 2s ease-in-out infinite alternate;
        }

        .heat-map-cell.ai-suggested::after {
            content: "🤖";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 0.8rem;
        }

        @keyframes ai-glow {
            from { box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2); }
            to { box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.4); }
        }
        
        /* KRI Styles */
        .kri-correlation {
            background: #F8F9FA;
            border: 1px solid var(--captech-border);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .kri-item {
            background: white;
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 0.75rem;
        }
        
        .kri-value {
            font-weight: 600;
        }
        
        .mini-chart {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        
        /* Control Mapping Styles */
        .control-mapping-card {
            background: white;
            border: 1px solid var(--captech-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-mapping-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--captech-border);
            padding-bottom: 1rem;
        }
        
        .control-search-section {
            background: #F8F9FA;
            border: 1px solid var(--captech-border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .control-search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #E5E5E5;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .control-search-input:focus {
            border-color: var(--captech-primary);
            box-shadow: 0 0 0 0.2rem rgba(0,102,204,0.25);
            outline: none;
        }
        
        .ai-control-suggestions {
            background: linear-gradient(135deg, #E3F2FD 0%, #F0F8FF 100%);
            border: 1px solid #BBDEFB;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .control-suggestion-item {
            background: white;
            border: 2px solid #E3F2FD;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .control-suggestion-item:hover {
            border-color: var(--captech-primary);
            box-shadow: 0 4px 8px rgba(0,102,204,0.1);
        }
        
        .control-suggestion-item.linked {
            border-color: var(--captech-success);
            background: #F0F8F4;
        }
        
        .control-match-score {
            display: inline-block;
            background: var(--captech-primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        
        .control-match-score.high {
            background: var(--captech-success);
        }
        
        .control-match-score.medium {
            background: var(--captech-warning);
        }
        
        .control-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .control-type-preventive {
            background: #D4F1D4;
            color: #0D7F3F;
        }
        
        .control-type-detective {
            background: #FFE4CC;
            color: #CC6600;
        }
        
        .control-automation-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .control-automated {
            background: #E3F2FD;
            color: var(--captech-primary);
        }
        
        .control-manual {
            background: #FFF3CD;
            color: #856404;
        }
        
        .linked-controls-section {
            background: #F0F8F4;
            border: 1px solid #A3CFBB;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .linked-control-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border: 1px solid #A3CFBB;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .linked-control-item:last-child {
            margin-bottom: 0;
        }
        
        .control-gap-analysis {
            background: #FFF8E1;
            border: 1px solid #FFE082;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .gap-insight {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .link-control-btn {
            background: var(--captech-success);
            color: white;
            border: 2px solid var(--captech-success);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
        }

        /* Enhanced Control Mapping Styles */
        .control-progress-dashboard {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--captech-border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .progress-metric-card {
            background: #FAFBFC;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .progress-metric-card:hover {
            background: #F0F4F8;
            border-color: var(--captech-primary);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            border: 1px solid #E5E8EC;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2B2B2B;
            margin: 0;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* AI Assistant Panel */
        .ai-assistant-panel {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            border: 1px solid #B3D7FF;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .ai-assistant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .ai-avatar {
            width: 36px;
            height: 36px;
            background: var(--captech-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
        }

        .ai-confidence-badge {
            background: rgba(0,102,204,0.1);
            border: 1px solid rgba(0,102,204,0.2);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            text-align: center;
        }

        .confidence-score {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--captech-primary);
            display: block;
        }

        .ai-confidence-badge small {
            color: #6B6B6B;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-insights {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 1rem;
        }

        .ai-insight-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #4A4A4A;
        }

        .ai-insight-item:last-child {
            margin-bottom: 0;
        }

        /* Enhanced Risk Card for Control Mapping */
        .enhanced-risk-card {
            background: white;
            border: 2px solid #E5E8EC;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .enhanced-risk-card.complete {
            border-color: var(--captech-success);
            box-shadow: 0 4px 16px rgba(13,127,63,0.1);
        }

        .enhanced-risk-card.partial {
            border-color: var(--captech-warning);
            box-shadow: 0 4px 16px rgba(204,102,0,0.1);
        }

        .enhanced-risk-card.empty {
            border-color: #E5E8EC;
        }

        .risk-card-header {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            padding: 1.5rem;
            border-bottom: 1px solid #E5E8EC;
        }

        .risk-card-title {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .risk-title-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0;
        }

        .coverage-progress-bar {
            width: 100%;
            height: 8px;
            background: #E5E8EC;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.75rem 0;
        }

        .coverage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--captech-success) 0%, #20c997 100%);
            border-radius: 4px;
            transition: all 0.5s ease;
        }

        .coverage-fill.partial {
            background: linear-gradient(90deg, var(--captech-warning) 0%, #ffc107 100%);
        }

        .coverage-fill.over-allocated {
            background: linear-gradient(90deg, var(--captech-danger) 0%, #dc3545 100%);
            animation: pulse-warning 2s infinite;
        }

        .coverage-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }

        .coverage-percentage {
            font-weight: 600;
            color: var(--captech-primary);
        }

        .control-type-distribution {
            color: #6B6B6B;
        }

        /* Control Suggestion Cards */
        .control-suggestions-section {
            padding: 1.5rem;
            border-bottom: 1px solid #E5E8EC;
        }

        .ai-control-card {
            background: #FAFBFC;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-control-card:hover {
            background: #F0F4F8;
            border-color: var(--captech-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.1);
        }

        .ai-control-card.linked {
            background: #F0F8F4;
            border-color: var(--captech-success);
        }

        .control-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .control-match-score {
            background: var(--captech-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .control-match-score.high {
            background: var(--captech-success);
        }

        .control-match-score.medium {
            background: var(--captech-warning);
        }

        .control-title {
            font-weight: 600;
            color: #2B2B2B;
            margin: 0 0 0.25rem 0;
        }

        .control-description {
            color: #6B6B6B;
            font-size: 0.9rem;
            margin: 0 0 0.75rem 0;
            line-height: 1.4;
        }

        .control-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .control-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-type-preventive {
            background: #D4F1D4;
            color: #0D7F3F;
        }

        .control-type-detective {
            background: #FFE4CC;
            color: #CC6600;
        }

        .control-automation-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-automated {
            background: #E3F2FD;
            color: var(--captech-primary);
        }

        .control-manual {
            background: #FFF3CD;
            color: #856404;
        }

        .control-action-btn {
            background: var(--captech-primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-action-btn:hover {
            background: #0052A3;
            transform: translateY(-1px);
        }

        .control-action-btn.linked {
            background: var(--captech-success);
            cursor: default;
        }

        .control-action-btn:disabled {
            background: #E5E8EC;
            color: #A0A0A0;
            cursor: not-allowed;
            transform: none;
        }

        /* Coverage Allocation Section */
        .coverage-allocation-section {
            padding: 1.5rem;
            background: #FAFBFC;
        }

        .allocation-control-item {
            background: white;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .allocation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .allocation-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .coverage-slider {
            flex: 1;
            min-width: 120px;
            height: 6px;
            border-radius: 3px;
            background: #E5E8EC;
            outline: none;
            -webkit-appearance: none;
        }

        .coverage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--captech-primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,102,204,0.3);
        }

        .coverage-input {
            width: 70px;
            text-align: center;
            border: 1px solid #E5E8EC;
            border-radius: 4px;
            padding: 0.25rem;
        }

        .preset-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .preset-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border: 1px solid #E5E8EC;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: var(--captech-primary);
            color: white;
            border-color: var(--captech-primary);
        }

        /* Global Actions */
        .global-actions {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--captech-border);
        }

        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Enhanced Control Search Modal Styles */
        .search-input-container {
            position: relative;
        }

        .search-input {
            padding-left: 40px;
            border-radius: 8px;
            border: 2px solid #E5E8EC;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--captech-primary);
            box-shadow: 0 0 0 0.2rem rgba(0,102,204,0.25);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6B6B6B;
            z-index: 10;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E5E8EC;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-suggestion-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #F0F0F0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-suggestion-item:hover {
            background: #F8FBFF;
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-title {
            font-weight: 600;
            color: #2B2B2B;
            margin-bottom: 0.25rem;
        }

        .suggestion-category {
            font-size: 0.75rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Search Results */
        .search-results {
            max-height: 500px;
            overflow-y: auto;
        }

        .control-search-card {
            background: white;
            border: 2px solid #E5E8EC;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .control-search-card:hover {
            border-color: var(--captech-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.1);
        }

        .control-search-card.selected {
            border-color: var(--captech-primary);
            background: #F8FBFF;
            box-shadow: 0 4px 12px rgba(0,102,204,0.15);
        }

        .control-search-card.already-linked {
            border-color: var(--captech-success);
            background: #F0F8F4;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .control-search-header {
            display: flex;
            justify-content: between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .control-search-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0 0 0.25rem 0;
        }

        .control-search-category {
            font-size: 0.75rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-search-description {
            color: #4A4A4A;
            font-size: 0.9rem;
            line-height: 1.4;
            margin: 0 0 0.75rem 0;
        }

        .control-search-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-selection-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 24px;
            height: 24px;
            border: 2px solid #E5E8EC;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .control-search-card.selected .search-selection-indicator {
            border-color: var(--captech-primary);
            background: var(--captech-primary);
            color: white;
        }

        .control-search-card.already-linked .search-selection-indicator {
            border-color: var(--captech-success);
            background: var(--captech-success);
            color: white;
        }

        .search-highlight {
            background: #FFE066;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Modal Enhancements */
        .modal-xl {
            max-width: 1200px;
        }

        .search-interface {
            background: #FAFBFC;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #E5E8EC;
        }

        .no-results-message {
            text-align: center;
            padding: 3rem;
            color: #6B6B6B;
        }

        .no-results-message i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Control Effectiveness Assessment Styles */
        .cei-dashboard {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--captech-border);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .cei-summary-card {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            border: 1px solid #B3D7FF;
            border-radius: 12px;
            padding: 2rem;
        }

        .cei-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .cei-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2B2B2B;
        }

        .cei-score {
            text-align: right;
        }

        .cei-percentage {
            display: block;
            font-size: 3rem;
            font-weight: 700;
            color: var(--captech-primary);
            line-height: 1;
        }

        .cei-rating {
            font-size: 0.9rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .cei-progress-container {
            margin-bottom: 2rem;
        }

        .cei-progress-bar {
            width: 100%;
            height: 12px;
            background: #E5E8EC;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .cei-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--captech-success) 0%, #20c997 100%);
            border-radius: 6px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cei-progress-fill.excellent {
            background: linear-gradient(90deg, var(--captech-success) 0%, #20c997 100%);
        }

        .cei-progress-fill.good {
            background: linear-gradient(90deg, #28a745 0%, var(--captech-success) 100%);
        }

        .cei-progress-fill.fair {
            background: linear-gradient(90deg, var(--captech-warning) 0%, #ffc107 100%);
        }

        .cei-progress-fill.poor {
            background: linear-gradient(90deg, var(--captech-danger) 0%, #dc3545 100%);
        }

        .cei-calculation {
            font-size: 0.9rem;
            color: #4A4A4A;
            font-weight: 500;
        }

        .breakdown-metric {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 1rem;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--captech-primary);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.75rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* AI Insights Panel */
        .effectiveness-insights-panel {
            background: white;
            border: 1px solid var(--captech-border);
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
        }

        .insights-title {
            margin: 0 0 1rem 0;
            font-weight: 600;
            color: #2B2B2B;
        }

        .insights-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .insight-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #FAFBFC;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-item i {
            margin-top: 0.1rem;
        }

        /* Risk-Based Assessment Structure */
        .risk-assessment-group {
            background: white;
            border: 2px solid #E5E8EC;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .risk-group-header {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFF3C4 100%);
            padding: 1.5rem;
            border-bottom: 1px solid #E5E8EC;
        }

        .risk-group-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .risk-title-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0;
        }

        .risk-score-display {
            background: var(--captech-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .risk-meta-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6B6B6B;
        }

        /* Control Assessment Cards within Risk Groups */
        .control-assessment-card {
            background: #FAFBFC;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            margin: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .control-assessment-card.assessed {
            border-color: var(--captech-success);
            box-shadow: 0 4px 16px rgba(13,127,63,0.1);
        }

        .control-assessment-card.partial {
            border-color: var(--captech-warning);
            box-shadow: 0 4px 16px rgba(204,102,0,0.1);
        }

        .control-assessment-header {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            padding: 1.5rem;
            border-bottom: 1px solid #E5E8EC;
        }

        .control-assessment-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .control-title-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2B2B2B;
            margin: 0;
        }

        .control-cei-score {
            background: var(--captech-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .control-cei-score.excellent {
            background: var(--captech-success);
        }

        .control-cei-score.good {
            background: #28a745;
        }

        .control-cei-score.fair {
            background: var(--captech-warning);
        }

        .control-cei-score.poor {
            background: var(--captech-danger);
        }

        .control-meta-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6B6B6B;
        }

        .risk-context-note {
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(255, 193, 7, 0.1);
            border-left: 3px solid var(--captech-warning);
            border-radius: 4px;
        }

        /* Assessment Interface */
        .assessment-interface {
            padding: 2rem;
        }

        .effectiveness-assessment-row {
            margin-bottom: 2rem;
        }

        .assessment-section {
            background: #FAFBFC;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .assessment-label {
            font-weight: 600;
            color: #2B2B2B;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .effectiveness-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #E5E8EC;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .effectiveness-select:focus {
            border-color: var(--captech-primary);
            box-shadow: 0 0 0 0.2rem rgba(0,102,204,0.25);
        }

        .effectiveness-explanation {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #F0F4F8;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #4A4A4A;
            line-height: 1.4;
        }

        /* AI Analysis Section */
        .ai-analysis-section {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFF3C4 100%);
            border: 1px solid #FFE082;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .ai-analysis-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .ai-analysis-content {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #4A4A4A;
        }

        /* Evidence Section */
        .evidence-section {
            background: #F0F8F4;
            border: 1px solid #A3CFBB;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .evidence-upload {
            border: 2px dashed #A3CFBB;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: rgba(255,255,255,0.5);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .evidence-upload:hover {
            border-color: var(--captech-success);
            background: white;
        }

        .evidence-upload i {
            font-size: 2rem;
            color: var(--captech-success);
            margin-bottom: 0.5rem;
        }

        /* Assessment Actions */
        .assessment-actions {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--captech-border);
        }
        
        .link-control-btn:hover {
            background: #0D7F3F;
            border-color: #0D7F3F;
            color: white;
        }
        
        .unlink-control-btn {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .unlink-control-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Summary Cards */
        .summary-card {
            background: #F8F9FA;
            border: 1px solid var(--captech-border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-item {
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--captech-primary);
            margin-bottom: 0.25rem;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Navigation */
        .wizard-navigation {
            background: white;
            border-top: 1px solid var(--captech-border);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-btn {
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-btn.primary {
            background: var(--captech-primary);
            color: white;
            border: 2px solid var(--captech-primary);
        }
        
        .nav-btn.primary:hover {
            background: #0052A3;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,102,204,0.3);
        }
        
        .nav-btn.secondary {
            background: white;
            color: var(--captech-primary);
            border: 2px solid var(--captech-border);
        }
        
        .nav-btn.secondary:hover {
            border-color: var(--captech-primary);
            color: var(--captech-primary);
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .save-draft {
            color: #666;
            text-decoration: none;
            font-size: 0.875rem;
        }
        
        .save-draft:hover {
            color: var(--captech-primary);
        }
        
        /* Residual Risk Assessment Styles */
        .residual-assessment-progress {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            border: 1px solid #B3D7FF;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .calculation-formula {
            background: #F8F9FA;
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
        }

        /* 5x5 Heat Map Grid Styles */
        .residual-heat-map-container {
            background: white;
            border: 1px solid #E5E8EC;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .heat-map-wrapper {
            display: grid;
            grid-template-columns: 80px 1fr;
            grid-template-rows: 1fr auto;
            gap: 8px;
            margin: 1rem 0;
            align-items: start;
        }

        .impact-axis-container {
            grid-column: 1;
            grid-row: 1;
            display: flex;
            position: relative;
            height: 300px;
        }

        .impact-axis-title {
            writing-mode: vertical-lr;
            text-orientation: mixed;
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            text-align: center;
        }

        .impact-labels-container {
            display: grid;
            grid-template-rows: repeat(5, 1fr);
            height: 300px;
            padding-right: 8px;
            padding-left: 25px;
            align-items: center;
        }

        .impact-labels-container .impact-label {
            font-size: 0.65rem;
            color: #6c757d;
            font-weight: 500;
            text-align: right;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .heat-map-grid-container {
            grid-column: 2;
            grid-row: 1;
            display: flex;
            justify-content: flex-start;
        }

        .heat-map-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 2px;
            width: 300px;
            height: 300px;
        }

        .heat-map-cell {
            aspect-ratio: 1;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .heat-map-cell:hover {
            transform: scale(1.05);
            border-color: var(--captech-primary);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,102,204,0.2);
        }

        .heat-map-cell.selected {
            border-color: var(--captech-primary);
            border-width: 3px;
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 6px 16px rgba(0,102,204,0.3);
        }

        .heat-map-cell.ai-recommended {
            border: 2px solid #FFD700 !important;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3) !important;
            animation: ai-glow 2s ease-in-out infinite alternate;
        }

        @keyframes ai-glow {
            from { box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.1); }
            to { box-shadow: 0 0 0 4px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.2); }
        }

        /* Heat Map Cell Colors - Complete Risk Score Coverage */
        /* Low Risk (1-5) - Green */
        .heat-map-cell.risk-1, .heat-map-cell.risk-2, .heat-map-cell.risk-3, .heat-map-cell.risk-4, .heat-map-cell.risk-5 { 
            background: #d4edda; color: #155724; 
        }
        
        /* Medium-Low Risk (6-10) - Light Blue */
        .heat-map-cell.risk-6, .heat-map-cell.risk-7, .heat-map-cell.risk-8, .heat-map-cell.risk-9, .heat-map-cell.risk-10 { 
            background: #d1ecf1; color: #0c5460; 
        }
        
        /* Medium Risk (11-15) - Yellow/Amber */
        .heat-map-cell.risk-11, .heat-map-cell.risk-12, .heat-map-cell.risk-13, .heat-map-cell.risk-14, .heat-map-cell.risk-15 { 
            background: #fff3cd; color: #856404; 
        }
        
        /* High Risk (16-20) - Orange/Red */
        .heat-map-cell.risk-16, .heat-map-cell.risk-17, .heat-map-cell.risk-18, .heat-map-cell.risk-19, .heat-map-cell.risk-20 { 
            background: #f8d7da; color: #721c24; 
        }
        
        /* Critical Risk (21-25) - Dark Red */
        .heat-map-cell.risk-21, .heat-map-cell.risk-22, .heat-map-cell.risk-23, .heat-map-cell.risk-24, .heat-map-cell.risk-25 { 
            background: #f5c6cb; color: #721c24; 
        }

        .likelihood-labels-container {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }

        .likelihood-axis {
            display: flex;
            justify-content: space-around;
            align-items: center;
            font-size: 0.65rem;
            color: #6c757d;
            font-weight: 500;
            padding: 8px 0;
            gap: 4px;
            max-width: 300px;
        }

        .likelihood-axis .axis-title {
            font-weight: 600;
            color: #495057;
            margin-top: 8px;
            text-align: center;
            width: 100%;
            font-size: 0.8rem;
        }

        /* Residual Assessment Card */
        .residual-assessment-card {
            background: white;
            border: 2px solid #E5E8EC;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .residual-assessment-card.completed {
            border-color: var(--captech-success);
            box-shadow: 0 4px 16px rgba(13,127,63,0.1);
        }

        .residual-assessment-card.high-risk {
            border-color: var(--captech-danger);
            box-shadow: 0 4px 16px rgba(220,53,69,0.1);
            animation: pulse-danger 3s infinite;
        }

        @keyframes pulse-danger {
            0% { box-shadow: 0 4px 16px rgba(220,53,69,0.1); }
            50% { box-shadow: 0 8px 24px rgba(220,53,69,0.2); }
            100% { box-shadow: 0 4px 16px rgba(220,53,69,0.1); }
        }

        .residual-card-header {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
        }

        /* ================================================================
           RISK RESPONSE PLANNING STYLES (PANE 6)
        ================================================================ */

        /* AI Response Overview Panel */
        .ai-response-overview {
            background: linear-gradient(135deg, #E3F2FD 0%, #F0F8FF 100%);
            border: 1px solid #BBDEFB;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .overview-content h5 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2B2B2B;
        }

        .response-stats .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 0.75rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6B6B6B;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Risk Response Cards */
        .risk-response-card {
            background: white;
            border: 1px solid #E5E8EC;
            border-radius: 12px;
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .risk-response-card.strategy-selected {
            border-color: var(--captech-primary);
            box-shadow: 0 4px 16px rgba(0,102,204,0.1);
        }

        .risk-response-header {
            background: linear-gradient(135deg, #F8FBFF 0%, #EDF4FF 100%);
            padding: 1.5rem;
            border-bottom: 1px solid #E5E8EC;
        }

        .risk-response-title {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .response-risk-score {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            margin-left: 1rem;
        }

        .response-risk-score.low {
            background: #d1e7dd;
            color: #0a3622;
        }

        .response-risk-score.medium {
            background: #fff3cd;
            color: #856404;
        }

        .response-risk-score.high {
            background: #f8d7da;
            color: #58151c;
        }

        .response-risk-score.critical {
            background: #f8d7da;
            color: #58151c;
            animation: pulse-danger 2s infinite;
        }

        .risk-meta-info {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6B6B6B;
        }

        /* Response Strategy Options */
        .response-strategies {
            padding: 1.5rem;
        }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .strategy-option {
            background: #FAFBFC;
            border: 2px solid #E5E8EC;
            border-radius: 8px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .strategy-option:hover {
            border-color: var(--captech-primary);
            background: #F8FBFF;
        }

        .strategy-option.selected {
            border-color: var(--captech-primary);
            background: #F0F8F4;
            box-shadow: 0 4px 8px rgba(0,102,204,0.1);
        }

        .strategy-option.ai-recommended {
            border-color: var(--captech-success);
            background: #F0F8F4;
        }

        .strategy-option.ai-recommended::before {
            content: "AI Recommended";
            position: absolute;
            top: -8px;
            right: 8px;
            background: var(--captech-success);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
        }

        .strategy-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .strategy-icon.accept {
            background: #d1e7dd;
            color: #0a3622;
        }

        .strategy-icon.monitor {
            background: #cfe2ff;
            color: #084298;
        }

        .strategy-icon.enhance {
            background: #fff3cd;
            color: #856404;
        }

        .strategy-icon.transfer {
            background: #f8d7da;
            color: #58151c;
        }

        .strategy-title {
            font-weight: 600;
            color: #2B2B2B;
            margin-bottom: 0.5rem;
        }

        .strategy-description {
            font-size: 0.875rem;
            color: #6B6B6B;
            line-height: 1.4;
            margin-bottom: 1rem;
        }

        .strategy-metrics {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .metric-item {
            text-align: center;
        }

        .metric-label {
            color: #6B6B6B;
            margin-bottom: 0.25rem;
        }

        .metric-value {
            font-weight: 600;
            color: #2B2B2B;
        }

        /* AI Insights Section */
        .ai-response-insights {
            background: #FAFBFC;
            border: 1px solid #E5E8EC;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .ai-insights-content {
            font-size: 0.875rem;
            color: #4A4A4A;
            line-height: 1.4;
        }

        /* Action Items Panel */
        .action-items-panel {
            background: #F8FBFF;
            border: 1px solid #BBDEFB;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .action-items-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .action-item {
            background: white;
            border: 1px solid #E5E8EC;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .action-item:last-child {
            margin-bottom: 0;
        }

        .action-text {
            flex-grow: 1;
            font-size: 0.875rem;
            color: #4A4A4A;
        }

        .action-timeline {
            font-size: 0.75rem;
            color: #6B6B6B;
            padding: 0.25rem 0.5rem;
            background: #F0F0F0;
            border-radius: 12px;
        }

        .action-timeline.immediate {
            background: #f8d7da;
            color: #58151c;
        }

        .action-timeline.short-term {
            background: #fff3cd;
            color: #856404;
        }

        .action-timeline.long-term {
            background: #cfe2ff;
            color: #084298;
        }

        /* Response Summary Panel */
        .response-summary-panel {
            background: white;
            border: 1px solid #E5E8EC;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .summary-header h5 {
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2B2B2B;
        }

        /* Strategy Bar Chart */
        .strategy-bar-chart {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .strategy-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .strategy-bar-label {
            width: 80px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4A4A4A;
        }

        .strategy-bar-fill {
            flex-grow: 1;
            height: 24px;
            background: #F0F0F0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .strategy-bar-progress {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s ease;
        }

        .strategy-bar-progress.accept {
            background: linear-gradient(90deg, #d1e7dd 0%, #a3d9bb 100%);
        }

        .strategy-bar-progress.monitor {
            background: linear-gradient(90deg, #cfe2ff 0%, #9ec5fe 100%);
        }

        .strategy-bar-progress.enhance {
            background: linear-gradient(90deg, #fff3cd 0%, #ffecb5 100%);
        }

        .strategy-bar-progress.transfer {
            background: linear-gradient(90deg, #f8d7da 0%, #f1aeb5 100%);
        }

        .strategy-bar-count {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: #4A4A4A;
        }

        /* Implementation Timeline */
        .implementation-timeline {
            background: #FAFBFC;
            border-radius: 8px;
            padding: 1rem;
        }

        .timeline-summary {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .timeline-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #E5E8EC;
        }

        .timeline-label {
            font-size: 0.875rem;
            color: #4A4A4A;
        }

        .timeline-value {
            font-weight: 600;
            color: var(--captech-primary);
        }

        /* Global Response Actions */
        .global-response-actions {
            margin-top: 2rem;
        }

        .global-response-actions .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .strategy-grid {
                grid-template-columns: 1fr;
            }
            
            .ai-response-overview {
                padding: 1.5rem;
            }
            
            .response-summary-panel {
                padding: 1.5rem;
            }
            
            .strategy-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .strategy-bar-label {
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Custom RCSA Copilot Header -->
    <header class="rcsa-header">
        <div class="rcsa-header-content">
            <!-- Brand Section -->
            <div class="rcsa-brand">
                <a href="/scrDashboard_1LoD" class="rcsa-logo" title="Back to Dashboard">
                    RC
                </a>
                <div class="rcsa-brand-text">
                    <h1 class="rcsa-title">RCSA Copilot</h1>
                    <p class="rcsa-subtitle">AI-Powered Risk & Control Self-Assessment</p>
                    <p class="rcsa-tagline">by CapTech</p>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="wizard-help">
                <a href="/scrHelp" class="help-btn">
                    <i class="bi bi-question-circle me-1"></i>
                    Help
                </a>
            </div>
        </div>
    </header>

    <!-- Assessment Context -->
    <div class="assessment-context">
        <div class="context-info">
            <div class="process-info">
                <div class="process-icon">
                    <i class="bi bi-arrow-left-right"></i>
                </div>
                <div class="process-details">
                    <h2 id="process-name">Wire Transfer Assessment</h2>
                    <p class="process-meta">Retail Banking • Due Today • Last assessed 3 months ago</p>
                </div>
            </div>
            <div class="assessment-meta">
                <div><strong>Assessment Period:</strong> December 2024</div>
                <div><strong>Estimated Time:</strong> 8-12 minutes</div>
                <div><strong>Auto-saved:</strong> <span id="last-saved">Starting...</span></div>
            </div>
        </div>
    </div>

    <div class="container" style="max-width: 1200px;">
        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-header">
                <h3 class="progress-title" id="progress-title">Assessment Progress - Step 1 of 7</h3>
                <span class="current-step-name" id="current-step-name">Risk Review</span>
            </div>
            <div class="progress-indicator">
                <div class="step" data-step="1">
                    <div class="step-circle current">1</div>
                    <div class="step-connector"></div>
                    <div class="step-label current">Risk Review</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-circle future">2</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Inherent Risk</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-circle future">3</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Control Mapping</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-circle future">4</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Effectiveness</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-circle future">5</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Residual Risk</div>
                </div>
                <div class="step" data-step="6">
                    <div class="step-circle future">6</div>
                    <div class="step-connector"></div>
                    <div class="step-label future">Response</div>
                </div>
                <div class="step" data-step="7">
                    <div class="step-circle future">7</div>
                    <div class="step-label future">Review & Submit</div>
                </div>
            </div>
        </div>

        <!-- Wizard Content -->
        <div class="wizard-content">
            <!-- Pane 1: Risk Review -->
            <div class="wizard-pane active" id="pane-1">
                <div class="pane-header">
                    <h2 class="pane-title">Review Risks for Wire Transfer Process</h2>
                    <p class="pane-subtitle">Select the risks that apply to your Wire Transfer operations. We've pre-identified common risks from our library.</p>
                </div>

                <!-- Pre-Identified Risks -->
                <div class="risk-library">
                    <h4><i class="bi bi-list-check text-primary me-2"></i>Pre-Identified Risks (from Risk Library)</h4>
                    <p class="text-muted mb-3">These risks are commonly associated with Wire Transfer processes in banking:</p>

                    <div class="risk-card selected" data-risk="unauthorized-transfer">
                        <div class="risk-title">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Unauthorized Wire Transfer
                        </div>
                        <div class="risk-description">
                            Risk of fraudulent or unauthorized wire transfers due to inadequate authentication, social engineering, or compromised credentials.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Operational Risk</span>
                            <span>Typically L:4, I:5 | $2M+ potential impact</span>
                        </div>
                    </div>

                    <div class="risk-card selected" data-risk="system-failure">
                        <div class="risk-title">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Wire Transfer System Failure
                        </div>
                        <div class="risk-description">
                            System outages, connectivity issues, or technical failures preventing wire transfer processing or causing processing delays.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Technology Risk</span>
                            <span>Typically L:3, I:4 | Operational disruption</span>
                        </div>
                    </div>

                    <div class="risk-card" data-risk="compliance-violation">
                        <div class="risk-title">
                            <i class="bi bi-square me-2"></i>
                            Regulatory Compliance Violation
                        </div>
                        <div class="risk-description">
                            Failure to comply with AML, BSA, OFAC, or other regulatory requirements for wire transfer reporting and monitoring.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Compliance Risk</span>
                            <span>Typically L:2, I:5 | Regulatory penalties</span>
                        </div>
                    </div>

                    <div class="risk-card" data-risk="processing-error">
                        <div class="risk-title">
                            <i class="bi bi-square me-2"></i>
                            Wire Processing Error
                        </div>
                        <div class="risk-description">
                            Manual processing errors, incorrect account numbers, wrong amounts, or misdirected transfers due to human error.
                        </div>
                        <div class="risk-meta">
                            <span class="risk-category">Operational Risk</span>
                            <span>Typically L:3, I:3 | Customer impact</span>
                        </div>
                    </div>
                </div>

                <!-- AI Risk Suggestions -->
                <div class="ai-suggestions">
                    <div class="ai-header">
                        <i class="bi bi-robot text-warning"></i>
                        <span class="ai-title">AI Risk Intelligence</span>
                        <div class="loading-spinner d-none" id="ai-spinner"></div>
                        <small class="text-muted ms-2">Analyzing industry trends...</small>
                    </div>
                    <p class="mb-3">Based on recent industry events and your organization's profile:</p>
                    
                    <div class="ai-risk-suggestion" data-risk="deepfake-voice">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="suggestion-header">
                                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                    <strong>Deepfake Voice Authorization</strong>
                                    <span class="badge bg-danger ms-2">TRENDING</span>
                                </div>
                                <p class="suggestion-description mb-2">
                                    AI-generated voice mimicking customers to authorize fraudulent wire transfers. 
                                    <strong>3 incidents at peer banks this month</strong> with $2.8M in losses.
                                </p>
                                <div class="suggestion-meta">
                                    <span class="text-muted">
                                        <i class="bi bi-graph-up me-1"></i>
                                        ↑ 340% increase in reported cases (Dec 2024)
                                    </span>
                                    <span class="text-muted ms-3">
                                        <i class="bi bi-people me-1"></i>
                                        Added by 12 similar banks
                                    </span>
                                </div>
                            </div>
                            <div class="suggestion-actions">
                                <button class="btn btn-success btn-sm" onclick="acceptAISuggestion('deepfake-voice')">
                                    <i class="bi bi-check me-1"></i>Add
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="modifyAISuggestion('deepfake-voice')">
                                    <i class="bi bi-pencil me-1"></i>Modify
                                </button>
                                <button class="btn btn-outline-danger btn-sm ms-1" onclick="rejectAISuggestion('deepfake-voice')">
                                    <i class="bi bi-x me-1"></i>Dismiss
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="ai-risk-suggestion mt-3" data-risk="realtime-reversal">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="suggestion-header">
                                    <i class="bi bi-shield-exclamation text-info me-2"></i>
                                    <strong>Real-time Payment Reversal Risk</strong>
                                    <span class="badge bg-info ms-2">REGULATORY</span>
                                </div>
                                <p class="suggestion-description mb-2">
                                    New FedNow reversal requirements may create operational risks in wire transfer processes. 
                                    <strong>Effective January 2025</strong> - compliance deadline approaching.
                                </p>
                                <div class="suggestion-meta">
                                    <span class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        Regulation effective in 18 days
                                    </span>
                                    <span class="text-muted ms-3">
                                        <i class="bi bi-building me-1"></i>
                                        75% of banks still preparing
                                    </span>
                                </div>
                            </div>
                            <div class="suggestion-actions">
                                <button class="btn btn-success btn-sm" onclick="acceptAISuggestion('realtime-reversal')">
                                    <i class="bi bi-check me-1"></i>Add
                                </button>
                                <button class="btn btn-outline-secondary btn-sm ms-1" onclick="modifyAISuggestion('realtime-reversal')">
                                    <i class="bi bi-pencil me-1"></i>Modify
                                </button>
                                <button class="btn btn-outline-danger btn-sm ms-1" onclick="rejectAISuggestion('realtime-reversal')">
                                    <i class="bi bi-x me-1"></i>Dismiss
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="ai-insights mt-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-lightbulb text-primary me-2"></i>
                            <strong>AI Insights</strong>
                        </div>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <div class="insight-metric">
                                    <div class="metric-value text-warning">+15%</div>
                                    <div class="metric-label">Wire fraud this quarter</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="insight-metric">
                                    <div class="metric-value text-info">$2.8M</div>
                                    <div class="metric-label">Avg peer loss per incident</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="insight-metric">
                                    <div class="metric-value text-success">96%</div>
                                    <div class="metric-label">Detection rate with controls</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selected Risks Summary -->
                <div class="summary-card">
                    <h5><i class="bi bi-check2-circle text-success me-2"></i>Selected Risks Summary</h5>
                    <p class="text-muted mb-2">You have selected <strong id="selected-count">2</strong> risks for assessment:</p>
                    <div id="selected-list">
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <span>Unauthorized Wire Transfer</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeRisk('unauthorized-transfer')">Remove</button>
                        </div>
                        <div class="d-flex justify-content-between align-items-center py-2">
                            <span>Wire Transfer System Failure</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeRisk('system-failure')">Remove</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pane 2: Inherent Risk Assessment -->
            <div class="wizard-pane" id="pane-2">
                <div class="pane-header">
                    <h2 class="pane-title">Inherent Risk Assessment</h2>
                    <p class="pane-subtitle">Assess likelihood and impact of each risk before considering controls. AI provides intelligent scoring suggestions.</p>
                </div>

                <!-- Risk Assessment Cards -->
                <div id="risk-assessment-container">
                    <!-- Unauthorized Transfer Risk -->
                    <div class="risk-assessment-card" data-risk="unauthorized-transfer">
                        <div class="risk-assessment-header">
                            <h4><i class="bi bi-shield-exclamation text-danger me-2"></i>Unauthorized Wire Transfer</h4>
                            <span class="risk-category">Operational Risk</span>
                        </div>
                        
                        <div class="row">
                            <!-- Historical Context -->
                            <div class="col-md-3">
                                <div class="context-panel">
                                    <h6><i class="bi bi-clock-history me-2"></i>Historical Context</h6>
                                    <div class="history-item">
                                        <strong>Last 6 Assessments:</strong>
                                        <div class="history-scores">
                                            <span class="score-pill">L:3 I:5</span>
                                            <span class="score-pill">L:3 I:5</span>
                                            <span class="score-pill">L:4 I:5</span>
                                            <span class="score-pill">L:4 I:5</span>
                                            <span class="score-pill">L:4 I:5</span>
                                            <span class="score-pill current">L:? I:?</span>
                                        </div>
                                    </div>
                                    <div class="trend-indicator">
                                        <span class="trend-stable">
                                            <i class="bi bi-arrow-right me-1"></i>Trend: Stable
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Analysis -->
                            <div class="col-md-3">
                                <div class="ai-analysis-panel">
                                    <h6><i class="bi bi-robot me-2"></i>AI Analysis</h6>
                                    <div class="ai-suggestion-score">
                                        <div class="suggested-score">
                                            <strong>Suggested: L4 × I5</strong>
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" style="width: 87%"></div>
                                            </div>
                                            <small class="text-muted">87% confidence</small>
                                        </div>
                                    </div>
                                    <div class="ai-reasoning">
                                        <p class="mb-2">"Wire fraud incidents up 35% this year. Your KRIs show elevated exception rates."</p>
                                        <button class="btn btn-outline-primary btn-sm" onclick="showAIReasoning('unauthorized-transfer')">
                                            <i class="bi bi-question-circle me-1"></i>Why?
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Risk Scoring Grid -->
                            <div class="col-md-6">
                                <div class="scoring-panel">
                                    <h6><i class="bi bi-grid-3x3 me-2"></i>Select Likelihood & Impact</h6>
                                    <div class="risk-matrix" data-risk="unauthorized-transfer">
                                        <div class="matrix-labels">
                                            <div class="impact-label">Impact →</div>
                                            <div class="likelihood-label">↓ Likelihood</div>
                                        </div>
                                        <table class="risk-grid">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>1</th>
                                                    <th>2</th>
                                                    <th>3</th>
                                                    <th>4</th>
                                                    <th>5</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th>5</th>
                                                    <td class="cell-high" data-l="5" data-i="1">5</td>
                                                    <td class="cell-high" data-l="5" data-i="2">10</td>
                                                    <td class="cell-critical" data-l="5" data-i="3">15</td>
                                                    <td class="cell-critical" data-l="5" data-i="4">20</td>
                                                    <td class="cell-critical" data-l="5" data-i="5">25</td>
                                                </tr>
                                                <tr>
                                                    <th>4</th>
                                                    <td class="cell-medium" data-l="4" data-i="1">4</td>
                                                    <td class="cell-high" data-l="4" data-i="2">8</td>
                                                    <td class="cell-high" data-l="4" data-i="3">12</td>
                                                    <td class="cell-critical ai-suggested" data-l="4" data-i="4">16</td>
                                                    <td class="cell-critical" data-l="4" data-i="5">20</td>
                                                </tr>
                                                <tr>
                                                    <th>3</th>
                                                    <td class="cell-low" data-l="3" data-i="1">3</td>
                                                    <td class="cell-medium" data-l="3" data-i="2">6</td>
                                                    <td class="cell-medium" data-l="3" data-i="3">9</td>
                                                    <td class="cell-high" data-l="3" data-i="4">12</td>
                                                    <td class="cell-critical" data-l="3" data-i="5">15</td>
                                                </tr>
                                                <tr>
                                                    <th>2</th>
                                                    <td class="cell-low" data-l="2" data-i="1">2</td>
                                                    <td class="cell-low" data-l="2" data-i="2">4</td>
                                                    <td class="cell-medium" data-l="2" data-i="3">6</td>
                                                    <td class="cell-medium" data-l="2" data-i="4">8</td>
                                                    <td class="cell-high" data-l="2" data-i="5">10</td>
                                                </tr>
                                                <tr>
                                                    <th>1</th>
                                                    <td class="cell-low" data-l="1" data-i="1">1</td>
                                                    <td class="cell-low" data-l="1" data-i="2">2</td>
                                                    <td class="cell-low" data-l="1" data-i="3">3</td>
                                                    <td class="cell-medium" data-l="1" data-i="4">4</td>
                                                    <td class="cell-medium" data-l="1" data-i="5">5</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="selected-score mt-2" id="score-unauthorized-transfer">
                                        <strong>Selected Score: </strong><span class="current-score">Not selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KRI Correlation -->
                        <div class="kri-correlation mt-3">
                            <h6><i class="bi bi-graph-up me-2"></i>Key Risk Indicator Correlation</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="kri-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Wire Exception Rate:</span>
                                            <span class="kri-value text-warning">0.8% <i class="bi bi-arrow-up"></i></span>
                                        </div>
                                        <small class="text-muted">↑ from 0.5% last period</small>
                                        <div class="kri-trend">
                                            <div class="mini-chart">📈 6-month trend: ↗️</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="kri-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Fraud Attempts:</span>
                                            <span class="kri-value text-danger">12 <i class="bi bi-arrow-up"></i></span>
                                        </div>
                                        <small class="text-muted">↑ from 8 last month</small>
                                        <div class="kri-trend">
                                            <div class="mini-chart">📊 Monthly trend: ↗️</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments -->
                        <div class="risk-comments mt-3">
                            <label for="comments-unauthorized-transfer" class="form-label">
                                <i class="bi bi-chat-text me-2"></i>Additional Comments (Optional)
                            </label>
                            <textarea class="form-control" id="comments-unauthorized-transfer" rows="2" 
                                placeholder="Any additional context for this risk assessment..."></textarea>
                        </div>
                    </div>

                    <!-- System Failure Risk -->
                    <div class="risk-assessment-card mt-4" data-risk="system-failure">
                        <div class="risk-assessment-header">
                            <h4><i class="bi bi-exclamation-triangle text-warning me-2"></i>Wire Transfer System Failure</h4>
                            <span class="risk-category">Technology Risk</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3">
                                <div class="context-panel">
                                    <h6><i class="bi bi-clock-history me-2"></i>Historical Context</h6>
                                    <div class="history-item">
                                        <strong>Last 6 Assessments:</strong>
                                        <div class="history-scores">
                                            <span class="score-pill">L:2 I:4</span>
                                            <span class="score-pill">L:3 I:4</span>
                                            <span class="score-pill">L:3 I:4</span>
                                            <span class="score-pill">L:3 I:4</span>
                                            <span class="score-pill">L:3 I:4</span>
                                            <span class="score-pill current">L:? I:?</span>
                                        </div>
                                    </div>
                                    <div class="trend-indicator">
                                        <span class="trend-stable">
                                            <i class="bi bi-arrow-right me-1"></i>Trend: Stable
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3">
                                <div class="ai-analysis-panel">
                                    <h6><i class="bi bi-robot me-2"></i>AI Analysis</h6>
                                    <div class="ai-suggestion-score">
                                        <div class="suggested-score">
                                            <strong>Suggested: L3 × I4</strong>
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" style="width: 79%"></div>
                                            </div>
                                            <small class="text-muted">79% confidence</small>
                                        </div>
                                    </div>
                                    <div class="ai-reasoning">
                                        <p class="mb-2">"System availability improved but complexity increased with new integrations."</p>
                                        <button class="btn btn-outline-primary btn-sm" onclick="showAIReasoning('system-failure')">
                                            <i class="bi bi-question-circle me-1"></i>Why?
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="scoring-panel">
                                    <h6><i class="bi bi-grid-3x3 me-2"></i>Select Likelihood & Impact</h6>
                                    <div class="risk-matrix" data-risk="system-failure">
                                        <div class="matrix-labels">
                                            <div class="impact-label">Impact →</div>
                                            <div class="likelihood-label">↓ Likelihood</div>
                                        </div>
                                        <table class="risk-grid">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>1</th>
                                                    <th>2</th>
                                                    <th>3</th>
                                                    <th>4</th>
                                                    <th>5</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <th>5</th>
                                                    <td class="cell-high" data-l="5" data-i="1">5</td>
                                                    <td class="cell-high" data-l="5" data-i="2">10</td>
                                                    <td class="cell-critical" data-l="5" data-i="3">15</td>
                                                    <td class="cell-critical" data-l="5" data-i="4">20</td>
                                                    <td class="cell-critical" data-l="5" data-i="5">25</td>
                                                </tr>
                                                <tr>
                                                    <th>4</th>
                                                    <td class="cell-medium" data-l="4" data-i="1">4</td>
                                                    <td class="cell-high" data-l="4" data-i="2">8</td>
                                                    <td class="cell-high" data-l="4" data-i="3">12</td>
                                                    <td class="cell-critical" data-l="4" data-i="4">16</td>
                                                    <td class="cell-critical" data-l="4" data-i="5">20</td>
                                                </tr>
                                                <tr>
                                                    <th>3</th>
                                                    <td class="cell-low" data-l="3" data-i="1">3</td>
                                                    <td class="cell-medium" data-l="3" data-i="2">6</td>
                                                    <td class="cell-medium" data-l="3" data-i="3">9</td>
                                                    <td class="cell-high ai-suggested" data-l="3" data-i="4">12</td>
                                                    <td class="cell-critical" data-l="3" data-i="5">15</td>
                                                </tr>
                                                <tr>
                                                    <th>2</th>
                                                    <td class="cell-low" data-l="2" data-i="1">2</td>
                                                    <td class="cell-low" data-l="2" data-i="2">4</td>
                                                    <td class="cell-medium" data-l="2" data-i="3">6</td>
                                                    <td class="cell-medium" data-l="2" data-i="4">8</td>
                                                    <td class="cell-high" data-l="2" data-i="5">10</td>
                                                </tr>
                                                <tr>
                                                    <th>1</th>
                                                    <td class="cell-low" data-l="1" data-i="1">1</td>
                                                    <td class="cell-low" data-l="1" data-i="2">2</td>
                                                    <td class="cell-low" data-l="1" data-i="3">3</td>
                                                    <td class="cell-medium" data-l="1" data-i="4">4</td>
                                                    <td class="cell-medium" data-l="1" data-i="5">5</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="selected-score mt-2" id="score-system-failure">
                                        <strong>Selected Score: </strong><span class="current-score">Not selected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="kri-correlation mt-3">
                            <h6><i class="bi bi-graph-up me-2"></i>Key Risk Indicator Correlation</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="kri-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>System Uptime:</span>
                                            <span class="kri-value text-success">99.7% <i class="bi bi-arrow-up"></i></span>
                                        </div>
                                        <small class="text-muted">↑ from 99.2% last quarter</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="kri-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>Critical Incidents:</span>
                                            <span class="kri-value text-success">1 <i class="bi bi-arrow-down"></i></span>
                                        </div>
                                        <small class="text-muted">↓ from 3 last quarter</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="risk-comments mt-3">
                            <label for="comments-system-failure" class="form-label">
                                <i class="bi bi-chat-text me-2"></i>Additional Comments (Optional)
                            </label>
                            <textarea class="form-control" id="comments-system-failure" rows="2" 
                                placeholder="Any additional context for this risk assessment..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pane 3: Enhanced AI-Powered Control Mapping -->
            <div class="wizard-pane" id="pane-3">
                <div class="pane-header">
                    <h2 class="pane-title">
                        <i class="bi bi-robot text-primary me-2"></i>
                        AI-Powered Control Mapping
                    </h2>
                    <p class="pane-subtitle">
                        Link existing controls to mitigate risks with 95% AI matching accuracy. 
                        Achieve 100% coverage allocation for complete risk mitigation.
                    </p>
                </div>

                <!-- Control Mapping Progress Dashboard -->
                <div class="control-progress-dashboard mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="progress-metric-card">
                                <div class="metric-icon">
                                    <i class="bi bi-speedometer2 text-primary"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="overall-coverage">0%</div>
                                    <div class="metric-label">Overall Coverage</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="progress-metric-card">
                                <div class="metric-icon">
                                    <i class="bi bi-check-circle text-success"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="risks-completed">0</div>
                                    <div class="metric-label">Risks Completed</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="progress-metric-card">
                                <div class="metric-icon">
                                    <i class="bi bi-link-45deg text-info"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="total-controls">0</div>
                                    <div class="metric-label">Controls Linked</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="progress-metric-card">
                                <div class="metric-icon">
                                    <i class="bi bi-shield-check text-warning"></i>
                                </div>
                                <div class="metric-content">
                                    <div class="metric-value" id="control-balance">-</div>
                                    <div class="metric-label">P/D Balance</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Panel -->
                <div class="ai-assistant-panel mb-4">
                    <div class="ai-assistant-header">
                        <div class="d-flex align-items-center gap-2">
                            <div class="ai-avatar">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">RCSA AI Assistant</h6>
                                <small class="text-muted">Intelligent control recommendations</small>
                            </div>
                        </div>
                        <div class="ai-confidence-badge">
                            <span class="confidence-score">95%</span>
                            <small>Match Accuracy</small>
                        </div>
                    </div>
                    <div class="ai-insights" id="ai-insights">
                        <div class="ai-insight-item">
                            <i class="bi bi-lightbulb text-warning"></i>
                            <span>Ready to suggest controls for your selected risks. Click "Generate AI Suggestions" to begin.</span>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Control Mapping for Selected Risks -->
                <div id="enhanced-control-mapping-container">
                    <!-- This will be populated dynamically for each selected risk -->
                </div>

                <!-- Global Control Actions -->
                <div class="global-actions mt-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <button class="btn btn-primary btn-lg w-100" onclick="generateAllAISuggestions()">
                                <i class="bi bi-robot me-2"></i>
                                Generate AI Suggestions for All Risks
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-lg w-100" onclick="optimizeControlAllocation()">
                                <i class="bi bi-gear me-2"></i>
                                Optimize Coverage Allocation
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pane 4: Control Effectiveness Assessment -->
            <div class="wizard-pane" id="pane-4">
                <div class="pane-header">
                    <h2 class="pane-title">
                        <i class="bi bi-bar-chart-line text-primary me-2"></i>
                        Control Effectiveness Assessment
                    </h2>
                    <p class="pane-subtitle">
                        Evaluate how well each control mitigates its specific risk. Each control gets its own effectiveness rating based on the risk context: 
                        <strong>"Is this control adequate to keep this risk within appetite?"</strong>
                    </p>
                </div>

                <!-- Loading State -->
                <div id="effectiveness-loading" class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-primary mb-2">
                        <i class="bi bi-magic me-2"></i>Building risk-centric assessment interface...
                    </h5>
                    <p class="text-muted mb-0">Analyzing control mappings for effectiveness evaluation</p>
                </div>

                <!-- Main Assessment Content -->
                <div id="effectiveness-content" style="display: none;">
                    
                    <!-- CEI Dashboard Summary -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="cei-dashboard">
                                <div class="cei-header">
                                    <h3 class="cei-title">
                                        <i class="bi bi-speedometer2 me-2"></i>
                                        Control Effectiveness Index (CEI)
                                    </h3>
                                    <div class="cei-score">
                                        <span class="cei-percentage" id="overall-cei">--</span>
                                        <span class="cei-rating" id="cei-rating">Calculating...</span>
                                    </div>
                                </div>

                                <div class="cei-progress-container">
                                    <div class="cei-progress-bar">
                                        <div class="cei-progress-fill" id="cei-progress" style="width: 0%"></div>
                                    </div>
                                    <div class="cei-calculation" id="cei-calculation">
                                        Complete risk-control assessments to calculate overall CEI
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="breakdown-metric">
                                            <div class="metric-value" id="design-avg">--</div>
                                            <div class="metric-label">Avg Design</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="breakdown-metric">
                                            <div class="metric-value" id="operational-avg">--</div>
                                            <div class="metric-label">Avg Operational</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="breakdown-metric">
                                            <div class="metric-value" id="assessed-count">0</div>
                                            <div class="metric-label">Assessed Pairings</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="breakdown-metric">
                                            <div class="metric-value" id="coverage-pct">0%</div>
                                            <div class="metric-label">Progress</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="effectiveness-insights-panel">
                                <h4 class="insights-title">
                                    <i class="bi bi-lightbulb text-warning me-2"></i>
                                    AI Effectiveness Insights
                                </h4>
                                <div class="insights-content" id="ai-insights-content">
                                    <div class="insight-item">
                                        <i class="bi bi-info-circle text-info"></i>
                                        <span>Complete assessments to receive AI insights and recommendations</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Risk-Control Assessment Groups -->
                    <div id="control-effectiveness-assessments">
                        <!-- Dynamically populated with risk-control assessment cards -->
                    </div>

                    <!-- Empty State -->
                    <div id="no-mappings-state" class="text-center py-5" style="display: none;">
                        <div class="empty-state py-5">
                            <span class="display-1 text-muted">🔗</span>
                            <h3 class="mt-3 mb-3">No Control Mappings Found</h3>
                            <p class="text-muted mb-4">
                                Please go back to Step 3 to map controls to your risks before assessing effectiveness.
                            </p>
                            <button class="btn btn-primary" onclick="goToStep(3)">
                                <i class="bi bi-arrow-left me-2"></i>Back to Control Mapping
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-pane" id="pane-5">
                <div class="pane-header">
                    <h2 class="pane-title">Residual Risk Assessment</h2>
                    <p class="pane-subtitle">AI-calculated risk levels after considering control effectiveness. Review and adjust as needed.</p>
                </div>

                <!-- Assessment Progress Header -->
                <div class="residual-assessment-progress mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="progress-info">
                                <h5 class="mb-1">
                                    <i class="bi bi-calculator text-primary me-2"></i>
                                    Residual Risk Calculations
                                </h5>
                                <p class="text-muted mb-0">
                                    AI has calculated residual risks based on your control effectiveness assessments. 
                                    Review each calculation and override if needed.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="assessment-stats">
                                <span class="badge bg-primary fs-6 px-3 py-2">
                                    <span id="residual-completed-count">0</span> of <span id="residual-total-count">0</span> Assessed
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Calculation Transparency Card -->
                <div class="card border-primary mb-4" id="ai-calculation-card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-robot me-2"></i>
                            AI Residual Risk Calculation Logic
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-semibold">Calculation Method</h6>
                                <div class="calculation-formula mb-3">
                                    <code class="bg-light p-2 rounded d-block">
                                        Residual = Inherent × (1 - (CEI × Mitigation_Factor))
                                    </code>
                                </div>
                                <ul class="small mb-0">
                                    <li><strong>CEI 90-100%:</strong> Reduce by 70% (Excellent controls)</li>
                                    <li><strong>CEI 80-89%:</strong> Reduce by 60% (Strong controls)</li>
                                    <li><strong>CEI 70-79%:</strong> Reduce by 45% (Good controls)</li>
                                    <li><strong>CEI 60-69%:</strong> Reduce by 30% (Fair controls)</li>
                                    <li><strong>CEI <60%:</strong> Reduce by 15% (Poor controls)</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-semibold">Quality Factors</h6>
                                <ul class="small mb-0">
                                    <li><strong>Preventive Controls:</strong> Higher mitigation weight</li>
                                    <li><strong>Automated Controls:</strong> +10% reliability bonus</li>
                                    <li><strong>Multiple Controls:</strong> Diversification bonus</li>
                                    <li><strong>Coverage Gaps:</strong> Proportional reduction</li>
                                </ul>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="showDetailedCalculationModal()">
                                        <i class="bi bi-calculator me-1"></i>View Detailed Calculations
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Residual Risk Assessment Container -->
                <div id="residual-risk-container">
                    <!-- Dynamic content will be loaded here -->
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading residual risk assessments...</p>
                    </div>
                </div>

                <!-- Assessment Summary & Validation -->
                <div class="card border-0 shadow-sm mt-4" id="residual-summary-card" style="display: none;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">
                                    <i class="bi bi-clipboard-data me-2"></i>
                                    Overall Residual Risk Profile
                                </h6>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="metric-value text-success" id="low-risk-count">0</div>
                                            <div class="metric-label">Low Risks (1-5)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="metric-value text-warning" id="medium-risk-count">0</div>
                                            <div class="metric-label">Medium Risks (6-15)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="metric-value text-danger" id="high-risk-count">0</div>
                                            <div class="metric-label">High Risks (16-25)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <div class="metric-value text-primary" id="avg-reduction">0%</div>
                                            <div class="metric-label">Avg Risk Reduction</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="alert alert-success mb-0" id="appetite-status">
                                    <i class="bi bi-shield-check me-2"></i>
                                    <strong>Within Risk Appetite</strong><br>
                                    <small>All risks below threshold (≤15)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="wizard-pane" id="pane-6">
                <div class="pane-header">
                    <h2 class="pane-title">Risk Response Planning</h2>
                    <p class="pane-subtitle">Select the most appropriate response strategy for each residual risk.</p>
                </div>

                <!-- AI-Powered Response Overview -->
                <div class="ai-response-overview">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="overview-content">
                                <h5><i class="bi bi-robot text-primary me-2"></i>AI Response Recommendations</h5>
                                <p class="text-muted mb-0">Our AI has analyzed your residual risks and industry benchmarks to suggest optimal response strategies with cost-benefit analysis.</p>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="response-stats">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <div class="stat-value text-success" id="accept-count">0</div>
                                            <div class="stat-label">Accept</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="stat-item">
                                            <div class="stat-value text-warning" id="enhance-count">0</div>
                                            <div class="stat-label">Enhance</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Response Cards Container -->
                <div id="risk-response-container">
                    <!-- Dynamic content will be loaded here by JavaScript -->
                </div>

                <!-- Response Strategy Summary -->
                <div class="response-summary-panel" id="response-summary">
                    <div class="summary-header">
                        <h5><i class="bi bi-clipboard-check text-primary me-2"></i>Response Strategy Summary</h5>
                        <p class="text-muted mb-0">Overview of your selected response strategies and estimated implementation timeline.</p>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="strategy-distribution">
                                <h6 class="mb-3">Strategy Distribution</h6>
                                <div class="strategy-bar-chart" id="strategy-chart">
                                    <!-- Chart will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="implementation-timeline">
                                <h6 class="mb-3">Implementation Timeline</h6>
                                <div class="timeline-summary" id="timeline-summary">
                                    <div class="timeline-item">
                                        <div class="timeline-label">Immediate Actions</div>
                                        <div class="timeline-value" id="immediate-actions">0</div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-label">30-Day Actions</div>
                                        <div class="timeline-value" id="short-term-actions">0</div>
                                    </div>
                                    <div class="timeline-item">
                                        <div class="timeline-label">90-Day Actions</div>
                                        <div class="timeline-value" id="long-term-actions">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Appetite Validation Alert -->
                <div class="alert alert-warning" id="appetite-violation-alert" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-3"></i>
                        <div>
                            <strong>Risk Appetite Threshold Exceeded</strong><br>
                            <small>Some residual risks remain above your risk appetite threshold (≤15). Consider additional controls or enhanced response strategies.</small>
                        </div>
                    </div>
                </div>

                <!-- Global Response Actions -->
                <div class="global-response-actions">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary btn-lg w-100" onclick="generateActionPlan()">
                                <i class="bi bi-list-task me-2"></i>
                                Generate Action Plan
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-success btn-lg w-100" onclick="exportResponseSummary()">
                                <i class="bi bi-download me-2"></i>
                                Export Summary
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pane 7: Review & Submit -->
            <div class="wizard-pane" id="pane-7">
                <div class="pane-header">
                    <h2 class="pane-title">Review & Submit Assessment</h2>
                    <p class="pane-subtitle">Final review of your Wire Transfer risk assessment before submission.</p>
                </div>

                <!-- Assessment Summary -->
                <div class="summary-card">
                    <h5><i class="bi bi-clipboard-check text-primary me-2"></i>Assessment Summary</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Process:</strong> Wire Transfer</p>
                            <p><strong>Business Unit:</strong> Retail Banking</p>
                            <p><strong>Assessment Period:</strong> December 2024</p>
                            <p><strong>Assessor:</strong> Sarah Chen</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Risks Assessed:</strong> 2</p>
                            <p><strong>Controls Mapped:</strong> 5</p>
                            <p><strong>Issues Created:</strong> 0</p>
                            <p><strong>Overall Risk Level:</strong> <span class="text-warning">Medium</span></p>
                        </div>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="summary-grid">
                    <div class="metric-item">
                        <div class="metric-value">8.2</div>
                        <div class="metric-label">Minutes Spent</div>
                        <small class="text-success">↓ 92% vs Excel</small>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">2</div>
                        <div class="metric-label">Risks Identified</div>
                        <small class="text-success">✓ Comprehensive</small>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">15</div>
                        <div class="metric-label">AI Suggestions</div>
                        <small class="text-primary">Accepted</small>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value">$1.2M</div>
                        <div class="metric-label">Risk Exposure</div>
                        <small class="text-success">Mitigated</small>
                    </div>
                </div>

                <!-- Completeness Check -->
                <div class="summary-card">
                    <h5><i class="bi bi-check-circle text-success me-2"></i>Completeness Check</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All risks have inherent scores
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All risks have controls mapped
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All controls evaluated
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All residual risks calculated
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                All responses documented
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                Quality score: 92%
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attestation -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="attestation" required>
                    <label class="form-check-label" for="attestation">
                        I attest that this assessment is complete and accurate to the best of my knowledge, 
                        and represents a thorough evaluation of risks and controls for the Wire Transfer process.
                    </label>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="wizard-navigation">
            <div>
                <button class="nav-btn secondary" id="prev-btn" onclick="previousStep()" disabled>
                    <i class="bi bi-arrow-left"></i>
                    Previous
                </button>
            </div>
            
            <div>
                <a href="#" class="save-draft" onclick="saveDraft()">
                    <i class="bi bi-cloud-arrow-up me-1"></i>
                    Save Draft
                </a>
            </div>
            
            <div>
                <button class="nav-btn primary" id="next-btn" onclick="nextStep()">
                    <span id="next-text">Continue to Inherent Risk</span>
                    <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Wizard JavaScript -->
    <script>
        // Wizard State Management
        let currentStep = 1;
        const totalSteps = 7;
        let assessmentData = {
            processName: 'Wire Transfer',
            businessUnit: 'Retail Banking',
            selectedRisks: ['unauthorized-transfer', 'system-failure'],
            startTime: new Date(),
            lastSaved: new Date()
        };

        // Initialize wizard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            initializeWizard();
            
            // Wait a bit for any additional DOM manipulation before updating progress
            setTimeout(() => {
                console.log('Delayed update progress call');
                updateProgress();
                initializeBreadcrumbNavigation(); // Add breadcrumb click handlers
            }, 100);
            
            autoSave();
            showWelcomeMessage();
        });

        function initializeWizard() {
            // Get process from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const process = urlParams.get('process') || 'wire-transfer';
            
            // Load assessment data from session storage
            const savedData = sessionStorage.getItem('rcsa-assessment');
            if (savedData) {
                assessmentData = {...assessmentData, ...JSON.parse(savedData)};
            }
            
            // Update UI with process info
            updateProcessInfo(process);
            updateSelectedRisks();
        }

        function updateProcessInfo(process) {
            const processNames = {
                'wire-transfer': 'Wire Transfer Assessment',
                'loan-origination': 'Loan Origination Assessment',
                'atm-reconciliation': 'ATM Reconciliation Assessment'
            };
            
            const processName = processNames[process] || 'Wire Transfer Assessment';
            document.getElementById('process-name').textContent = processName;
            assessmentData.processName = processName;
        }

        function updateProgress() {
            console.log('UpdateProgress called for step:', currentStep);
            console.log('DOM ready state:', document.readyState);
            
            // Check if we're being called too early
            if (document.readyState === 'loading') {
                console.warn('UpdateProgress called before DOM ready, waiting...');
                setTimeout(updateProgress, 50);
                return;
            }
            
            // Update progress title and current step with defensive programming
            const stepNames = [
                'Risk Review', 'Inherent Risk Assessment', 'Control Mapping', 'Control Effectiveness', 
                'Residual Risk Assessment', 'Risk Response Planning', 'Review & Submit Assessment'
            ];
            
            const progressTitle = document.getElementById('progress-title');
            const currentStepName = document.getElementById('current-step-name');
            
            console.log('Progress title element:', progressTitle);
            console.log('Current step name element:', currentStepName);
            
            if (progressTitle) {
                try {
                    progressTitle.textContent = `Assessment Progress - Step ${currentStep} of ${totalSteps}`;
                    console.log('Updated progress title');
                } catch (e) {
                    console.error('Error updating progress title:', e);
                }
            } else {
                console.error('progress-title element not found!');
                // Try alternative selectors
                const altProgressTitle = document.querySelector('.progress-title');
                if (altProgressTitle) {
                    console.log('Found alternative progress title element');
                    altProgressTitle.textContent = `Assessment Progress - Step ${currentStep} of ${totalSteps}`;
                }
            }
            
            if (currentStepName) {
                try {
                    currentStepName.textContent = stepNames[currentStep - 1];
                    console.log('Updated current step name to:', stepNames[currentStep - 1]);
                } catch (e) {
                    console.error('Error updating current step name:', e);
                }
            } else {
                console.error('current-step-name element not found!');
                // Try alternative selectors
                const altStepName = document.querySelector('.current-step-name');
                if (altStepName) {
                    console.log('Found alternative step name element');
                    altStepName.textContent = stepNames[currentStep - 1];
                }
            }

            // Update step indicators
            document.querySelectorAll('.step').forEach((step, index) => {
                const stepNum = index + 1;
                const circle = step.querySelector('.step-circle');
                const label = step.querySelector('.step-label');
                const connector = step.querySelector('.step-connector');

                // Reset classes
                circle.className = 'step-circle';
                label.className = 'step-label';
                if (connector) connector.className = 'step-connector';

                if (stepNum < currentStep) {
                    circle.classList.add('completed');
                    label.classList.add('completed');
                    if (connector) connector.classList.add('completed');
                    circle.innerHTML = '<i class="bi bi-check"></i>';
                } else if (stepNum === currentStep) {
                    circle.classList.add('current');
                    label.classList.add('current');
                    circle.textContent = stepNum;
                } else {
                    circle.classList.add('future');
                    label.classList.add('future');
                    circle.textContent = stepNum;
                }
            });

            // Update navigation buttons
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const nextText = document.getElementById('next-text');

            prevBtn.disabled = currentStep === 1;
            
            if (currentStep === totalSteps) {
                nextText.textContent = 'Submit Assessment';
                nextBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Submit Assessment';
            } else {
                const nextStepNames = {
                    1: 'Continue to Inherent Risk Assessment',
                    2: 'Continue to Control Mapping',
                    3: 'Continue to Control Effectiveness', 
                    4: 'Continue to Residual Risk Assessment',
                    5: 'Continue to Risk Response Planning',
                    6: 'Review & Submit Assessment',
                    7: 'Submit Assessment'
                };
                nextText.textContent = nextStepNames[currentStep] || 'Continue';
                nextBtn.innerHTML = `${nextStepNames[currentStep]} <i class="bi bi-arrow-right"></i>`;
            }

            // Show current pane
            console.log('Switching to pane:', currentStep);
            document.querySelectorAll('.wizard-pane').forEach(pane => {
                pane.classList.remove('active');
                console.log('Removed active from:', pane.id);
            });
            
            const targetPane = document.getElementById(`pane-${currentStep}`);
            console.log('Target pane:', targetPane);
            if (targetPane) {
                targetPane.classList.add('active');
                console.log('Activated pane:', targetPane.id);
            } else {
                console.error(`Pane pane-${currentStep} not found!`);
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep === totalSteps) {
                    submitAssessment();
                } else {
                    currentStep++;
                    
                    // Try to update progress, but don't let it break the flow
                    try {
                        updateProgress();
                    } catch (error) {
                        console.warn('Breadcrumb update failed, using fallback navigation');
                        updateProgressFallback();
                    }
                    
                    saveProgress();
                    showStepTransition();
                    
                    // Dynamic risk assessment generation for Pane 2
                    if (currentStep === 2) {
                        generateRiskAssessmentCards();
                    }
                    
                    // Dynamic enhanced control mapping generation for Pane 3
                    if (currentStep === 3) {
                        generateEnhancedControlMappingCards();
                    }
                    
                    // Dynamic control effectiveness assessment for Pane 4
                    if (currentStep === 4) {
                        initializeControlEffectivenessPane();
                    }
                }
            }
        }
        
        function updateProgressFallback() {
            // Just do the essential pane switching
            document.querySelectorAll('.wizard-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            const targetPane = document.getElementById(`pane-${currentStep}`);
            if (targetPane) {
                targetPane.classList.add('active');
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                
                // Try to update progress, but don't let it break the flow
                try {
                    updateProgress();
                } catch (error) {
                    console.warn('Breadcrumb update failed, using fallback navigation');
                    updateProgressFallback();
                }
                
                saveProgress();
                showStepTransition();
                
                // Dynamic content generation for each step (same as nextStep)
                if (currentStep === 2) {
                    generateRiskAssessmentCards();
                }
                
                // Dynamic enhanced control mapping generation for Pane 3
                if (currentStep === 3) {
                    generateEnhancedControlMappingCards();
                }
                
                // Dynamic control effectiveness assessment for Pane 4
                if (currentStep === 4) {
                    initializeControlEffectivenessPane();
                }
            }
        }

        function goToStep(stepNumber) {
            console.log(`Navigating directly to step ${stepNumber}`);
            
            if (stepNumber < 1 || stepNumber > totalSteps) {
                console.error('Invalid step number:', stepNumber);
                return;
            }
            
            currentStep = stepNumber;
            
            // Try to update progress, but don't let it break the flow
            try {
                updateProgress();
            } catch (error) {
                console.warn('Breadcrumb update failed, using fallback navigation');
                updateProgressFallback();
            }
            
            saveProgress();
            showStepTransition();
            
            // Dynamic content generation for each step
            if (currentStep === 2) {
                generateRiskAssessmentCards();
            } else if (currentStep === 3) {
                generateEnhancedControlMappingCards();
            } else if (currentStep === 4) {
                initializeControlEffectivenessPane();
            }
            
            showToast(`Navigated to Step ${stepNumber}`, 'info');
        }

        // Make breadcrumb steps clickable
        function initializeBreadcrumbNavigation() {
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('click', function() {
                    const stepNumber = parseInt(this.getAttribute('data-step'));
                    const stepCircle = this.querySelector('.step-circle');
                    
                    // Only allow navigation to current and completed steps
                    if (stepCircle.classList.contains('current') || stepCircle.classList.contains('completed')) {
                        if (stepNumber !== currentStep) {
                            goToStep(stepNumber);
                        }
                    }
                });
                
                // Add hover effects for clickable steps
                step.addEventListener('mouseenter', function() {
                    const stepCircle = this.querySelector('.step-circle');
                    if (stepCircle.classList.contains('current') || stepCircle.classList.contains('completed')) {
                        this.style.cursor = 'pointer';
                        this.style.opacity = '0.8';
                    }
                });
                
                step.addEventListener('mouseleave', function() {
                    this.style.cursor = 'default';
                    this.style.opacity = '1';
                });
            });
        }

        function validateCurrentStep() {
            switch (currentStep) {
                case 1:
                    if (assessmentData.selectedRisks.length === 0) {
                        showToast('Please select at least one risk to continue.', 'warning');
                        return false;
                    }
                    return true;
                case 2:
                    // Validate that all selected risks have scores (only when leaving Pane 2)
                    if (!assessmentData.riskScores) {
                        showToast('Please assess the likelihood and impact for each risk.', 'warning');
                        return false;
                    }
                    
                    const missingScores = assessmentData.selectedRisks.filter(riskId => 
                        !assessmentData.riskScores[riskId]
                    );
                    
                    if (missingScores.length > 0) {
                        showToast(`Please complete risk scoring for all risks. Missing: ${missingScores.length} risk(s).`, 'warning');
                        return false;
                    }
                    return true;
                case 7:
                    const attestation = document.getElementById('attestation');
                    if (!attestation.checked) {
                        showToast('Please confirm the attestation to submit the assessment.', 'warning');
                        return false;
                    }
                    return true;
                default:
                    return true;
            }
        }

        function submitAssessment() {
            showToast('Assessment submitted successfully! Redirecting to dashboard...', 'success');
            
            // Simulate submission delay
            setTimeout(() => {
                // Clear session data
                sessionStorage.removeItem('rcsa-assessment');
                
                // Show celebration modal
                showCompletionCelebration();
                
                // Redirect after celebration
                setTimeout(() => {
                    window.location.href = '/scrDashboard_1LoD';
                }, 3000);
            }, 1000);
        }

        function showCompletionCelebration() {
            const timeTaken = Math.round((new Date() - assessmentData.startTime) / 60000);
            
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <div class="mb-3">
                                <i class="bi bi-check-circle" style="font-size: 4rem; color: var(--captech-success);"></i>
                            </div>
                            <h3 class="mb-3">Assessment Complete! 🎉</h3>
                            <p class="mb-3">You completed your Wire Transfer assessment in <strong>${timeTaken} minutes</strong></p>
                            <div class="alert alert-success">
                                <strong>Time Saved:</strong> ${120 - timeTaken} minutes vs traditional Excel process
                            </div>
                            <p class="text-muted">Redirecting to dashboard...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Risk Management Functions
        function toggleRisk(riskId) {
            const card = document.querySelector(`[data-risk="${riskId}"]`);
            const icon = card.querySelector('i');
            
            if (assessmentData.selectedRisks.includes(riskId)) {
                // Remove risk
                assessmentData.selectedRisks = assessmentData.selectedRisks.filter(id => id !== riskId);
                card.classList.remove('selected');
                icon.className = 'bi bi-square me-2';
            } else {
                // Add risk
                assessmentData.selectedRisks.push(riskId);
                card.classList.add('selected');
                icon.className = 'bi bi-check-circle text-success me-2';
            }
            
            updateSelectedRisks();
            saveProgress();
        }

        function removeRisk(riskId) {
            assessmentData.selectedRisks = assessmentData.selectedRisks.filter(id => id !== riskId);
            
            // Update card appearance
            const card = document.querySelector(`[data-risk="${riskId}"]`);
            if (card) {
                card.classList.remove('selected');
                const icon = card.querySelector('i');
                icon.className = 'bi bi-square me-2';
            }
            
            updateSelectedRisks();
            saveProgress();
        }

        function updateSelectedRisks() {
            const count = assessmentData.selectedRisks.length;
            document.getElementById('selected-count').textContent = count;
            
            const selectedList = document.getElementById('selected-list');
            selectedList.innerHTML = '';
            
            const riskNames = {
                'unauthorized-transfer': 'Unauthorized Wire Transfer',
                'system-failure': 'Wire Transfer System Failure',
                'compliance-violation': 'Regulatory Compliance Violation',
                'processing-error': 'Wire Processing Error'
            };
            
            assessmentData.selectedRisks.forEach(riskId => {
                const riskName = riskNames[riskId] || riskId;
                const item = document.createElement('div');
                item.className = 'd-flex justify-content-between align-items-center py-2 border-bottom';
                item.innerHTML = `
                    <span>${riskName}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeRisk('${riskId}')">Remove</button>
                `;
                selectedList.appendChild(item);
            });
            
            if (count === 0) {
                selectedList.innerHTML = '<p class="text-muted">No risks selected yet.</p>';
            }
        }

        // Session Management
        function saveProgress() {
            assessmentData.lastSaved = new Date();
            sessionStorage.setItem('rcsa-assessment', JSON.stringify(assessmentData));
            updateSaveTime();
        }

        function saveDraft() {
            saveProgress();
            showToast('Draft saved successfully!', 'success');
        }

        function autoSave() {
            setInterval(() => {
                saveProgress();
            }, 30000); // Auto-save every 30 seconds
        }

        function updateSaveTime() {
            const time = assessmentData.lastSaved.toLocaleTimeString();
            document.getElementById('last-saved').textContent = time;
        }

        // UI Helper Functions
        function showStepTransition() {
            const currentPane = document.querySelector('.wizard-pane.active');
            if (currentPane) {
                currentPane.style.transform = 'translateX(-20px)';
                currentPane.style.opacity = '0';
                
                setTimeout(() => {
                    currentPane.style.transform = 'translateX(0)';
                    currentPane.style.opacity = '1';
                }, 150);
            }
        }

        function showWelcomeMessage() {
            setTimeout(() => {
                showToast('Welcome to the RCSA Assessment Wizard! We\'ve pre-selected common risks for Wire Transfers.', 'info');
            }, 1000);
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toastId = 'toast-' + Date.now();
            
            const typeClasses = {
                'info': 'text-bg-primary',
                'success': 'text-bg-success',
                'warning': 'text-bg-warning',
                'error': 'text-bg-danger'
            };
            
            const toastHTML = `
                <div id="${toastId}" class="toast ${typeClasses[type] || typeClasses.info}" role="alert">
                    <div class="toast-header">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong class="me-auto">RCSA Copilot</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        // AI Suggestion Functions
        function acceptAISuggestion(riskId) {
            const suggestion = document.querySelector(`[data-risk="${riskId}"]`);
            suggestion.style.animation = 'fadeOut 0.3s ease';
            
            setTimeout(() => {
                // Add to selected risks
                if (!assessmentData.selectedRisks.includes(riskId)) {
                    assessmentData.selectedRisks.push(riskId);
                    updateSelectedRisks();
                    saveProgress();
                }
                
                // Add visual feedback
                const newRiskCard = createRiskCard(riskId);
                const riskLibrary = document.querySelector('.risk-library');
                riskLibrary.appendChild(newRiskCard);
                
                // Remove suggestion
                suggestion.remove();
                
                showToast(`Added "${getRiskName(riskId)}" to your assessment!`, 'success');
            }, 300);
        }
        
        function modifyAISuggestion(riskId) {
            showToast('Modification interface coming in Phase 3!', 'info');
        }
        
        function rejectAISuggestion(riskId) {
            const suggestion = document.querySelector(`[data-risk="${riskId}"]`);
            suggestion.style.animation = 'fadeOut 0.3s ease';
            
            setTimeout(() => {
                suggestion.remove();
                showToast('AI suggestion dismissed.', 'info');
            }, 300);
        }
        
        function getRiskName(riskId) {
            const riskNames = {
                'deepfake-voice': 'Deepfake Voice Authorization',
                'realtime-reversal': 'Real-time Payment Reversal Risk'
            };
            return riskNames[riskId] || riskId;
        }
        
        function createRiskCard(riskId) {
            const div = document.createElement('div');
            div.className = 'risk-card selected';
            div.dataset.risk = riskId;
            
            const riskData = {
                'deepfake-voice': {
                    title: 'Deepfake Voice Authorization',
                    description: 'AI-generated voice mimicking customers to authorize fraudulent wire transfers.',
                    category: 'Operational Risk'
                },
                'realtime-reversal': {
                    title: 'Real-time Payment Reversal Risk',
                    description: 'New FedNow reversal requirements may create operational risks.',
                    category: 'Compliance Risk'
                }
            };
            
            const risk = riskData[riskId];
            if (risk) {
                div.innerHTML = `
                    <div class="risk-title">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        ${risk.title}
                    </div>
                    <div class="risk-description">${risk.description}</div>
                    <div class="risk-meta">
                        <span class="risk-category">${risk.category}</span>
                        <span>Recently added via AI</span>
                    </div>
                `;
            }
            
            return div;
        }
        
        // Risk Scoring Functions
        function selectRiskScore(riskId, likelihood, impact) {
            // Find the modern heat map grid for this risk
            const matrix = document.querySelector(`[data-risk="${riskId}"].risk-matrix`);
            const scoreDisplay = document.getElementById(`score-${riskId}`);
            
            if (!matrix) {
                console.error('Risk matrix not found for:', riskId);
                return;
            }
            
            // Clear previous selections from all heat map cells in this matrix
            const cells = matrix.querySelectorAll('.heat-map-cell');
            cells.forEach(cell => cell.classList.remove('selected'));
            
            // Select new cell
            const selectedCell = matrix.querySelector(`[data-l="${likelihood}"][data-i="${impact}"]`);
            if (selectedCell) {
                selectedCell.classList.add('selected');
                
                // Update display
                const riskScore = likelihood * impact;
                const scoreSpan = scoreDisplay.querySelector('.current-score');
                scoreSpan.textContent = `L${likelihood} × I${impact} = ${riskScore}`;
                scoreSpan.className = `current-score ${getRiskLevel(riskScore)}`;
                
                // Save to assessment data
                if (!assessmentData.riskScores) assessmentData.riskScores = {};
                assessmentData.riskScores[riskId] = {
                    likelihood: likelihood,
                    impact: impact,
                    score: riskScore
                };
                
                saveProgress();
                showToast(`Risk score updated: L${likelihood} × I${impact} = ${riskScore}`, 'success');
            }
        }
        
        function getRiskLevel(score) {
            if (score <= 4) return 'text-success';
            if (score <= 9) return 'text-warning';
            if (score <= 16) return 'text-danger';
            return 'text-danger';
        }
        
        function showAIReasoning(riskId) {
            const reasoning = {
                'unauthorized-transfer': `
                    <strong>AI Analysis Factors:</strong>
                    <ul>
                        <li><strong>Industry Trends:</strong> 35% increase in wire fraud incidents this year</li>
                        <li><strong>Your KRIs:</strong> Wire exception rate increased from 0.5% to 0.8%</li>
                        <li><strong>Peer Data:</strong> Similar banks averaging L4×I5 for this risk</li>
                        <li><strong>Historical Pattern:</strong> Your scores trending upward (L3→L4)</li>
                        <li><strong>Recent Events:</strong> 12 fraud attempts vs 8 last month</li>
                    </ul>
                    <strong>Confidence:</strong> 87% based on 15 data points
                `,
                'system-failure': `
                    <strong>AI Analysis Factors:</strong>
                    <ul>
                        <li><strong>System Performance:</strong> Uptime improved to 99.7%</li>
                        <li><strong>Complexity Risk:</strong> New integrations increase failure potential</li>
                        <li><strong>Incident History:</strong> Critical incidents reduced (3→1)</li>
                        <li><strong>Industry Average:</strong> L3×I4 typical for wire systems</li>
                        <li><strong>Recovery Capability:</strong> Strong backup systems in place</li>
                    </ul>
                    <strong>Confidence:</strong> 79% based on 12 data points
                `
            };
            
            const modalHTML = `
                <div class="modal fade show" style="display: block;">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-robot me-2"></i>AI Risk Scoring Analysis
                                </h5>
                                <button type="button" class="btn-close" onclick="closeModal()"></button>
                            </div>
                            <div class="modal-body">
                                ${reasoning[riskId] || 'Analysis not available.'}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
                                <button type="button" class="btn btn-primary" onclick="acceptAIScore('${riskId}')">
                                    Accept AI Suggestion
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function acceptAIScore(riskId) {
            const aiScores = {
                'unauthorized-transfer': { likelihood: 4, impact: 5 },
                'system-failure': { likelihood: 3, impact: 4 }
            };
            
            const score = aiScores[riskId];
            if (score) {
                selectRiskScore(riskId, score.likelihood, score.impact);
                showToast('AI suggested score accepted!', 'success');
            }
            
            closeModal();
        }
        
        function closeModal() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
            }
        }
        
        // Dynamic Risk Assessment Generation
        function generateRiskAssessmentCards() {
            const container = document.getElementById('risk-assessment-container');
            if (!container) return;
            
            // Clear existing cards
            container.innerHTML = '';
            
            // Only show cards for selected risks
            assessmentData.selectedRisks.forEach((riskId, index) => {
                const riskData = getRiskDataForAssessment(riskId);
                if (riskData) {
                    const cardHTML = createRiskAssessmentCardHTML(riskId, riskData, index);
                    container.insertAdjacentHTML('beforeend', cardHTML);
                    
                    // Initialize the modern heat map grid for this risk
                    initializeModernHeatMapGrid(riskId, riskData);
                }
            });
        }
        
        // Initialize modern heat map grid with proper cell generation
        function initializeModernHeatMapGrid(riskId, riskData) {
            const grid = document.getElementById(`grid-${riskId}`);
            if (!grid) {
                console.error('❌ Heat map grid not found for risk:', riskId);
                return;
            }
            
            grid.innerHTML = '';
            
            // Create 25 cells (5x5 grid) - Impact (rows) from 5 to 1, Likelihood (cols) from 1 to 5
            for (let impact = 5; impact >= 1; impact--) {
                for (let likelihood = 1; likelihood <= 5; likelihood++) {
                    const cell = document.createElement('div');
                    const riskScore = likelihood * impact;
                    
                    // Use direct risk score for consistent color coding across all heat maps
                    cell.className = `heat-map-cell risk-${riskScore}`;
                    cell.dataset.likelihood = likelihood;
                    cell.dataset.impact = impact;
                    cell.dataset.riskScore = riskScore;
                    cell.dataset.l = likelihood;
                    cell.dataset.i = impact;
                    cell.dataset.riskId = riskId;
                    cell.textContent = riskScore;
                    cell.title = `Likelihood: ${likelihood}, Impact: ${impact}, Risk: ${riskScore}`;
                    
                    // Check if this is AI suggested
                    const isAiSuggested = (likelihood === riskData.aiSuggestion.l && impact === riskData.aiSuggestion.i);
                    if (isAiSuggested) {
                        cell.classList.add('ai-suggested');
                    }
                    
                    grid.appendChild(cell);
                }
            }
        }
        
        function getRiskDataForAssessment(riskId) {
            const riskDatabase = {
                'unauthorized-transfer': {
                    title: 'Unauthorized Wire Transfer',
                    icon: 'bi-shield-exclamation text-danger',
                    category: 'Operational Risk',
                    history: ['L:3 I:5', 'L:3 I:5', 'L:4 I:5', 'L:4 I:5', 'L:4 I:5'],
                    trend: 'Stable ↔️',
                    aiSuggestion: { l: 4, i: 5, confidence: 87 },
                    reasoning: 'Wire fraud incidents up 35% this year. Your KRIs show elevated exception rates.',
                    kris: [
                        { name: 'Wire Exception Rate', value: '0.8%', trend: '↑', change: 'from 0.5% last period', color: 'warning' },
                        { name: 'Fraud Attempts', value: '12', trend: '↑', change: 'from 8 last month', color: 'danger' }
                    ]
                },
                'system-failure': {
                    title: 'Wire Transfer System Failure',
                    icon: 'bi-exclamation-triangle text-warning',
                    category: 'Technology Risk',
                    history: ['L:2 I:4', 'L:3 I:4', 'L:3 I:4', 'L:3 I:4', 'L:3 I:4'],
                    trend: 'Stable ↔️',
                    aiSuggestion: { l: 3, i: 4, confidence: 79 },
                    reasoning: 'System availability improved but complexity increased with new integrations.',
                    kris: [
                        { name: 'System Uptime', value: '99.7%', trend: '↑', change: 'from 99.2% last quarter', color: 'success' },
                        { name: 'Critical Incidents', value: '1', trend: '↓', change: 'from 3 last quarter', color: 'success' }
                    ]
                },
                'compliance-violation': {
                    title: 'Regulatory Compliance Violation',
                    icon: 'bi-shield-exclamation text-danger',
                    category: 'Compliance Risk',
                    history: ['L:2 I:5', 'L:2 I:5', 'L:2 I:5', 'L:3 I:5', 'L:3 I:5'],
                    trend: 'Increasing ↗️',
                    aiSuggestion: { l: 3, i: 5, confidence: 82 },
                    reasoning: 'Regulatory complexity increasing with new AML requirements.',
                    kris: [
                        { name: 'Compliance Violations', value: '0', trend: '→', change: 'stable this quarter', color: 'success' },
                        { name: 'Audit Findings', value: '2', trend: '↑', change: 'from 1 last audit', color: 'warning' }
                    ]
                },
                'processing-error': {
                    title: 'Wire Processing Error',
                    icon: 'bi-exclamation-triangle text-warning',
                    category: 'Operational Risk',
                    history: ['L:3 I:3', 'L:3 I:3', 'L:3 I:3', 'L:2 I:3', 'L:2 I:3'],
                    trend: 'Decreasing ↘️',
                    aiSuggestion: { l: 2, i: 3, confidence: 75 },
                    reasoning: 'Process automation reducing manual errors, but volume increasing.',
                    kris: [
                        { name: 'Processing Errors', value: '0.2%', trend: '↓', change: 'from 0.4% last quarter', color: 'success' },
                        { name: 'Wire Volume', value: '2,340', trend: '↑', change: 'from 2,100 last month', color: 'info' }
                    ]
                },
                'deepfake-voice': {
                    title: 'Deepfake Voice Authorization',
                    icon: 'bi-exclamation-triangle text-danger',
                    category: 'Operational Risk',
                    history: ['New Risk'],
                    trend: 'New Risk',
                    aiSuggestion: { l: 4, i: 5, confidence: 91 },
                    reasoning: 'Emerging threat with 340% increase in industry incidents.',
                    kris: [
                        { name: 'Voice Auth Usage', value: '45%', trend: '↑', change: 'of wire authorizations', color: 'info' },
                        { name: 'Detection Rate', value: '78%', trend: '↑', change: 'with new AI tools', color: 'warning' }
                    ]
                },
                'realtime-reversal': {
                    title: 'Real-time Payment Reversal Risk',
                    icon: 'bi-shield-exclamation text-info',
                    category: 'Compliance Risk',
                    history: ['New Risk'],
                    trend: 'New Risk',
                    aiSuggestion: { l: 3, i: 4, confidence: 85 },
                    reasoning: 'New FedNow requirements effective January 2025.',
                    kris: [
                        { name: 'Reversal Requests', value: '0', trend: '→', change: 'not yet effective', color: 'info' },
                        { name: 'Readiness Score', value: '65%', trend: '↑', change: 'implementation progress', color: 'warning' }
                    ]
                }
            };
            
            return riskDatabase[riskId];
        }
        
        function createRiskAssessmentCardHTML(riskId, riskData, index) {
            const historyPills = riskData.history.map(score => 
                `<span class="score-pill">${score}</span>`
            ).join('');
            
            const kriRows = riskData.kris.map(kri => `
                <div class="col-md-6">
                    <div class="kri-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${kri.name}:</span>
                            <span class="kri-value text-${kri.color}">${kri.value} <i class="bi bi-arrow-${kri.trend === '↑' ? 'up' : kri.trend === '↓' ? 'down' : 'right'}"></i></span>
                        </div>
                        <small class="text-muted">${kri.change}</small>
                    </div>
                </div>
            `).join('');
            
            return `
                <div class="risk-assessment-card${index > 0 ? ' mt-4' : ''}" data-risk="${riskId}">
                    <div class="risk-assessment-header">
                        <h4><i class="bi ${riskData.icon} me-2"></i>${riskData.title}</h4>
                        <span class="risk-category">${riskData.category}</span>
                    </div>
                    
                    <div class="row">
                        <!-- Historical Context -->
                        <div class="col-md-3">
                            <div class="context-panel">
                                <h6><i class="bi bi-clock-history me-2"></i>Historical Context</h6>
                                <div class="history-item">
                                    <strong>Last Assessments:</strong>
                                    <div class="history-scores">
                                        ${historyPills}
                                        <span class="score-pill current">L:? I:?</span>
                                    </div>
                                </div>
                                <div class="trend-indicator">
                                    <span class="trend-stable">
                                        <i class="bi bi-arrow-right me-1"></i>Trend: ${riskData.trend}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AI Analysis -->
                        <div class="col-md-3">
                            <div class="ai-analysis-panel">
                                <h6><i class="bi bi-robot me-2"></i>AI Analysis</h6>
                                <div class="ai-suggestion-score">
                                    <div class="suggested-score">
                                        <strong>Suggested: L${riskData.aiSuggestion.l} × I${riskData.aiSuggestion.i}</strong>
                                        <div class="confidence-bar">
                                            <div class="confidence-fill" style="width: ${riskData.aiSuggestion.confidence}%"></div>
                                        </div>
                                        <small class="text-muted">${riskData.aiSuggestion.confidence}% confidence</small>
                                    </div>
                                </div>
                                <div class="ai-reasoning">
                                    <p class="mb-2">"${riskData.reasoning}"</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="showAIReasoning('${riskId}')">
                                        <i class="bi bi-question-circle me-1"></i>Why?
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modern Risk Scoring Grid -->
                        <div class="col-md-6">
                            <div class="scoring-panel">
                                <h6><i class="bi bi-grid-3x3 me-2"></i>Select Likelihood & Impact</h6>
                                
                                <!-- Modern heat map with perfect axis alignment -->
                                <div class="heat-map-wrapper" data-risk="${riskId}">
                                    <!-- Impact axis container with title and labels -->
                                    <div class="impact-axis-container">
                                        <div class="impact-axis-title">Impact</div>
                                        <div class="impact-labels-container">
                                            <div class="impact-label">Severe</div>
                                            <div class="impact-label">Major</div>
                                            <div class="impact-label">Moderate</div>
                                            <div class="impact-label">Minor</div>
                                            <div class="impact-label">Insignificant</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Heat map grid -->
                                    <div class="heat-map-grid-container">
                                        <div class="heat-map-grid risk-matrix" data-risk="${riskId}" id="grid-${riskId}">
                                            <!-- Grid cells will be generated by JavaScript -->
                                        </div>
                                    </div>
                                    
                                    <!-- Likelihood axis (horizontal, below grid) -->
                                    <div class="likelihood-labels-container">
                                        <div class="likelihood-axis">
                                            <small>Rare</small>
                                            <small>Unlikely</small>
                                            <small>Possible</small>
                                            <small>Likely</small>
                                            <small>Almost Certain</small>
                                        </div>
                                        <div class="likelihood-axis">
                                            <div class="axis-title">Likelihood</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="selected-score mt-2" id="score-${riskId}">
                                    <strong>Selected Score: </strong><span class="current-score">Not selected</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KRI Correlation -->
                    <div class="kri-correlation mt-3">
                        <h6><i class="bi bi-graph-up me-2"></i>Key Risk Indicator Correlation</h6>
                        <div class="row">
                            ${kriRows}
                        </div>
                    </div>
                    
                    <!-- Comments -->
                    <div class="risk-comments mt-3">
                        <label for="comments-${riskId}" class="form-label">
                            <i class="bi bi-chat-text me-2"></i>Additional Comments (Optional)
                        </label>
                        <textarea class="form-control" id="comments-${riskId}" rows="2" 
                            placeholder="Any additional context for this risk assessment..."></textarea>
                    </div>
                </div>
            `;
        }
        
                // Enhanced Control Mapping Functions
        function generateEnhancedControlMappingCards() {
            const container = document.getElementById('enhanced-control-mapping-container');
            if (!container) return;
            
            // Clear existing content
            container.innerHTML = '';
            
            // Initialize control mappings structure
            if (!assessmentData.controlMappings) assessmentData.controlMappings = {};
            if (!assessmentData.coverageAllocations) assessmentData.coverageAllocations = {};
            
            // Generate enhanced control mapping cards for each selected risk
            assessmentData.selectedRisks.forEach((riskId, index) => {
                const riskData = getRiskDataForAssessment(riskId);
                if (riskData) {
                    const cardHTML = createEnhancedControlMappingCardHTML(riskId, riskData, index);
                    container.insertAdjacentHTML('beforeend', cardHTML);
                }
            });
            
            // Update global progress indicators
            updateControlMappingProgress();
        }
        
        function createEnhancedControlMappingCardHTML(riskId, riskData, index) {
            // Initialize control mappings and coverage allocations for this risk
            if (!assessmentData.controlMappings[riskId]) assessmentData.controlMappings[riskId] = [];
            if (!assessmentData.coverageAllocations[riskId]) assessmentData.coverageAllocations[riskId] = {};
            
            const linkedControls = assessmentData.controlMappings[riskId] || [];
            const coverageAllocations = assessmentData.coverageAllocations[riskId] || {};
            
            // Calculate current coverage percentage
            const totalCoverage = Object.values(coverageAllocations).reduce((sum, percentage) => sum + percentage, 0);
            const coverageClass = totalCoverage === 100 ? 'complete' : totalCoverage > 100 ? 'over-allocated' : totalCoverage > 0 ? 'partial' : 'empty';
            
            // Calculate control type distribution
            const preventiveCount = linkedControls.filter(c => c.type === 'preventive').length;
            const detectiveCount = linkedControls.filter(c => c.type === 'detective').length;
            
            return `
                <div class="enhanced-risk-card ${coverageClass}" data-risk="${riskId}">
                    <!-- Risk Card Header -->
                    <div class="risk-card-header">
                        <div class="risk-card-title">
                            <h4 class="risk-title-text">
                                <i class="bi bi-shield-exclamation text-primary me-2"></i>
                                ${riskData.title}
                            </h4>
                            <div class="mt-2">
                                <span class="badge bg-primary">${riskData.category || 'Operational Risk'}</span>
                                <span class="badge ${linkedControls.length > 0 ? 'bg-success' : 'bg-secondary'} ms-2">
                            ${linkedControls.length} control${linkedControls.length !== 1 ? 's' : ''} linked
                        </span>
                            </div>
                    </div>
                    
                        <!-- Coverage Progress -->
                        <div class="coverage-progress-bar">
                            <div class="coverage-fill ${coverageClass}" style="width: ${Math.min(totalCoverage, 100)}%" id="coverage-fill-${riskId}"></div>
                    </div>
                    
                        <div class="coverage-stats">
                            <span class="coverage-percentage" id="coverage-percentage-${riskId}">${totalCoverage}% Coverage</span>
                            <span class="control-type-distribution">
                                ${preventiveCount}P / ${detectiveCount}D
                            </span>
                        </div>
                    </div>
                    
                    <!-- AI Control Suggestions Section -->
                    <div class="control-suggestions-section" id="suggestions-section-${riskId}">
                                                                 <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="mb-0">
                                    <i class="bi bi-robot text-primary me-2"></i>
                                    AI-Recommended Controls
                                </h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="generateAISuggestionsForRisk('${riskId}')">
                                        <i class="bi bi-magic me-1"></i>AI Suggestions
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="openControlSearchModal('${riskId}')">
                                        <i class="bi bi-search me-1"></i>Search All Controls
                                    </button>
                                </div>
                            </div>
                        
                        <div id="ai-suggestions-${riskId}">
                            <div class="text-muted text-center py-3">
                                <i class="bi bi-robot display-6 opacity-25"></i>
                                <p class="mb-0">Click "Generate Suggestions" to see AI-recommended controls</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coverage Allocation Section -->
                    ${linkedControls.length > 0 ? `
                        <div class="coverage-allocation-section">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h6 class="mb-0">
                                    <i class="bi bi-pie-chart text-warning me-2"></i>
                                    Coverage Allocation
                                </h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" onclick="distributeEvenCoverage('${riskId}')">
                                        <i class="bi bi-distribute-horizontal me-1"></i>Even
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="optimizeCoverage('${riskId}')">
                                        <i class="bi bi-gear me-1"></i>Optimize
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="resetCoverage('${riskId}')">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                    </button>
                                </div>
                            </div>
                            
                            <div id="coverage-allocation-${riskId}">
                                ${linkedControls.map(control => `
                                    <div class="allocation-control-item">
                                        <div class="allocation-header">
                                        <div>
                                            <strong>${control.title}</strong>
                                            <div class="mt-1">
                                                <span class="control-type-badge control-type-${control.type}">${control.type}</span>
                                                <span class="control-automation-badge control-${control.automated ? 'automated' : 'manual'}">
                                                    ${control.automated ? 'Automated' : 'Manual'}
                                                </span>
                                            </div>
                                        </div>
                                            <button class="btn btn-outline-danger btn-sm" onclick="removeControlFromRisk('${riskId}', '${control.id}')">
                                                <i class="bi bi-x"></i>
                                        </button>
                                        </div>
                                        
                                        <div class="allocation-controls">
                                            <input type="range" 
                                                   class="coverage-slider" 
                                                   min="0" max="100" 
                                                   value="${coverageAllocations[control.id] || 0}" 
                                                   onchange="updateCoverageAllocation('${riskId}', '${control.id}', this.value)"
                                                   oninput="updateCoverageAllocation('${riskId}', '${control.id}', this.value)">
                                            
                                            <input type="number" 
                                                   class="coverage-input" 
                                                   min="0" max="100" 
                                                   value="${coverageAllocations[control.id] || 0}" 
                                                   onchange="updateCoverageAllocation('${riskId}', '${control.id}', this.value)"
                                                   id="coverage-input-${riskId}-${control.id}">
                                            <span>%</span>
                                            
                                            <div class="preset-buttons">
                                                <button class="preset-btn" onclick="setCoveragePreset('${riskId}', '${control.id}', 25)">25%</button>
                                                <button class="preset-btn" onclick="setCoveragePreset('${riskId}', '${control.id}', 50)">50%</button>
                                                <button class="preset-btn" onclick="setCoveragePreset('${riskId}', '${control.id}', 75)">75%</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Coverage Validation -->
                            <div class="coverage-validation mt-3" id="coverage-validation-${riskId}">
                                ${generateCoverageValidation(riskId, totalCoverage, preventiveCount, detectiveCount)}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // Enhanced Control Mapping Support Functions
        function generateCoverageValidation(riskId, totalCoverage, preventiveCount, detectiveCount) {
            let validationHTML = '';
            
            if (totalCoverage === 100) {
                validationHTML = `
                    <div class="alert alert-success d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span><strong>Perfect Coverage!</strong> Risk is fully mitigated at 100% coverage.</span>
                        </div>
                `;
            } else if (totalCoverage > 100) {
                validationHTML = `
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span><strong>Over-allocated by ${totalCoverage - 100}%</strong> - Please adjust coverage percentages.</span>
                    </div>
                `;
            } else if (totalCoverage > 0) {
                validationHTML = `
                    <div class="alert alert-warning d-flex align-items-center">
                        <i class="bi bi-clock-fill me-2"></i>
                        <span><strong>${100 - totalCoverage}% coverage remaining</strong> - Add more controls or increase percentages.</span>
                    </div>
                `;
            } else {
                validationHTML = `
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="bi bi-shield-x me-2"></i>
                        <span><strong>No coverage allocated</strong> - This risk is completely unmitigated.</span>
                </div>
            `;
        }
        
            // Add control balance insights
            if (preventiveCount === 0 && detectiveCount > 0) {
                validationHTML += `
                    <div class="alert alert-info d-flex align-items-center mt-2">
                        <i class="bi bi-info-circle me-2"></i>
                        <span><strong>Consider adding preventive controls</strong> to stop this risk before it occurs.</span>
                    </div>
                `;
            } else if (detectiveCount === 0 && preventiveCount > 0) {
                validationHTML += `
                    <div class="alert alert-info d-flex align-items-center mt-2">
                        <i class="bi bi-search me-2"></i>
                        <span><strong>Consider adding detective controls</strong> to identify when this risk occurs.</span>
                    </div>
                `;
            } else if (preventiveCount > 0 && detectiveCount > 0) {
                validationHTML += `
                    <div class="alert alert-success d-flex align-items-center mt-2">
                        <i class="bi bi-shield-check me-2"></i>
                        <span><strong>Balanced control approach</strong> with both preventive and detective controls.</span>
                    </div>
                `;
            }
            
            return validationHTML;
        }
        
        function generateEnhancedAIControlSuggestions(riskId, riskData) {
            // Enhanced AI control library with match scores and reasoning
            const controlSuggestions = getEnhancedAIControlSuggestions(riskId);
            
            return controlSuggestions.map(control => `
                <div class="ai-control-card ${control.linked ? 'linked' : ''}" 
                     data-control-id="${control.id}" 
                     data-risk-id="${riskId}"
                     onclick="selectControlSuggestion('${riskId}', '${control.id}')">
                    <div class="control-card-header">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="control-match-score ${control.matchScore >= 90 ? 'high' : control.matchScore >= 75 ? 'medium' : ''}">
                                    ${control.matchScore}%
                                </span>
                                <h6 class="control-title mb-0">${control.title}</h6>
                            </div>
                            <p class="control-description">${control.description}</p>
                            <div class="control-badges">
                                <span class="control-type-badge control-type-${control.type}">${control.type}</span>
                                <span class="control-automation-badge control-${control.automated ? 'automated' : 'manual'}">
                                    ${control.automated ? 'Automated' : 'Manual'}
                                </span>
                                <span class="badge bg-light text-dark">${control.effectiveness} Effectiveness</span>
                            </div>
                        </div>
                        <div class="ms-3">
                            ${control.linked ? 
                                '<button class="control-action-btn linked" disabled><i class="bi bi-check me-1"></i>Linked</button>' :
                                `<button class="control-action-btn" onclick="event.stopPropagation(); linkControlToRisk('${riskId}', '${control.id}')">
                                    <i class="bi bi-plus me-1"></i>Link
                                </button>`
                            }
                        </div>
                    </div>
                    ${control.aiReasoning ? `
                        <div class="ai-reasoning mt-2">
                            <small class="text-muted">
                                <i class="bi bi-robot me-1"></i>
                                <em>${control.aiReasoning}</em>
                            </small>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function getEnhancedAIControlSuggestions(riskId) {
            // Enhanced AI-powered control suggestions with reasoning and effectiveness
            const enhancedControlDatabase = {
                'unauthorized-transfer': [
                    {
                        id: 'ctrl-001',
                        title: 'Dual Authorization for Wires >$10K',
                        description: 'Requires two authorized signatories for wire transfers exceeding $10,000',
                        type: 'preventive',
                        automated: true,
                        effectiveness: 'High',
                        matchScore: 95,
                        linked: false,
                        aiReasoning: 'High match - dual controls are industry best practice for high-value wire transfers and prevent 98% of unauthorized transactions.'
                    },
                    {
                        id: 'ctrl-002', 
                        title: 'Real-time Fraud Detection System',
                        description: 'AI-powered system monitoring wire transfer patterns for anomalies and suspicious activity',
                        type: 'detective',
                        automated: true,
                        effectiveness: 'High',
                        matchScore: 92,
                        linked: false,
                        aiReasoning: 'Strong match - ML algorithms can detect 87% of fraud attempts within 30 seconds of initiation.'
                    },
                    {
                        id: 'ctrl-003',
                        title: 'Daily Wire Transfer Reconciliation',
                        description: 'Daily reconciliation of all outgoing wire transfers with supporting documentation',
                        type: 'detective',
                        automated: false,
                        effectiveness: 'Medium',
                        matchScore: 89,
                        linked: false,
                        aiReasoning: 'Good match - manual reconciliation catches errors but has 24-hour detection delay.'
                    },
                    {
                        id: 'ctrl-004',
                        title: 'Customer Callback Verification',
                        description: 'Required callback to customer-provided phone number for all wire transfers >$5K',
                        type: 'preventive',
                        automated: false,
                        effectiveness: 'High',
                        matchScore: 85,
                        linked: false,
                        aiReasoning: 'Excellent for preventing social engineering attacks - 95% effective against phone-based fraud.'
                    },
                    {
                        id: 'ctrl-005',
                        title: 'Wire Transfer Velocity Controls',
                        description: 'Automated limits on number and value of wire transfers per customer per day',
                        type: 'preventive',
                        automated: true,
                        effectiveness: 'Medium',
                        matchScore: 78,
                        linked: false,
                        aiReasoning: 'Moderately effective - prevents bulk fraud but may impact legitimate business customers.'
                    }
                ],
                'system-failure': [
                    {
                        id: 'ctrl-006',
                        title: 'Automated System Health Monitoring',
                        description: 'Continuous monitoring of wire transfer system availability and performance',
                        type: 'detective',
                        automated: true,
                        effectiveness: 'High',
                        matchScore: 94,
                        linked: false,
                        aiReasoning: 'Excellent match - real-time monitoring reduces system downtime by 78% through early problem detection.'
                    },
                    {
                        id: 'ctrl-007',
                        title: 'Backup Wire Transfer System',
                        description: 'Secondary system for processing wires during primary system outages',
                        type: 'preventive',
                        automated: true,
                        effectiveness: 'High',
                        matchScore: 90,
                        linked: false,
                        aiReasoning: 'Strong preventive control - ensures 99.9% uptime and business continuity during failures.'
                    },
                    {
                        id: 'ctrl-008',
                        title: 'Daily System Backup Verification',
                        description: 'Automated verification that all wire transfer data is properly backed up',
                        type: 'detective',
                        automated: true,
                        effectiveness: 'Medium',
                        matchScore: 82,
                        linked: false,
                        aiReasoning: 'Important for disaster recovery - ensures 100% data recoverability within 4 hours.'
                    },
                    {
                        id: 'ctrl-009',
                        title: 'Load Balancing & Auto-Scaling',
                        description: 'Automatic distribution of wire processing load across multiple servers',
                        type: 'preventive',
                        automated: true,
                        effectiveness: 'High',
                        matchScore: 76,
                        linked: false,
                        aiReasoning: 'Prevents system overload during peak periods - maintains performance under 3x normal load.'
                    }
                ]
            };
            
            return enhancedControlDatabase[riskId] || [];
        }
        
        // Enhanced Control Mapping Functions
        function generateAllAISuggestions() {
            updateAIInsights('Generating AI control suggestions for all risks...', 'loading');
            
            let generatedCount = 0;
            assessmentData.selectedRisks.forEach(riskId => {
                generateAISuggestionsForRisk(riskId);
                generatedCount++;
            });
            
            setTimeout(() => {
                updateAIInsights(`Generated ${generatedCount * 4} control suggestions across ${generatedCount} risks with 95% match accuracy.`, 'success');
                showToast(`AI generated ${generatedCount * 4} control suggestions successfully!`, 'success');
            }, 1500);
        }
        
        function generateAISuggestionsForRisk(riskId) {
            const container = document.getElementById(`ai-suggestions-${riskId}`);
            if (!container) return;
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0 text-muted">AI analyzing risk and generating control suggestions...</p>
                </div>
            `;
            
            // Simulate AI processing delay
            setTimeout(() => {
                const riskData = getRiskDataForAssessment(riskId);
                container.innerHTML = generateEnhancedAIControlSuggestions(riskId, riskData);
                
                showToast(`AI generated control suggestions for ${riskData.title}`, 'success');
            }, 1000 + Math.random() * 1000); // Random delay 1-2 seconds
        }
        
        function linkControlToRisk(riskId, controlId) {
            const suggestions = getEnhancedAIControlSuggestions(riskId);
            const control = suggestions.find(c => c.id === controlId);
            
            if (!control) return;
            
            // Check if already linked
            if (assessmentData.controlMappings[riskId].find(c => c.id === controlId)) {
                showToast('Control is already linked to this risk!', 'warning');
                return;
            }
            
            // Add to linked controls
            assessmentData.controlMappings[riskId].push({
                id: control.id,
                title: control.title,
                description: control.description,
                type: control.type,
                automated: control.automated,
                effectiveness: control.effectiveness
            });
            
            // Initialize coverage allocation
            assessmentData.coverageAllocations[riskId][controlId] = 0;
            
            // Mark as linked in suggestions
            control.linked = true;
            
            // Update UI
            updateEnhancedControlMappingCard(riskId);
            updateControlMappingProgress();
            saveProgress();
            
            showToast(`Control "${control.title}" linked successfully!`, 'success');
        }
        
        function removeControlFromRisk(riskId, controlId) {
            if (!assessmentData.controlMappings[riskId]) return;
            
            // Get control title for toast message
            const control = assessmentData.controlMappings[riskId].find(c => c.id === controlId);
            const controlTitle = control ? control.title : 'Control';
            
            // Remove from linked controls
            assessmentData.controlMappings[riskId] = assessmentData.controlMappings[riskId].filter(c => c.id !== controlId);
            
            // Remove from coverage allocations
            if (assessmentData.coverageAllocations[riskId]) {
                delete assessmentData.coverageAllocations[riskId][controlId];
            }
            
            // Mark as unlinked in suggestions
            const suggestions = getEnhancedAIControlSuggestions(riskId);
            const suggestionControl = suggestions.find(c => c.id === controlId);
            if (suggestionControl) suggestionControl.linked = false;
            
            // Update UI
            updateEnhancedControlMappingCard(riskId);
            updateControlMappingProgress();
            saveProgress();
            
            showToast(`"${controlTitle}" removed from risk controls`, 'info');
        }
        
        function updateCoverageAllocation(riskId, controlId, value) {
            const percentage = parseInt(value) || 0;
            
            // Update coverage allocation
            if (!assessmentData.coverageAllocations[riskId]) assessmentData.coverageAllocations[riskId] = {};
            assessmentData.coverageAllocations[riskId][controlId] = percentage;
            
            // Update both slider and input to stay in sync
            const slider = document.querySelector(`input[type="range"][onchange*="'${controlId}'"]`);
            const input = document.getElementById(`coverage-input-${riskId}-${controlId}`);
            if (slider) slider.value = percentage;
            if (input) input.value = percentage;
            
            // Update progress displays
            updateRiskCoverageDisplay(riskId);
            updateControlMappingProgress();
            saveProgress();
        }
        
        function setCoveragePreset(riskId, controlId, percentage) {
            updateCoverageAllocation(riskId, controlId, percentage);
        }
        
        function distributeEvenCoverage(riskId) {
            const controls = assessmentData.controlMappings[riskId] || [];
            if (controls.length === 0) return;
            
            const evenPercentage = Math.floor(100 / controls.length);
            const remainder = 100 % controls.length;
            
            controls.forEach((control, index) => {
                const percentage = evenPercentage + (index < remainder ? 1 : 0);
                updateCoverageAllocation(riskId, control.id, percentage);
            });
            
            updateEnhancedControlMappingCard(riskId);
            showToast('Coverage distributed evenly across all controls', 'success');
        }
        
        function optimizeCoverage(riskId) {
            const controls = assessmentData.controlMappings[riskId] || [];
            if (controls.length === 0) return;
            
            // AI-like optimization based on control effectiveness and type
            const effectivenessWeights = { 'High': 3, 'Medium': 2, 'Low': 1 };
            const typeWeights = { 'preventive': 1.2, 'detective': 1.0 }; // Slight preference for preventive
            
            let totalWeight = 0;
            const controlWeights = {};
            
            controls.forEach(control => {
                const effectWeight = effectivenessWeights[control.effectiveness] || 1;
                const typeWeight = typeWeights[control.type] || 1;
                const automationBonus = control.automated ? 1.1 : 1.0;
                
                const weight = effectWeight * typeWeight * automationBonus;
                controlWeights[control.id] = weight;
                totalWeight += weight;
            });
            
            let remainingPercentage = 100;
            controls.forEach((control, index) => {
                const weight = controlWeights[control.id];
                let percentage;
                
                if (index === controls.length - 1) {
                    // Last control gets remaining percentage to ensure 100% total
                    percentage = remainingPercentage;
                } else {
                    percentage = Math.round((weight / totalWeight) * 100);
                    remainingPercentage -= percentage;
                }
                
                updateCoverageAllocation(riskId, control.id, percentage);
            });
            
            updateEnhancedControlMappingCard(riskId);
            showToast('Coverage optimized based on control effectiveness and automation', 'success');
        }
        
        function resetCoverage(riskId) {
            const controls = assessmentData.controlMappings[riskId] || [];
            
            controls.forEach(control => {
                updateCoverageAllocation(riskId, control.id, 0);
            });
            
            updateEnhancedControlMappingCard(riskId);
            showToast('All coverage allocations reset to 0%', 'info');
        }
        
        function generateGapAnalysis(riskId, linkedControls) {
            const preventiveControls = linkedControls.filter(c => c.type === 'preventive').length;
            const detectiveControls = linkedControls.filter(c => c.type === 'detective').length;
            const automatedControls = linkedControls.filter(c => c.automated).length;
            
            let gaps = [];
            
            if (preventiveControls === 0) {
                gaps.push({
                    type: 'warning',
                    icon: 'bi-shield-exclamation',
                    message: 'No preventive controls mapped - consider adding controls to prevent this risk'
                });
            }
            
            if (detectiveControls === 0) {
                gaps.push({
                    type: 'info',
                    icon: 'bi-search',
                    message: 'No detective controls mapped - consider adding controls to detect if this risk occurs'
                });
            }
            
            if (automatedControls === 0 && linkedControls.length > 0) {
                gaps.push({
                    type: 'info',
                    icon: 'bi-gear',
                    message: 'All controls are manual - consider automation opportunities to reduce human error'
                });
            }
            
            if (linkedControls.length === 0) {
                gaps.push({
                    type: 'danger',
                    icon: 'bi-exclamation-triangle',
                    message: 'No controls mapped - this risk is unmitigated'
                });
            }
            
            if (gaps.length === 0) {
                gaps.push({
                    type: 'success',
                    icon: 'bi-check-circle',
                    message: `Well-balanced control environment with ${preventiveControls} preventive and ${detectiveControls} detective controls`
                });
            }
            
            return gaps.map(gap => `
                <div class="gap-insight">
                    <i class="bi ${gap.icon} text-${gap.type}"></i>
                    <span>${gap.message}</span>
                </div>
            `).join('');
        }
        
        // Enhanced Control Mapping UI Update Functions
        function updateEnhancedControlMappingCard(riskId) {
            const card = document.querySelector(`[data-risk="${riskId}"].enhanced-risk-card`);
            if (!card) return;
            
            const riskData = getRiskDataForAssessment(riskId);
            const index = assessmentData.selectedRisks.findIndex(id => id === riskId);
            
            card.outerHTML = createEnhancedControlMappingCardHTML(riskId, riskData, index);
        }
        
        function updateRiskCoverageDisplay(riskId) {
            const coverageAllocations = assessmentData.coverageAllocations[riskId] || {};
            const totalCoverage = Object.values(coverageAllocations).reduce((sum, percentage) => sum + percentage, 0);
            
            // Update coverage fill bar
            const fillElement = document.getElementById(`coverage-fill-${riskId}`);
            if (fillElement) {
                fillElement.style.width = `${Math.min(totalCoverage, 100)}%`;
                fillElement.className = 'coverage-fill';
                
                if (totalCoverage === 100) {
                    fillElement.classList.add('complete');
                } else if (totalCoverage > 100) {
                    fillElement.classList.add('over-allocated');
                } else if (totalCoverage > 0) {
                    fillElement.classList.add('partial');
                }
            }
            
            // Update coverage percentage text
            const percentageElement = document.getElementById(`coverage-percentage-${riskId}`);
            if (percentageElement) {
                percentageElement.textContent = `${totalCoverage}% Coverage`;
            }
            
            // Update card border styling
            const card = document.querySelector(`[data-risk="${riskId}"].enhanced-risk-card`);
            if (card) {
                card.className = 'enhanced-risk-card';
                if (totalCoverage === 100) {
                    card.classList.add('complete');
                } else if (totalCoverage > 100) {
                    card.classList.add('over-allocated');
                } else if (totalCoverage > 0) {
                    card.classList.add('partial');
                } else {
                    card.classList.add('empty');
                }
            }
            
            // Update coverage validation section
            const validationElement = document.getElementById(`coverage-validation-${riskId}`);
            if (validationElement) {
                const linkedControls = assessmentData.controlMappings[riskId] || [];
                const preventiveCount = linkedControls.filter(c => c.type === 'preventive').length;
                const detectiveCount = linkedControls.filter(c => c.type === 'detective').length;
                
                validationElement.innerHTML = generateCoverageValidation(riskId, totalCoverage, preventiveCount, detectiveCount);
            }
        }
        
        function updateControlMappingProgress() {
            // Calculate overall progress metrics
            let totalCoverage = 0;
            let risksCompleted = 0;
            let totalControls = 0;
            let preventiveControls = 0;
            let detectiveControls = 0;
            
            assessmentData.selectedRisks.forEach(riskId => {
                const coverageAllocations = assessmentData.coverageAllocations[riskId] || {};
                const riskCoverage = Object.values(coverageAllocations).reduce((sum, percentage) => sum + percentage, 0);
                
                totalCoverage += riskCoverage;
                if (riskCoverage === 100) risksCompleted++;
                
                const controls = assessmentData.controlMappings[riskId] || [];
                totalControls += controls.length;
                preventiveControls += controls.filter(c => c.type === 'preventive').length;
                detectiveControls += controls.filter(c => c.type === 'detective').length;
            });
            
            const averageCoverage = assessmentData.selectedRisks.length > 0 ? Math.round(totalCoverage / assessmentData.selectedRisks.length) : 0;
            const balanceRatio = totalControls > 0 ? `${preventiveControls}:${detectiveControls}` : '-';
            
            // Update progress dashboard
            const overallCoverageElement = document.getElementById('overall-coverage');
            const risksCompletedElement = document.getElementById('risks-completed');
            const totalControlsElement = document.getElementById('total-controls');
            const controlBalanceElement = document.getElementById('control-balance');
            
            if (overallCoverageElement) overallCoverageElement.textContent = `${averageCoverage}%`;
            if (risksCompletedElement) risksCompletedElement.textContent = risksCompleted;
            if (totalControlsElement) totalControlsElement.textContent = totalControls;
            if (controlBalanceElement) controlBalanceElement.textContent = balanceRatio;
            
            // Update AI insights
            updateControlMappingAIInsights(averageCoverage, risksCompleted, totalControls, preventiveControls, detectiveControls);
        }
        
        function updateControlMappingAIInsights(averageCoverage, risksCompleted, totalControls, preventiveControls, detectiveControls) {
            let insights = [];
            
            if (averageCoverage === 100 && risksCompleted === assessmentData.selectedRisks.length) {
                insights.push({
                    icon: 'bi-check-circle',
                    type: 'success',
                    message: 'Excellent! All risks have 100% control coverage. Ready to proceed to effectiveness assessment.'
                });
            } else if (averageCoverage >= 80) {
                insights.push({
                    icon: 'bi-speedometer2',
                    type: 'info',
                    message: `Strong progress at ${averageCoverage}% average coverage. ${assessmentData.selectedRisks.length - risksCompleted} risks need completion.`
                });
            } else if (totalControls > 0) {
                insights.push({
                    icon: 'bi-clock',
                    type: 'warning',
                    message: `${averageCoverage}% average coverage. Consider linking more controls or increasing allocation percentages.`
                });
            } else {
                insights.push({
                    icon: 'bi-lightbulb',
                    type: 'info',
                    message: 'Click "Generate AI Suggestions" to see intelligent control recommendations for your risks.'
                });
            }
            
            // Add control balance insights
            if (preventiveControls === 0 && detectiveControls > 0) {
                insights.push({
                    icon: 'bi-shield-plus',
                    type: 'info',
                    message: 'Consider adding preventive controls to stop risks before they occur.'
                });
            } else if (detectiveControls === 0 && preventiveControls > 0) {
                insights.push({
                    icon: 'bi-search',
                    type: 'info',
                    message: 'Consider adding detective controls to identify when risks occur.'
                });
            } else if (preventiveControls > 0 && detectiveControls > 0) {
                insights.push({
                    icon: 'bi-shield-check',
                    type: 'success',
                    message: `Balanced approach with ${preventiveControls} preventive and ${detectiveControls} detective controls.`
                });
            }
            
            updateAIInsights(insights);
        }
        
        function updateAIInsights(insights, type = null) {
            const container = document.getElementById('ai-insights');
            if (!container) return;
            
            if (typeof insights === 'string') {
                // Single message with type
                container.innerHTML = `
                    <div class="ai-insight-item">
                        <i class="bi ${type === 'loading' ? 'bi-hourglass-split' : type === 'success' ? 'bi-check-circle' : 'bi-lightbulb'} text-${type === 'loading' ? 'primary' : type === 'success' ? 'success' : 'warning'}"></i>
                        <span>${insights}</span>
                    </div>
                `;
            } else if (Array.isArray(insights)) {
                // Multiple insights
                container.innerHTML = insights.map(insight => `
                    <div class="ai-insight-item">
                        <i class="bi ${insight.icon} text-${insight.type}"></i>
                        <span>${insight.message}</span>
                    </div>
                `).join('');
            }
        }
        
        function optimizeControlAllocation() {
            let optimizedCount = 0;
            
            assessmentData.selectedRisks.forEach(riskId => {
                const controls = assessmentData.controlMappings[riskId] || [];
                if (controls.length > 0) {
                    optimizeCoverage(riskId);
                    optimizedCount++;
                }
            });
            
            if (optimizedCount > 0) {
                showToast(`Optimized coverage allocation for ${optimizedCount} risks`, 'success');
                updateAIInsights(`Optimized control allocation across ${optimizedCount} risks using AI effectiveness weighting.`, 'success');
            } else {
                showToast('No controls found to optimize. Link controls to risks first.', 'warning');
            }
        }

        // Risk card click handlers
        document.addEventListener('click', function(e) {
            const riskCard = e.target.closest('.risk-card');
            if (riskCard && riskCard.dataset.risk) {
                toggleRisk(riskCard.dataset.risk);
            }
            
                     // Risk matrix cell clicks (modern heat map)
         const riskCell = e.target.closest('.heat-map-cell');
         if (riskCell && riskCell.dataset.l && riskCell.dataset.i) {
             const matrix = riskCell.closest('.risk-matrix');
             const riskId = matrix.dataset.risk;
             const likelihood = parseInt(riskCell.dataset.l);
             const impact = parseInt(riskCell.dataset.i);
             
             selectRiskScore(riskId, likelihood, impact);
         }
        });

        // Step navigation click handlers
        document.addEventListener('click', function(e) {
            const step = e.target.closest('.step');
            if (step && step.dataset.step) {
                const stepNum = parseInt(step.dataset.step);
                const circle = step.querySelector('.step-circle');
                
                // Only allow navigation to completed steps
                if (circle.classList.contains('completed') || stepNum === currentStep) {
                    currentStep = stepNum;
                    updateProgress();
                    saveProgress();
                }
            }
        });

        // Comprehensive Banking Control Database for Search
        const comprehensiveControlDatabase = [
            // Wire Transfer Controls
            { id: 'ctrl-001', title: 'Dual Authorization for Wires >$10K', description: 'Requires two authorized signatories for wire transfers exceeding $10,000', type: 'preventive', automated: true, effectiveness: 'High', category: 'Wire Transfer', keywords: ['dual', 'authorization', 'approval', 'wire', 'high value'] },
            { id: 'ctrl-002', title: 'Real-time Fraud Detection System', description: 'AI-powered system monitoring wire transfer patterns for anomalies and suspicious activity', type: 'detective', automated: true, effectiveness: 'High', category: 'Fraud Prevention', keywords: ['fraud', 'detection', 'monitoring', 'AI', 'real-time', 'anomaly'] },
            { id: 'ctrl-003', title: 'Daily Wire Transfer Reconciliation', description: 'Daily reconciliation of all outgoing wire transfers with supporting documentation', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Reconciliation', keywords: ['reconciliation', 'daily', 'wire', 'documentation'] },
            { id: 'ctrl-004', title: 'Customer Callback Verification', description: 'Required callback to customer-provided phone number for all wire transfers >$5K', type: 'preventive', automated: false, effectiveness: 'High', category: 'Verification', keywords: ['callback', 'verification', 'customer', 'phone', 'confirm'] },
            { id: 'ctrl-005', title: 'Wire Transfer Velocity Controls', description: 'Automated limits on number and value of wire transfers per customer per day', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Limits', keywords: ['velocity', 'limits', 'daily', 'customer', 'threshold'] },

            // System & Technology Controls
            { id: 'ctrl-006', title: 'Automated System Health Monitoring', description: 'Continuous monitoring of wire transfer system availability and performance', type: 'detective', automated: true, effectiveness: 'High', category: 'System Monitoring', keywords: ['system', 'health', 'monitoring', 'availability', 'performance'] },
            { id: 'ctrl-007', title: 'Backup Wire Transfer System', description: 'Secondary system for processing wires during primary system outages', type: 'preventive', automated: true, effectiveness: 'High', category: 'Business Continuity', keywords: ['backup', 'secondary', 'outage', 'continuity', 'failover'] },
            { id: 'ctrl-008', title: 'Daily System Backup Verification', description: 'Automated verification that all wire transfer data is properly backed up', type: 'detective', automated: true, effectiveness: 'Medium', category: 'Data Protection', keywords: ['backup', 'verification', 'data', 'recovery'] },
            { id: 'ctrl-009', title: 'Load Balancing & Auto-Scaling', description: 'Automatic distribution of wire processing load across multiple servers', type: 'preventive', automated: true, effectiveness: 'High', category: 'Performance', keywords: ['load', 'balancing', 'scaling', 'performance', 'distribution'] },
            { id: 'ctrl-010', title: 'Multi-Factor Authentication', description: 'Required MFA for all wire transfer system access', type: 'preventive', automated: true, effectiveness: 'High', category: 'Access Control', keywords: ['MFA', 'authentication', 'access', 'security', 'login'] },

            // Access & Security Controls  
            { id: 'ctrl-011', title: 'Role-Based Access Controls', description: 'Granular permissions based on job function and business need', type: 'preventive', automated: true, effectiveness: 'High', category: 'Access Control', keywords: ['RBAC', 'permissions', 'role', 'access', 'authorization'] },
            { id: 'ctrl-012', title: 'Privileged Access Management', description: 'Enhanced controls for administrative and high-privilege accounts', type: 'preventive', automated: true, effectiveness: 'High', category: 'Access Control', keywords: ['PAM', 'privileged', 'admin', 'elevated', 'access'] },
            { id: 'ctrl-013', title: 'User Access Reviews', description: 'Quarterly review of user access rights and permissions', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Access Control', keywords: ['access', 'review', 'quarterly', 'permissions', 'audit'] },
            { id: 'ctrl-014', title: 'Password Policy Enforcement', description: 'Automated enforcement of strong password requirements', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Access Control', keywords: ['password', 'policy', 'complexity', 'enforcement'] },
            { id: 'ctrl-015', title: 'Session Timeout Controls', description: 'Automatic logout after period of inactivity', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Access Control', keywords: ['session', 'timeout', 'logout', 'inactivity'] },

            // Transaction Controls
            { id: 'ctrl-016', title: 'Transaction Amount Limits', description: 'Daily and per-transaction limits based on customer risk profile', type: 'preventive', automated: true, effectiveness: 'High', category: 'Transaction Limits', keywords: ['limits', 'amount', 'daily', 'transaction', 'threshold'] },
            { id: 'ctrl-017', title: 'Beneficiary Verification', description: 'Verification of wire transfer beneficiary details against sanctions lists', type: 'preventive', automated: true, effectiveness: 'High', category: 'Compliance', keywords: ['beneficiary', 'verification', 'sanctions', 'screening'] },
            { id: 'ctrl-018', title: 'Currency Restriction Controls', description: 'Automated blocking of wires to restricted countries or currencies', type: 'preventive', automated: true, effectiveness: 'High', category: 'Compliance', keywords: ['currency', 'country', 'restrictions', 'blocked', 'sanctions'] },
            { id: 'ctrl-019', title: 'Cut-off Time Enforcement', description: 'Automated enforcement of daily wire transfer cut-off times', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Operational', keywords: ['cutoff', 'time', 'deadline', 'processing'] },
            { id: 'ctrl-020', title: 'Same-Day Wire Approval', description: 'Additional approval required for same-day wire processing requests', type: 'preventive', automated: false, effectiveness: 'Medium', category: 'Approval', keywords: ['same-day', 'approval', 'urgent', 'rush'] },

            // Monitoring & Surveillance
            { id: 'ctrl-021', title: 'AML Transaction Monitoring', description: 'Automated monitoring for anti-money laundering compliance', type: 'detective', automated: true, effectiveness: 'High', category: 'AML Compliance', keywords: ['AML', 'monitoring', 'money laundering', 'suspicious', 'compliance'] },
            { id: 'ctrl-022', title: 'OFAC Sanctions Screening', description: 'Real-time screening against OFAC sanctions lists', type: 'preventive', automated: true, effectiveness: 'High', category: 'Sanctions', keywords: ['OFAC', 'sanctions', 'screening', 'blocked', 'compliance'] },
            { id: 'ctrl-023', title: 'Suspicious Activity Reporting', description: 'Automated generation of suspicious activity reports (SARs)', type: 'detective', automated: true, effectiveness: 'High', category: 'Reporting', keywords: ['SAR', 'suspicious', 'reporting', 'compliance'] },
            { id: 'ctrl-024', title: 'Transaction Pattern Analysis', description: 'AI-powered analysis of customer transaction patterns for anomalies', type: 'detective', automated: true, effectiveness: 'High', category: 'Analytics', keywords: ['pattern', 'analysis', 'AI', 'anomaly', 'behavior'] },
            { id: 'ctrl-025', title: 'Real-time Risk Scoring', description: 'Dynamic risk scoring for each wire transfer based on multiple factors', type: 'detective', automated: true, effectiveness: 'High', category: 'Risk Assessment', keywords: ['risk', 'scoring', 'dynamic', 'real-time', 'assessment'] },

            // Operational Controls
            { id: 'ctrl-026', title: 'Four-Eyes Principle', description: 'Mandatory dual review for all wire transfer processing steps', type: 'preventive', automated: false, effectiveness: 'High', category: 'Operational', keywords: ['four eyes', 'dual', 'review', 'maker', 'checker'] },
            { id: 'ctrl-027', title: 'Exception Handling Procedures', description: 'Standardized procedures for handling wire transfer exceptions', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Exception Handling', keywords: ['exception', 'handling', 'procedures', 'escalation'] },
            { id: 'ctrl-028', title: 'End-of-Day Reconciliation', description: 'Complete reconciliation of all wire transfers at end of business day', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Reconciliation', keywords: ['end of day', 'reconciliation', 'EOD', 'closing'] },
            { id: 'ctrl-029', title: 'Wire Transfer Documentation', description: 'Required documentation and record retention for all wire transfers', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Documentation', keywords: ['documentation', 'records', 'retention', 'audit trail'] },
            { id: 'ctrl-030', title: 'Customer Due Diligence', description: 'Enhanced due diligence for high-risk customers and transactions', type: 'preventive', automated: false, effectiveness: 'High', category: 'Customer Due Diligence', keywords: ['CDD', 'due diligence', 'high risk', 'enhanced'] },

            // Audit & Compliance
            { id: 'ctrl-031', title: 'Internal Audit Testing', description: 'Regular internal audit testing of wire transfer controls', type: 'detective', automated: false, effectiveness: 'High', category: 'Audit', keywords: ['internal audit', 'testing', 'controls', 'review'] },
            { id: 'ctrl-032', title: 'Regulatory Reporting', description: 'Automated generation of required regulatory reports', type: 'detective', automated: true, effectiveness: 'Medium', category: 'Reporting', keywords: ['regulatory', 'reporting', 'compliance', 'automated'] },
            { id: 'ctrl-033', title: 'Control Self-Assessment', description: 'Quarterly self-assessment of control effectiveness by business units', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Assessment', keywords: ['CSA', 'self assessment', 'quarterly', 'effectiveness'] },
            { id: 'ctrl-034', title: 'Management Information Reports', description: 'Regular MI reports on wire transfer volumes, risks, and exceptions', type: 'detective', automated: true, effectiveness: 'Medium', category: 'Reporting', keywords: ['MI', 'management', 'reporting', 'dashboard'] },
            { id: 'ctrl-035', title: 'Key Risk Indicator Monitoring', description: 'Continuous monitoring of key risk indicators with threshold alerting', type: 'detective', automated: true, effectiveness: 'High', category: 'KRI Monitoring', keywords: ['KRI', 'indicators', 'monitoring', 'thresholds', 'alerts'] },

            // Technology & Infrastructure
            { id: 'ctrl-036', title: 'Database Encryption', description: 'Encryption of wire transfer database at rest and in transit', type: 'preventive', automated: true, effectiveness: 'High', category: 'Data Security', keywords: ['encryption', 'database', 'data protection', 'security'] },
            { id: 'ctrl-037', title: 'Network Segmentation', description: 'Isolated network segments for wire transfer processing systems', type: 'preventive', automated: true, effectiveness: 'High', category: 'Network Security', keywords: ['network', 'segmentation', 'isolation', 'security'] },
            { id: 'ctrl-038', title: 'Intrusion Detection System', description: 'Real-time monitoring for unauthorized system access attempts', type: 'detective', automated: true, effectiveness: 'High', category: 'Security Monitoring', keywords: ['IDS', 'intrusion', 'detection', 'monitoring', 'unauthorized'] },
            { id: 'ctrl-039', title: 'Security Patch Management', description: 'Regular application of security patches to wire transfer systems', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Patch Management', keywords: ['patches', 'security', 'updates', 'vulnerability'] },
            { id: 'ctrl-040', title: 'Change Management Process', description: 'Formal change management for all wire transfer system modifications', type: 'preventive', automated: false, effectiveness: 'High', category: 'Change Management', keywords: ['change', 'management', 'approval', 'testing'] },

            // Business Continuity
            { id: 'ctrl-041', title: 'Disaster Recovery Plan', description: 'Comprehensive disaster recovery plan for wire transfer operations', type: 'preventive', automated: false, effectiveness: 'High', category: 'Business Continuity', keywords: ['disaster', 'recovery', 'BCP', 'continuity'] },
            { id: 'ctrl-042', title: 'Business Continuity Testing', description: 'Regular testing of business continuity and disaster recovery procedures', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Business Continuity', keywords: ['BCP', 'testing', 'disaster', 'recovery'] },
            { id: 'ctrl-043', title: 'Alternative Processing Site', description: 'Backup processing facility for wire transfer operations', type: 'preventive', automated: false, effectiveness: 'High', category: 'Business Continuity', keywords: ['backup', 'site', 'alternative', 'processing'] },
            { id: 'ctrl-044', title: 'Data Backup & Recovery', description: 'Regular backup and tested recovery procedures for wire transfer data', type: 'preventive', automated: true, effectiveness: 'High', category: 'Data Protection', keywords: ['backup', 'recovery', 'data', 'protection'] },
            { id: 'ctrl-045', title: 'Communication Backup Systems', description: 'Redundant communication systems for wire transfer networks', type: 'preventive', automated: true, effectiveness: 'Medium', category: 'Communication', keywords: ['communication', 'backup', 'redundant', 'network'] },

            // Training & Awareness
            { id: 'ctrl-046', title: 'Staff Training Programs', description: 'Regular training on wire transfer procedures and fraud awareness', type: 'preventive', automated: false, effectiveness: 'Medium', category: 'Training', keywords: ['training', 'staff', 'procedures', 'awareness'] },
            { id: 'ctrl-047', title: 'Fraud Awareness Training', description: 'Specialized training on fraud detection and prevention techniques', type: 'preventive', automated: false, effectiveness: 'Medium', category: 'Training', keywords: ['fraud', 'awareness', 'training', 'detection'] },
            { id: 'ctrl-048', title: 'Compliance Training Updates', description: 'Regular updates on regulatory changes and compliance requirements', type: 'preventive', automated: false, effectiveness: 'Medium', category: 'Training', keywords: ['compliance', 'training', 'regulatory', 'updates'] },
            { id: 'ctrl-049', title: 'Security Awareness Program', description: 'Ongoing security awareness training for all wire transfer staff', type: 'preventive', automated: false, effectiveness: 'Medium', category: 'Training', keywords: ['security', 'awareness', 'training', 'staff'] },
            { id: 'ctrl-050', title: 'Annual Certification Testing', description: 'Annual certification testing for wire transfer processing staff', type: 'detective', automated: false, effectiveness: 'Medium', category: 'Certification', keywords: ['certification', 'testing', 'annual', 'staff'] }
        ];

        // Enhanced Control Search Functions
        function searchControlDatabase(searchTerm, filters = {}) {
            if (!searchTerm && Object.keys(filters).length === 0) {
                return comprehensiveControlDatabase;
            }
            
            const lowerSearchTerm = searchTerm.toLowerCase();
            
            return comprehensiveControlDatabase.filter(control => {
                // Text search matching
                const textMatch = !searchTerm || 
                    control.title.toLowerCase().includes(lowerSearchTerm) ||
                    control.description.toLowerCase().includes(lowerSearchTerm) ||
                    control.category.toLowerCase().includes(lowerSearchTerm) ||
                    control.keywords.some(keyword => keyword.toLowerCase().includes(lowerSearchTerm));
                
                // Filter matching
                const typeMatch = !filters.type || control.type === filters.type;
                const automationMatch = filters.automated === undefined || control.automated === filters.automated;
                const effectivenessMatch = !filters.effectiveness || control.effectiveness === filters.effectiveness;
                const categoryMatch = !filters.category || control.category === filters.category;
                
                return textMatch && typeMatch && automationMatch && effectivenessMatch && categoryMatch;
            });
        }
        
        function getControlCategories() {
            const categories = [...new Set(comprehensiveControlDatabase.map(c => c.category))];
            return categories.sort();
        }
        
        function openControlSearchModal(riskId) {
            // Create and show enhanced control search modal
            const riskData = getRiskDataForAssessment(riskId);
            const linkedControlIds = (assessmentData.controlMappings[riskId] || []).map(c => c.id);
            
            const modalHTML = `
                <div class="modal fade" id="controlSearchModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <div>
                                    <h5 class="modal-title">
                                        <i class="bi bi-search me-2"></i>
                                        Search Control Library
                                    </h5>
                                    <small class="text-muted">Finding controls for: ${riskData.title}</small>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Search Interface -->
                                <div class="search-interface mb-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="search-input-container">
                                                <i class="bi bi-search search-icon"></i>
                                                <input type="text" 
                                                       class="form-control search-input" 
                                                       id="controlSearchInput"
                                                       placeholder="Search by title, description, or keywords..."
                                                       autocomplete="off">
                                                <div class="search-suggestions" id="searchSuggestions"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                                <i class="bi bi-funnel me-1"></i>
                                                Advanced Filters
                                            </button>
                                            <span class="badge bg-primary ms-2" id="searchResultsCount">50 controls</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Advanced Filters -->
                                    <div class="collapse mt-3" id="advancedFilters">
                                        <div class="card card-body">
                                            <div class="row g-3">
                                                <div class="col-md-3">
                                                    <label class="form-label">Control Type</label>
                                                    <select class="form-select" id="filterType">
                                                        <option value="">All Types</option>
                                                        <option value="preventive">Preventive</option>
                                                        <option value="detective">Detective</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Automation</label>
                                                    <select class="form-select" id="filterAutomation">
                                                        <option value="">All</option>
                                                        <option value="true">Automated</option>
                                                        <option value="false">Manual</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Effectiveness</label>
                                                    <select class="form-select" id="filterEffectiveness">
                                                        <option value="">All Levels</option>
                                                        <option value="High">High</option>
                                                        <option value="Medium">Medium</option>
                                                        <option value="Low">Low</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Category</label>
                                                    <select class="form-select" id="filterCategory">
                                                        <option value="">All Categories</option>
                                                        ${getControlCategories().map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Search Results -->
                                <div class="search-results" id="searchResults">
                                    <!-- Will be populated by search function -->
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="addSelectedControlsFromSearch('${riskId}')" id="addSelectedBtn" disabled>
                                    <i class="bi bi-plus me-1"></i>
                                    Add Selected Controls
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('controlSearchModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize search functionality
            initializeControlSearch(riskId, linkedControlIds);
            
                         // Show modal
             const modal = new bootstrap.Modal(document.getElementById('controlSearchModal'));
             modal.show();
         }
         
         function initializeControlSearch(riskId, linkedControlIds) {
             let selectedControls = new Set();
             let searchTimeout;
             
             // Initial search results
             performControlSearch('', {}, riskId, linkedControlIds, selectedControls);
             
             // Search input handling
             const searchInput = document.getElementById('controlSearchInput');
             searchInput.addEventListener('input', function(e) {
                 const searchTerm = e.target.value;
                 
                 // Clear previous timeout
                 clearTimeout(searchTimeout);
                 
                 // Show suggestions for short queries
                 if (searchTerm.length > 0 && searchTerm.length < 3) {
                     showSearchSuggestions(searchTerm);
                 } else {
                     hideSearchSuggestions();
                 }
                 
                 // Debounced search
                 searchTimeout = setTimeout(() => {
                     const filters = getActiveFilters();
                     performControlSearch(searchTerm, filters, riskId, linkedControlIds, selectedControls);
                 }, 300);
             });
             
             // Filter change handlers
             const filterElements = ['filterType', 'filterAutomation', 'filterEffectiveness', 'filterCategory'];
             filterElements.forEach(filterId => {
                 const element = document.getElementById(filterId);
                 if (element) {
                     element.addEventListener('change', function() {
                         const searchTerm = searchInput.value;
                         const filters = getActiveFilters();
                         performControlSearch(searchTerm, filters, riskId, linkedControlIds, selectedControls);
                     });
                 }
             });
             
             // Update add button state
             function updateAddButtonState() {
                 const addBtn = document.getElementById('addSelectedBtn');
                 if (addBtn) {
                     addBtn.disabled = selectedControls.size === 0;
                     addBtn.textContent = selectedControls.size > 0 ? 
                         `Add Selected Controls (${selectedControls.size})` : 
                         'Add Selected Controls';
                 }
             }
             
             // Store selected controls globally for access from other functions
             window.currentSelectedControls = selectedControls;
             window.currentRiskIdForSearch = riskId;
             window.updateAddButtonState = updateAddButtonState;
         }
         
         function getActiveFilters() {
             const filters = {};
             
             const typeFilter = document.getElementById('filterType');
             if (typeFilter && typeFilter.value) {
                 filters.type = typeFilter.value;
             }
             
             const automationFilter = document.getElementById('filterAutomation');
             if (automationFilter && automationFilter.value) {
                 filters.automated = automationFilter.value === 'true';
             }
             
             const effectivenessFilter = document.getElementById('filterEffectiveness');
             if (effectivenessFilter && effectivenessFilter.value) {
                 filters.effectiveness = effectivenessFilter.value;
             }
             
             const categoryFilter = document.getElementById('filterCategory');
             if (categoryFilter && categoryFilter.value) {
                 filters.category = categoryFilter.value;
             }
             
             return filters;
         }
         
         function performControlSearch(searchTerm, filters, riskId, linkedControlIds, selectedControls) {
             const results = searchControlDatabase(searchTerm, filters);
             const resultsContainer = document.getElementById('searchResults');
             const countElement = document.getElementById('searchResultsCount');
             
             // Update results count
             if (countElement) {
                 countElement.textContent = `${results.length} control${results.length !== 1 ? 's' : ''}`;
             }
             
             if (results.length === 0) {
                 resultsContainer.innerHTML = `
                     <div class="no-results-message">
                         <i class="bi bi-search"></i>
                         <h6>No controls found</h6>
                         <p>Try adjusting your search terms or filters to find more controls.</p>
                     </div>
                 `;
                 return;
             }
             
             // Render search results
             resultsContainer.innerHTML = results.map(control => {
                 const isLinked = linkedControlIds.includes(control.id);
                 const isSelected = selectedControls.has(control.id);
                 const highlightedTitle = highlightSearchTerm(control.title, searchTerm);
                 const highlightedDescription = highlightSearchTerm(control.description, searchTerm);
                 
                 return `
                     <div class="control-search-card ${isSelected ? 'selected' : ''} ${isLinked ? 'already-linked' : ''}" 
                          data-control-id="${control.id}"
                          onclick="${isLinked ? '' : `toggleControlSelection('${control.id}')`}">
                         
                         <div class="search-selection-indicator">
                             ${isLinked ? '<i class="bi bi-check"></i>' : isSelected ? '<i class="bi bi-check"></i>' : ''}
                         </div>
                         
                         <div class="control-search-header">
                             <div class="flex-grow-1">
                                 <h6 class="control-search-title">${highlightedTitle}</h6>
                                 <div class="control-search-category">${control.category}</div>
                             </div>
                         </div>
                         
                         <p class="control-search-description">${highlightedDescription}</p>
                         
                         <div class="control-search-badges">
                             <span class="control-type-badge control-type-${control.type}">${control.type}</span>
                             <span class="control-automation-badge control-${control.automated ? 'automated' : 'manual'}">
                                 ${control.automated ? 'Automated' : 'Manual'}
                             </span>
                             <span class="badge bg-light text-dark">${control.effectiveness} Effectiveness</span>
                             ${isLinked ? '<span class="badge bg-success">Already Linked</span>' : ''}
                         </div>
                     </div>
                 `;
             }).join('');
         }
         
         function highlightSearchTerm(text, searchTerm) {
             if (!searchTerm || searchTerm.length < 2) return text;
             
             const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
             return text.replace(regex, '<span class="search-highlight">$1</span>');
         }
         
         function showSearchSuggestions(searchTerm) {
             const suggestions = comprehensiveControlDatabase
                 .filter(control => 
                     control.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                     control.keywords.some(keyword => keyword.toLowerCase().includes(searchTerm.toLowerCase()))
                 )
                 .slice(0, 5);
             
             const suggestionsContainer = document.getElementById('searchSuggestions');
             if (suggestions.length > 0) {
                 suggestionsContainer.innerHTML = suggestions.map(control => `
                     <div class="search-suggestion-item" onclick="selectSuggestion('${control.title}')">
                         <div class="suggestion-title">${control.title}</div>
                         <div class="suggestion-category">${control.category}</div>
                     </div>
                 `).join('');
                 suggestionsContainer.style.display = 'block';
             } else {
                 hideSearchSuggestions();
             }
         }
         
         function hideSearchSuggestions() {
             const suggestionsContainer = document.getElementById('searchSuggestions');
             if (suggestionsContainer) {
                 suggestionsContainer.style.display = 'none';
             }
         }
         
         function selectSuggestion(title) {
             const searchInput = document.getElementById('controlSearchInput');
             if (searchInput) {
                 searchInput.value = title;
                 searchInput.focus();
                 
                 // Trigger search
                 const event = new Event('input', { bubbles: true });
                 searchInput.dispatchEvent(event);
             }
             hideSearchSuggestions();
         }
         
         function toggleControlSelection(controlId) {
             const selectedControls = window.currentSelectedControls;
             const card = document.querySelector(`[data-control-id="${controlId}"]`);
             
             if (selectedControls.has(controlId)) {
                 selectedControls.delete(controlId);
                 card.classList.remove('selected');
             } else {
                 selectedControls.add(controlId);
                 card.classList.add('selected');
             }
             
             window.updateAddButtonState();
         }
         
         function addSelectedControlsFromSearch(riskId) {
             const selectedControlIds = Array.from(window.currentSelectedControls);
             if (selectedControlIds.length === 0) return;
             
             // Add each selected control
             selectedControlIds.forEach(controlId => {
                 const control = comprehensiveControlDatabase.find(c => c.id === controlId);
                 if (control) {
                     // Check if already linked
                     const existingControl = assessmentData.controlMappings[riskId]?.find(c => c.id === controlId);
                     if (!existingControl) {
                         // Add to linked controls
                         if (!assessmentData.controlMappings[riskId]) assessmentData.controlMappings[riskId] = [];
                         
                         assessmentData.controlMappings[riskId].push({
                             id: control.id,
                             title: control.title,
                             description: control.description,
                             type: control.type,
                             automated: control.automated,
                             effectiveness: control.effectiveness
                         });
                         
                         // Initialize coverage allocation
                         if (!assessmentData.coverageAllocations[riskId]) assessmentData.coverageAllocations[riskId] = {};
                         assessmentData.coverageAllocations[riskId][controlId] = 0;
                     }
                 }
             });
             
             // Update UI
             updateEnhancedControlMappingCard(riskId);
             updateControlMappingProgress();
             saveProgress();
             
             // Close modal
             const modal = bootstrap.Modal.getInstance(document.getElementById('controlSearchModal'));
             modal.hide();
             
             // Show success message
             showToast(`Added ${selectedControlIds.length} control${selectedControlIds.length !== 1 ? 's' : ''} successfully!`, 'success');
         }
         
                   // Hide suggestions when clicking outside
          document.addEventListener('click', function(e) {
              if (!e.target.closest('.search-input-container')) {
                  hideSearchSuggestions();
              }
          });

          // Control Effectiveness Assessment Functions - Simplified Risk-Centric Approach
          function initializeControlEffectivenessPane() {
              console.log('Initializing Control Effectiveness Assessment...');
              
              // Initialize simple data structure
              if (!assessmentData.controlEffectiveness) {
                  assessmentData.controlEffectiveness = {};
              }
              
              // Show loading briefly, then build interface
              showEffectivenessLoading();
              
              setTimeout(() => {
                  buildEffectivenessInterface();
              }, 1500);
          }
          
          function showEffectivenessLoading() {
              const loading = document.getElementById('effectiveness-loading');
              const content = document.getElementById('effectiveness-content');
              
              if (loading) loading.style.display = 'block';
              if (content) content.style.display = 'none';
          }
          
          function buildEffectivenessInterface() {
              const loading = document.getElementById('effectiveness-loading');
              const content = document.getElementById('effectiveness-content');
              const container = document.getElementById('control-effectiveness-assessments');
              const noMappingsState = document.getElementById('no-mappings-state');
              
              if (loading) loading.style.display = 'none';
              if (content) content.style.display = 'block';
              
              // Check if we have control mappings
              const hasControlMappings = checkForControlMappings();
              
              if (!hasControlMappings) {
                  if (container) container.style.display = 'none';
                  if (noMappingsState) noMappingsState.style.display = 'block';
                  return;
              }
              
              // Build the assessment cards
              if (container) {
                  container.innerHTML = generateRiskControlAssessmentCards();
                  container.style.display = 'block';
              }
              if (noMappingsState) noMappingsState.style.display = 'none';
              
              // Initialize dashboard
              updateCEIDashboard();
              
              showToast('Control effectiveness assessment ready', 'success');
          }
          
          function checkForControlMappings() {
              if (!assessmentData.controlMappings) return false;
              
              // Check if any risks have controls mapped
              for (const riskId in assessmentData.controlMappings) {
                  if (assessmentData.controlMappings[riskId] && assessmentData.controlMappings[riskId].length > 0) {
                      return true;
                  }
              }
              return false;
          }
          
          function generateRiskControlAssessmentCards() {
              let html = '';
              
              // Get all risks that have mapped controls
              for (const riskId in assessmentData.controlMappings) {
                  const controls = assessmentData.controlMappings[riskId];
                  if (controls && controls.length > 0) {
                      html += generateRiskAssessmentGroup(riskId, controls);
                  }
              }
              
              return html;
          }
          
          function generateRiskAssessmentGroup(riskId, controls) {
              // Get risk data from selected risks and risk assessments
              const riskData = getRiskDataForEffectiveness(riskId);
              
              return `
                  <div class="risk-assessment-group mb-4" data-risk-id="${riskId}">
                      <!-- Risk Header -->
                      <div class="risk-group-header">
                          <div class="risk-group-title">
                              <h4 class="risk-title-text">${riskData.title}</h4>
                              <span class="risk-score-display">Risk Score: ${riskData.score}</span>
                          </div>
                          <div class="risk-meta-info">
                              <span><i class="bi bi-bookmark-fill me-1"></i>${riskData.category} Risk</span>
                              <span><i class="bi bi-speedometer me-1"></i>L:${riskData.likelihood} × I:${riskData.impact}</span>
                              <span><i class="bi bi-shield-check me-1"></i>${controls.length} Control${controls.length !== 1 ? 's' : ''}</span>
                          </div>
                          <div class="risk-context-note mt-2">
                              <i class="bi bi-info-circle me-2"></i>
                              <strong>Assessment Question:</strong> "Are these controls adequate to keep this specific risk within appetite?"
                          </div>
                      </div>
                      
                      <!-- Control Assessment Cards -->
                      <div class="controls-assessment-section">
                          ${controls.map(control => generateControlAssessmentCard(riskId, control)).join('')}
                      </div>
                  </div>
              `;
          }
          
          function getRiskDataForEffectiveness(riskId) {
              // Try to get from risk assessments first
              if (assessmentData.riskAssessments && assessmentData.riskAssessments[riskId]) {
                  const riskData = assessmentData.riskAssessments[riskId];
                  return {
                      id: riskId,
                      title: riskData.title || `Risk ${riskId}`,
                      category: riskData.category || 'Operational',
                      likelihood: riskData.likelihood || 3,
                      impact: riskData.impact || 3,
                      score: riskData.score || (riskData.likelihood * riskData.impact) || 9
                  };
              }
              
              // Fallback to mock data based on risk ID
              const mockRiskData = {
                  'unauthorized-transfer': {
                      title: 'Unauthorized Wire Transfer',
                      category: 'Operational',
                      likelihood: 4,
                      impact: 5,
                      score: 20
                  },
                  'system-failure': {
                      title: 'Wire Transfer System Failure',
                      category: 'Technology',
                      likelihood: 3,
                      impact: 4,
                      score: 12
                  },
                  'fraud-risk': {
                      title: 'Wire Transfer Fraud',
                      category: 'Fraud',
                      likelihood: 3,
                      impact: 5,
                      score: 15
                  }
              };
              
              return mockRiskData[riskId] || {
                  id: riskId,
                  title: `Risk: ${riskId}`,
                  category: 'Operational',
                  likelihood: 3,
                  impact: 3,
                  score: 9
              };
          }
          
          function generateControlAssessmentCard(riskId, control) {
              const assessmentKey = `${riskId}-${control.id}`;
              
              // Initialize assessment data if not exists
              if (!assessmentData.controlEffectiveness[assessmentKey]) {
                  assessmentData.controlEffectiveness[assessmentKey] = {
                      riskId: riskId,
                      controlId: control.id,
                      designScore: null,
                      operationalScore: null,
                      combinedScore: null,
                      assessed: false
                  };
              }
              
              const assessment = assessmentData.controlEffectiveness[assessmentKey];
              const cardClass = assessment.assessed ? 'assessed' : (assessment.designScore || assessment.operationalScore) ? 'partial' : '';
              
              return `
                  <div class="control-assessment-card ${cardClass} mb-3" data-assessment-key="${assessmentKey}">
                      <div class="control-assessment-header">
                          <div class="control-assessment-title">
                              <h5 class="control-title-text">${control.title}</h5>
                              <span class="control-cei-score" id="cei-${assessmentKey}">
                                  ${assessment.combinedScore ? assessment.combinedScore + '%' : 'Not Assessed'}
                              </span>
                          </div>
                          <div class="control-meta-info">
                              <span class="control-type-badge control-type-${(control.type || 'unknown').toLowerCase()}">
                                  <i class="bi bi-${(control.type === 'preventive' || control.type === 'Preventive') ? 'shield-fill-check' : 'eye-fill'} me-1"></i>
                                  ${control.type || 'Control'}
                              </span>
                              <span class="control-automation-badge control-${control.automated ? 'automated' : 'manual'}">
                                  <i class="bi bi-${control.automated ? 'robot' : 'person-fill'} me-1"></i>
                                  ${control.automated ? 'Automated' : 'Manual'}
                              </span>
                          </div>
                      </div>
                      
                      <div class="assessment-interface">
                          <div class="row">
                              <div class="col-md-6">
                                  <div class="assessment-section">
                                      <label class="assessment-label">
                                          <i class="bi bi-tools me-2"></i>
                                          Design Effectiveness
                                      </label>
                                      <select class="effectiveness-select" data-type="design" data-key="${assessmentKey}" onchange="updateEffectivenessAssessment('${assessmentKey}', 'design', this.value)">
                                          <option value="">Select design effectiveness...</option>
                                          <option value="1" ${assessment.designScore === 1 ? 'selected' : ''}>Ineffective (1) - Major design flaws</option>
                                          <option value="2" ${assessment.designScore === 2 ? 'selected' : ''}>Partially Effective (2) - Some design gaps</option>
                                          <option value="3" ${assessment.designScore === 3 ? 'selected' : ''}>Largely Effective (3) - Adequately designed</option>
                                          <option value="4" ${assessment.designScore === 4 ? 'selected' : ''}>Effective (4) - Well designed</option>
                                          <option value="5" ${assessment.designScore === 5 ? 'selected' : ''}>Highly Effective (5) - Excellent design</option>
                                      </select>
                                      <div class="effectiveness-explanation">
                                          How well is this control designed to prevent/detect this specific risk?
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-6">
                                  <div class="assessment-section">
                                      <label class="assessment-label">
                                          <i class="bi bi-play-circle me-2"></i>
                                          Operational Effectiveness
                                      </label>
                                      <select class="effectiveness-select" data-type="operational" data-key="${assessmentKey}" onchange="updateEffectivenessAssessment('${assessmentKey}', 'operational', this.value)">
                                          <option value="">Select operational effectiveness...</option>
                                          <option value="1" ${assessment.operationalScore === 1 ? 'selected' : ''}>Ineffective (1) - Not operating as designed</option>
                                          <option value="2" ${assessment.operationalScore === 2 ? 'selected' : ''}>Partially Effective (2) - Some operational issues</option>
                                          <option value="3" ${assessment.operationalScore === 3 ? 'selected' : ''}>Largely Effective (3) - Operating adequately</option>
                                          <option value="4" ${assessment.operationalScore === 4 ? 'selected' : ''}>Effective (4) - Operating well</option>
                                          <option value="5" ${assessment.operationalScore === 5 ? 'selected' : ''}>Highly Effective (5) - Excellent operation</option>
                                      </select>
                                      <div class="effectiveness-explanation">
                                          How well is this control actually working in practice for this risk?
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          ${assessment.assessed ? generateAIAnalysisSection(riskId, control, assessment) : ''}
                      </div>
                  </div>
              `;
          }
          
          function updateEffectivenessAssessment(assessmentKey, type, value) {
              console.log(`Updating ${type} effectiveness for ${assessmentKey}: ${value}`);
              
              if (!assessmentData.controlEffectiveness[assessmentKey]) return;
              
              const assessment = assessmentData.controlEffectiveness[assessmentKey];
              const numValue = parseInt(value);
              
              if (type === 'design') {
                  assessment.designScore = numValue;
              } else if (type === 'operational') {
                  assessment.operationalScore = numValue;
              }
              
              // Calculate combined score (lower of design and operational - banking standard)
              if (assessment.designScore && assessment.operationalScore) {
                  assessment.combinedScore = Math.round(Math.min(assessment.designScore, assessment.operationalScore) * 20); // Convert to percentage
                  assessment.assessed = true;
                  
                  // Update the display
                  const scoreElement = document.getElementById(`cei-${assessmentKey}`);
                  if (scoreElement) {
                      scoreElement.textContent = assessment.combinedScore + '%';
                      scoreElement.className = 'control-cei-score ' + getEffectivenessClass(assessment.combinedScore);
                  }
                  
                  // Update card styling
                  const card = document.querySelector(`[data-assessment-key="${assessmentKey}"]`);
                  if (card) {
                      card.className = card.className.replace(/\b(partial|assessed)\b/g, '').trim() + ' assessed';
                  }
                  
                  // Add AI analysis
                  addAIAnalysisToCard(assessmentKey);
                  
                  showToast(`Assessment completed: ${assessment.combinedScore}% effectiveness`, 'success');
              } else {
                  // Mark as partial
                  const card = document.querySelector(`[data-assessment-key="${assessmentKey}"]`);
                  if (card) {
                      card.className = card.className.replace(/\b(partial|assessed)\b/g, '').trim() + ' partial';
                  }
              }
              
              // Update overall CEI dashboard
              updateCEIDashboard();
              
              // Save progress
              saveProgress();
          }
          
          function getEffectivenessClass(percentage) {
              if (percentage >= 80) return 'excellent';
              if (percentage >= 70) return 'good';
              if (percentage >= 60) return 'fair';
              return 'poor';
          }
          
          function generateAIAnalysisSection(riskId, control, assessment) {
              const insights = generateAIInsights(riskId, control, assessment);
              
              return `
                  <div class="ai-analysis-section mt-3">
                      <div class="ai-analysis-header">
                          <i class="bi bi-robot text-primary me-2"></i>
                          <span class="fw-semibold">AI Risk-Control Analysis</span>
                      </div>
                      <div class="ai-analysis-content">
                          <strong>Performance Assessment:</strong> ${insights.performance}<br>
                          <strong>Risk Context:</strong> ${insights.context}<br>
                          <strong>Recommendation:</strong> ${insights.recommendation}
                      </div>
                  </div>
              `;
          }
          
          function generateAIInsights(riskId, control, assessment) {
              const effectiveness = assessment.combinedScore;
              
              // Base insights on effectiveness level and control type
              let performance = '';
              let context = '';
              let recommendation = '';
              
              // Safely get control type with fallback
              const controlType = (control && control.type) ? control.type.toLowerCase() : 'control';
              const isAutomated = control && control.automated;
              
              if (effectiveness >= 80) {
                  performance = `Excellent ${controlType} control effectiveness (${effectiveness}%). This control provides strong risk mitigation.`;
                  context = `This control significantly reduces the likelihood and/or impact of ${riskId.replace('-', ' ')}.`;
                  recommendation = 'Maintain current control design and operation. Consider this as a best practice example.';
              } else if (effectiveness >= 70) {
                  performance = `Good ${controlType} control effectiveness (${effectiveness}%) with room for optimization.`;
                  context = `This control provides adequate protection against ${riskId.replace('-', ' ')} but has enhancement opportunities.`;
                  recommendation = isAutomated ? 
                      'Review operational procedures and exception handling to improve consistency.' :
                      'Consider process automation or additional training to improve operational effectiveness.';
              } else if (effectiveness >= 60) {
                  performance = `Fair ${controlType} control effectiveness (${effectiveness}%). Improvement needed.`;
                  context = `This control provides limited protection against ${riskId.replace('-', ' ')} and requires attention.`;
                  recommendation = 'Implement control enhancements, additional monitoring, or complementary controls to strengthen risk mitigation.';
              } else {
                  performance = `Poor ${controlType} control effectiveness (${effectiveness}%). Significant gaps identified.`;
                  context = `This control provides insufficient protection against ${riskId.replace('-', ' ')} creating residual risk exposure.`;
                  recommendation = 'Immediate action required: redesign control, implement additional controls, or consider risk acceptance/mitigation strategies.';
              }
              
              return { performance, context, recommendation };
          }
          
          function addAIAnalysisToCard(assessmentKey) {
              const card = document.querySelector(`[data-assessment-key="${assessmentKey}"]`);
              if (!card) return;
              
              const assessment = assessmentData.controlEffectiveness[assessmentKey];
              if (!assessment) return;
              
              // Find the assessment interface and add AI analysis if not already present
              const assessmentInterface = card.querySelector('.assessment-interface');
              if (assessmentInterface && !assessmentInterface.querySelector('.ai-analysis-section')) {
                  const riskId = assessment.riskId;
                  const control = getControlForAssessment(assessment);
                  
                  if (control) {
                      const aiAnalysisHTML = generateAIAnalysisSection(riskId, control, assessment);
                      assessmentInterface.insertAdjacentHTML('beforeend', aiAnalysisHTML);
                  }
              }
          }
          
          function getControlForAssessment(assessment) {
              // Find the control object based on the assessment
              const controls = assessmentData.controlMappings[assessment.riskId];
              if (controls) {
                  const control = controls.find(c => c.id === assessment.controlId);
                  if (control) {
                      // Ensure control has required properties with safe defaults
                      return {
                          id: control.id,
                          title: control.title || 'Unknown Control',
                          description: control.description || '',
                          type: control.type || 'control',
                          automated: control.automated || false,
                          effectiveness: control.effectiveness || 'Medium',
                          ...control // Preserve any other properties
                      };
                  }
              }
              
              // Return a default control if not found
              return {
                  id: assessment.controlId || 'unknown',
                  title: 'Unknown Control',
                  description: 'Control details not available',
                  type: 'control',
                  automated: false,
                  effectiveness: 'Medium'
              };
          }
          
          // Test function to add sample effectiveness data for demo
          function addSampleEffectivenessData() {
              console.log('Adding sample effectiveness data for demo...');
              
              // Add sample assessments for testing
              if (assessmentData.controlMappings && Object.keys(assessmentData.controlMappings).length > 0) {
                  for (const riskId in assessmentData.controlMappings) {
                      const controls = assessmentData.controlMappings[riskId];
                      if (controls && controls.length > 0) {
                          controls.slice(0, 2).forEach((control, index) => { // Only first 2 controls for demo
                              const assessmentKey = `${riskId}-${control.id}`;
                              assessmentData.controlEffectiveness[assessmentKey] = {
                                  riskId: riskId,
                                  controlId: control.id,
                                  designScore: 4 + index, // 4 or 5
                                  operationalScore: 3 + index, // 3 or 4  
                                  combinedScore: Math.min(4 + index, 3 + index) * 20, // 60 or 80
                                  assessed: true
                              };
                          });
                      }
                  }
                  
                  // Update the interface
                  updateCEIDashboard();
                  showToast('Sample assessment data added for demo', 'info');
              }
          }
          
          // Quick assess all controls for demo purposes
          function quickAssessAllControls() {
              console.log('Quick assessing all controls...');
              
              if (!assessmentData.controlMappings) return;
              
              for (const riskId in assessmentData.controlMappings) {
                  const controls = assessmentData.controlMappings[riskId];
                  if (controls && controls.length > 0) {
                      controls.forEach(control => {
                          const assessmentKey = `${riskId}-${control.id}`;
                          
                          // Generate realistic scores based on control type and automation
                          let designScore = control.automated ? 4 : 3;
                          let operationalScore = control.type === 'Preventive' ? 4 : 3;
                          
                          // Add some variance
                          if (Math.random() > 0.5) designScore = Math.min(5, designScore + 1);
                          if (Math.random() > 0.3) operationalScore = Math.min(5, operationalScore + 1);
                          
                          assessmentData.controlEffectiveness[assessmentKey] = {
                              riskId: riskId,
                              controlId: control.id,
                              designScore: designScore,
                              operationalScore: operationalScore,
                              combinedScore: Math.min(designScore, operationalScore) * 20,
                              assessed: true
                          };
                      });
                  }
              }
              
              // Rebuild the interface to show assessed state
              if (document.getElementById('effectiveness-content').style.display !== 'none') {
                  buildEffectivenessInterface();
              }
              
              showToast('All controls assessed with AI-optimized scores', 'success');
          }
          
          function getRiskById(riskId) {
              // Get risk data from the risk assessment
              const risk = assessmentData.riskAssessments?.find(r => r.id === riskId);
              if (risk) return risk;
              
              // Fallback to basic risk info if not found in assessments
              return {
                  id: riskId,
                  title: `Risk ${riskId}`,
                  likelihood: 'Medium',
                  impact: 'Medium',
                  inherentScore: 12
              };
          }
          
          function createRiskControlAssessmentGroupHTML(riskId, riskData, controls) {
              const riskScore = calculateRiskScore(riskData.likelihood, riskData.impact);
              const riskClass = getRiskClass(riskScore);
              
              return `
                  <div class="risk-assessment-group" data-risk-id="${riskId}">
                      <!-- Risk Group Header -->
                      <div class="risk-group-header">
                          <div class="risk-group-title">
                              <h4 class="risk-title-text">${riskData.title}</h4>
                              <div class="risk-score-display risk-${riskClass}">
                                  Risk Score: ${riskScore}
                              </div>
                          </div>
                          
                          <div class="risk-meta-info">
                              <span class="risk-likelihood">Likelihood: ${riskData.likelihood}</span>
                              <span class="risk-impact">Impact: ${riskData.impact}</span>
                              <span class="control-count">${controls.length} Control(s) Mapped</span>
                          </div>
                      </div>
                      
                      <!-- Controls for this Risk -->
                      <div class="risk-controls-container">
                          ${controls.map(control => createRiskSpecificControlCardHTML(riskId, control)).join('')}
                      </div>
                  </div>
              `;
          }
          
          function createRiskSpecificControlCardHTML(riskId, control) {
              // Initialize risk-specific effectiveness data structure
              const assessmentKey = `${riskId}-${control.id}`;
              if (!assessmentData.riskControlEffectiveness[assessmentKey]) {
                  assessmentData.riskControlEffectiveness[assessmentKey] = {
                      riskId: riskId,
                      controlId: control.id,
                      designEffectiveness: null,
                      operationalEffectiveness: null,
                      combinedScore: 0,
                      aiInsights: null,
                      evidenceFiles: [],
                      riskContext: null // Specific context for this risk-control relationship
                  };
              }
              
              const effectiveness = assessmentData.riskControlEffectiveness[assessmentKey];
              const hasAssessment = effectiveness.designEffectiveness !== null && effectiveness.operationalEffectiveness !== null;
              const cardClass = hasAssessment ? 'assessed' : (effectiveness.designEffectiveness !== null || effectiveness.operationalEffectiveness !== null) ? 'partial' : '';
              
              return `
                  <div class="control-assessment-card ${cardClass}" data-assessment-key="${assessmentKey}">
                      <!-- Control Header -->
                      <div class="control-assessment-header">
                          <div class="control-assessment-title">
                              <h5 class="control-title-text">${control.title}</h5>
                              <div class="control-cei-score ${getCEIScoreClass(effectiveness.combinedScore)}" id="cei-score-${assessmentKey}">
                                  ${effectiveness.combinedScore > 0 ? effectiveness.combinedScore + '%' : 'Not Assessed'}
                              </div>
                          </div>
                          
                          <div class="control-meta-info">
                              <span class="control-type-badge control-type-${control.type}">${control.type}</span>
                              <span class="control-automation-badge control-${control.automated ? 'automated' : 'manual'}">
                                  ${control.automated ? 'Automated' : 'Manual'}
                              </span>
                              <span class="badge bg-light text-dark">${control.effectiveness} Effectiveness</span>
                          </div>
                          
                          <div class="risk-context-note">
                              <i class="bi bi-target text-warning me-1"></i>
                              <small class="text-muted">Assessing adequacy for this specific risk context</small>
                          </div>
                      </div>
                      
                      <!-- Assessment Interface -->
                      <div class="assessment-interface">
                          <div class="row effectiveness-assessment-row">
                              <div class="col-md-6">
                                  <div class="assessment-section">
                                      <label class="assessment-label">
                                          <i class="bi bi-gear text-primary"></i>
                                          Design Effectiveness
                                      </label>
                                      <select class="effectiveness-select" 
                                              onchange="updateRiskControlEffectiveness('${assessmentKey}', 'design', this.value)"
                                              id="design-${assessmentKey}">
                                          <option value="">Select Assessment...</option>
                                          <option value="effective" ${effectiveness.designEffectiveness === 'effective' ? 'selected' : ''}>Effective (100%)</option>
                                          <option value="partially" ${effectiveness.designEffectiveness === 'partially' ? 'selected' : ''}>Partially Effective (75%)</option>
                                          <option value="ineffective" ${effectiveness.designEffectiveness === 'ineffective' ? 'selected' : ''}>Ineffective (25%)</option>
                                          <option value="na" ${effectiveness.designEffectiveness === 'na' ? 'selected' : ''}>Not Applicable</option>
                                      </select>
                                      <div class="effectiveness-explanation" id="design-explanation-${assessmentKey}">
                                          ${getRiskSpecificEffectivenessExplanation('design', effectiveness.designEffectiveness, riskId)}
                                      </div>
                                  </div>
                              </div>
                              
                              <div class="col-md-6">
                                  <div class="assessment-section">
                                      <label class="assessment-label">
                                          <i class="bi bi-play-circle text-success"></i>
                                          Operational Effectiveness
                                      </label>
                                      <select class="effectiveness-select" 
                                              onchange="updateRiskControlEffectiveness('${assessmentKey}', 'operational', this.value)"
                                              id="operational-${assessmentKey}">
                                          <option value="">Select Assessment...</option>
                                          <option value="effective" ${effectiveness.operationalEffectiveness === 'effective' ? 'selected' : ''}>Effective (100%)</option>
                                          <option value="partially" ${effectiveness.operationalEffectiveness === 'partially' ? 'selected' : ''}>Partially Effective (75%)</option>
                                          <option value="ineffective" ${effectiveness.operationalEffectiveness === 'ineffective' ? 'selected' : ''}>Ineffective (25%)</option>
                                          <option value="na" ${effectiveness.operationalEffectiveness === 'na' ? 'selected' : ''}>Not Applicable</option>
                                      </select>
                                      <div class="effectiveness-explanation" id="operational-explanation-${assessmentKey}">
                                          ${getRiskSpecificEffectivenessExplanation('operational', effectiveness.operationalEffectiveness, riskId)}
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          <!-- AI Analysis Section -->
                          ${effectiveness.aiInsights ? `
                              <div class="ai-analysis-section">
                                  <div class="ai-analysis-header">
                                      <i class="bi bi-robot text-warning"></i>
                                      <h6 class="mb-0">AI Risk-Control Analysis</h6>
                                  </div>
                                  <div class="ai-analysis-content" id="ai-analysis-${assessmentKey}">
                                      ${effectiveness.aiInsights}
                                  </div>
                              </div>
                          ` : ''}
                          
                          <!-- Evidence Section -->
                          <div class="evidence-section">
                              <h6 class="mb-3">
                                  <i class="bi bi-paperclip text-success me-2"></i>
                                  Risk-Specific Evidence
                              </h6>
                              <div class="evidence-upload" onclick="simulateRiskControlEvidenceUpload('${assessmentKey}')">
                                  <i class="bi bi-cloud-upload"></i>
                                  <div><strong>Upload Evidence Files</strong></div>
                                  <div class="text-muted">Testing reports specific to this risk-control relationship</div>
                              </div>
                              <div class="evidence-files mt-3" id="evidence-files-${assessmentKey}">
                                  ${effectiveness.evidenceFiles.map(file => `
                                      <div class="evidence-file-item">
                                          <i class="bi bi-file-earmark text-primary me-2"></i>
                                          <span>${file.name}</span>
                                          <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeRiskControlEvidence('${assessmentKey}', '${file.id}')">
                                              <i class="bi bi-x"></i>
                                          </button>
                                      </div>
                                  `).join('')}
                              </div>
                          </div>
                      </div>
                  </div>
              `;
          }
          
          function getRiskSpecificEffectivenessExplanation(type, value, riskId) {
              const riskContext = getRiskById(riskId);
              
              const explanations = {
                  design: {
                      effective: `Control is well-designed to keep "${riskContext.title}" within acceptable risk appetite. Design provides adequate coverage and clear procedures.`,
                      partially: `Control design provides some mitigation for "${riskContext.title}" but may have gaps that prevent full risk containment within appetite.`,
                      ineffective: `Control design has significant flaws that fail to adequately address "${riskContext.title}" - risk likely exceeds appetite even with this control.`,
                      na: 'Control design assessment not applicable for this specific risk context.'
                  },
                  operational: {
                      effective: `Control operates effectively to maintain "${riskContext.title}" within risk appetite with consistent execution and minimal exceptions.`,
                      partially: `Control operation provides some risk mitigation for "${riskContext.title}" but operational gaps may allow risk to exceed appetite.`,
                      ineffective: `Control operation has significant issues that fail to contain "${riskContext.title}" within acceptable risk levels.`,
                      na: 'Control operational assessment not applicable for this specific risk context.'
                  }
              };
              
              return value ? explanations[type][value] : 'Select effectiveness rating to see risk-specific guidance: "Is this control adequate to keep this risk within appetite?"';
          }
          
          function getCEIScoreClass(score) {
              if (score >= 90) return 'excellent';
              if (score >= 80) return 'good';
              if (score >= 70) return 'fair';
              if (score > 0) return 'poor';
              return '';
          }
          
          function updateRiskControlEffectiveness(assessmentKey, type, value) {
              if (!assessmentData.riskControlEffectiveness[assessmentKey]) {
                  const [riskId, controlId] = assessmentKey.split('-');
                  assessmentData.riskControlEffectiveness[assessmentKey] = {
                      riskId: riskId,
                      controlId: controlId,
                      designEffectiveness: null,
                      operationalEffectiveness: null,
                      combinedScore: 0,
                      aiInsights: null,
                      evidenceFiles: [],
                      riskContext: null
                  };
              }
              
              const effectiveness = assessmentData.riskControlEffectiveness[assessmentKey];
              const [riskId, controlId] = assessmentKey.split('-');
              
              // Update the specific effectiveness type
              if (type === 'design') {
                  effectiveness.designEffectiveness = value;
              } else if (type === 'operational') {
                  effectiveness.operationalEffectiveness = value;
              }
              
              // Calculate combined score
              effectiveness.combinedScore = calculateCombinedEffectivenessScore(
                  effectiveness.designEffectiveness,
                  effectiveness.operationalEffectiveness
              );
              
              // Update UI elements
              updateRiskControlEffectivenessExplanation(assessmentKey, type, value, riskId);
              updateRiskControlCEIDisplay(assessmentKey, effectiveness.combinedScore);
              updateRiskControlCardAppearance(assessmentKey);
              updateCEIDashboard();
              
              // Save progress
              saveProgress();
              
              // Show feedback
              if (effectiveness.designEffectiveness && effectiveness.operationalEffectiveness) {
                  const controlName = getRiskControlName(assessmentKey);
                  const riskName = getRiskById(riskId).title;
                  showToast(`${controlName} assessment completed for "${riskName}" (${effectiveness.combinedScore}%)`, 'success');
              }
          }
          
          function calculateCombinedEffectivenessScore(design, operational) {
              const scoreMap = {
                  'effective': 100,
                  'partially': 75,
                  'ineffective': 25,
                  'na': null
              };
              
              const designScore = scoreMap[design];
              const operationalScore = scoreMap[operational];
              
              // If either is not applicable, use the other score
              if (designScore === null && operationalScore !== null) return operationalScore;
              if (operationalScore === null && designScore !== null) return designScore;
              if (designScore === null && operationalScore === null) return 0;
              
              // If both are assessed, take the lower score (conservative approach for banking)
              if (designScore !== null && operationalScore !== null) {
                  return Math.min(designScore, operationalScore);
              }
              
              return 0;
          }
          
          function updateRiskControlEffectivenessExplanation(assessmentKey, type, value, riskId) {
              const explanationElement = document.getElementById(`${type}-explanation-${assessmentKey}`);
              if (explanationElement) {
                  explanationElement.textContent = getRiskSpecificEffectivenessExplanation(type, value, riskId);
              }
          }
          
          function updateRiskControlCEIDisplay(assessmentKey, score) {
              const scoreElement = document.getElementById(`cei-score-${assessmentKey}`);
              if (scoreElement) {
                  scoreElement.textContent = score > 0 ? score + '%' : 'Not Assessed';
                  scoreElement.className = `control-cei-score ${getCEIScoreClass(score)}`;
              }
          }
          
          function updateRiskControlCardAppearance(assessmentKey) {
              const card = document.querySelector(`[data-assessment-key="${assessmentKey}"]`);
              const effectiveness = assessmentData.riskControlEffectiveness[assessmentKey];
              
              if (card && effectiveness) {
                  card.className = 'control-assessment-card';
                  
                  const hasFullAssessment = effectiveness.designEffectiveness && effectiveness.operationalEffectiveness;
                  const hasPartialAssessment = effectiveness.designEffectiveness || effectiveness.operationalEffectiveness;
                  
                  if (hasFullAssessment) {
                      card.classList.add('assessed');
                  } else if (hasPartialAssessment) {
                      card.classList.add('partial');
                  }
              }
          }
          
          function getRiskControlName(assessmentKey) {
              const [riskId, controlId] = assessmentKey.split('-');
              const riskControls = assessmentData.controlMappings[riskId] || [];
              const control = riskControls.find(c => c.id === controlId);
              return control ? control.title : 'Control';
          }
          
          function updateCEIDashboard() {
              // Use our simplified data structure
              const assessments = assessmentData.controlEffectiveness || {};
              let totalScore = 0;
              let assessedCount = 0;
              let designTotal = 0;
              let operationalTotal = 0;
              let totalPairings = 0;
              
              // Calculate totals from our simplified structure
              for (const assessmentKey in assessments) {
                  const assessment = assessments[assessmentKey];
                  totalPairings++;
                  
                  if (assessment.assessed && assessment.combinedScore) {
                      totalScore += assessment.combinedScore;
                      assessedCount++;
                  }
                  
                  if (assessment.designScore) {
                      designTotal += (assessment.designScore * 20); // Convert to percentage
                  }
                  
                  if (assessment.operationalScore) {
                      operationalTotal += (assessment.operationalScore * 20); // Convert to percentage
                  }
              }
              
              const overallCEI = assessedCount > 0 ? Math.round(totalScore / assessedCount) : 0;
              const avgDesign = assessedCount > 0 ? Math.round(designTotal / assessedCount) : 0;
              const avgOperational = assessedCount > 0 ? Math.round(operationalTotal / assessedCount) : 0;
              const progressPercentage = totalPairings > 0 ? Math.round((assessedCount / totalPairings) * 100) : 0;
              
              // Update CEI score display using our new IDs
              const ceiPercentage = document.getElementById('overall-cei');
              const ceiRating = document.getElementById('cei-rating');
              const ceiProgressFill = document.getElementById('cei-progress');
              const ceiCalculation = document.getElementById('cei-calculation');
              
              if (ceiPercentage) ceiPercentage.textContent = overallCEI > 0 ? overallCEI + '%' : '--';
              if (ceiRating) ceiRating.textContent = getCEIRating(overallCEI);
              if (ceiProgressFill) {
                  ceiProgressFill.style.width = overallCEI + '%';
                  ceiProgressFill.className = `cei-progress-fill ${getEffectivenessClass(overallCEI)}`;
              }
              if (ceiCalculation) {
                  if (assessedCount > 0) {
                      ceiCalculation.innerHTML = `
                          <strong>Methodology:</strong> Average of ${assessedCount} assessed risk-control pairings = ${overallCEI}%
                          <br><small class="text-muted">Banking Standard: CEI = MIN(Design, Operational) for each risk-control context</small>
                      `;
                  } else {
                      ceiCalculation.innerHTML = 'Complete risk-control assessments to calculate overall CEI';
                  }
              }
              
              // Update breakdown metrics using our new IDs
              const designAvgElement = document.getElementById('design-avg');
              const operationalAvgElement = document.getElementById('operational-avg');
              const assessedCountElement = document.getElementById('assessed-count');
              const coveragePctElement = document.getElementById('coverage-pct');
              
              if (designAvgElement) designAvgElement.textContent = avgDesign > 0 ? avgDesign + '%' : '--';
              if (operationalAvgElement) operationalAvgElement.textContent = avgOperational > 0 ? avgOperational + '%' : '--';
              if (assessedCountElement) assessedCountElement.textContent = assessedCount;
              if (coveragePctElement) coveragePctElement.textContent = progressPercentage + '%';
              
              // Update AI insights
              updateEffectivenessInsights(overallCEI, assessedCount, totalPairings);
          }
          
          function getCEIRating(score) {
              if (score >= 90) return 'Excellent';
              if (score >= 80) return 'Good';
              if (score >= 70) return 'Fair';
              if (score > 0) return 'Needs Improvement';
              return 'Not Assessed';
          }
          
          function updateEffectivenessInsights(overallCEI, assessedCount, totalControls) {
              const insightsContainer = document.getElementById('ai-insights-content');
              if (!insightsContainer) return;
              
              let insights = [];
              
              if (assessedCount === 0) {
                  insights.push({
                      icon: 'bi-lightbulb',
                      type: 'warning',
                      message: 'Complete control assessments to receive AI performance insights and recommendations.'
                  });
              } else if (assessedCount < totalControls) {
                  insights.push({
                      icon: 'bi-clock',
                      type: 'info',
                      message: `${assessedCount} of ${totalControls} controls assessed. Complete remaining assessments for full CEI calculation.`
                  });
              } else {
                  insights.push({
                      icon: 'bi-check-circle',
                      type: 'success',
                      message: `All ${totalControls} controls assessed. CEI calculation complete at ${overallCEI}%.`
                  });
              }
              
              // Add performance insights based on CEI score
              if (overallCEI >= 90) {
                  insights.push({
                      icon: 'bi-trophy',
                      type: 'success',
                      message: 'Excellent control effectiveness! Your controls provide strong risk mitigation.'
                  });
              } else if (overallCEI >= 80) {
                  insights.push({
                      icon: 'bi-shield-check',
                      type: 'success',
                      message: 'Good control effectiveness with room for optimization in specific areas.'
                  });
              } else if (overallCEI >= 70) {
                  insights.push({
                      icon: 'bi-exclamation-triangle',
                      type: 'warning',
                      message: 'Fair effectiveness - consider strengthening control design or operations.'
                  });
              } else if (overallCEI > 0) {
                  insights.push({
                      icon: 'bi-shield-x',
                      type: 'danger',
                      message: 'Low effectiveness detected - immediate attention required for control improvements.'
                  });
              }
              
              // Render insights
              insightsContainer.innerHTML = insights.map(insight => `
                  <div class="insight-item">
                      <i class="bi ${insight.icon} text-${insight.type}"></i>
                      <span>${insight.message}</span>
                  </div>
              `).join('');
          }
          
          function getControlNameById(controlId) {
              // Search through all risk mappings to find control name
              for (const riskId of assessmentData.selectedRisks) {
                  const controls = assessmentData.controlMappings[riskId] || [];
                  const control = controls.find(c => c.id === controlId);
                  if (control) return control.title;
              }
              return 'Control';
          }
          
          function simulateRiskControlEvidenceUpload(assessmentKey) {
              const [riskId, controlId] = assessmentKey.split('-');
              const riskData = getRiskById(riskId);
              
              const evidenceFiles = [
                  { id: 'ev1', name: `${riskData.title}_Control_Testing.pdf`, type: 'Risk-Specific Testing' },
                  { id: 'ev2', name: `${riskData.title}_Coverage_Analysis.xlsx`, type: 'Coverage Report' },
                  { id: 'ev3', name: `Control_Adequacy_Assessment_${riskId}.docx`, type: 'Adequacy Analysis' },
                  { id: 'ev4', name: `Risk_Appetite_Validation_${controlId}.log`, type: 'Appetite Testing' }
              ];
              
              const randomFile = evidenceFiles[Math.floor(Math.random() * evidenceFiles.length)];
              
              if (!assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles) {
                  assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles = [];
              }
              
              // Check if file already exists
              const existingFile = assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles.find(f => f.id === randomFile.id);
              if (existingFile) {
                  showToast('This evidence file is already attached', 'warning');
                  return;
              }
              
              assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles.push(randomFile);
              
              // Update UI
              updateRiskControlEvidenceDisplay(assessmentKey);
              saveProgress();
              showToast(`Evidence file "${randomFile.name}" uploaded successfully`, 'success');
          }
          
          function updateRiskControlEvidenceDisplay(assessmentKey) {
              const container = document.getElementById(`evidence-files-${assessmentKey}`);
              const evidenceFiles = assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles || [];
              
              if (container) {
                  container.innerHTML = evidenceFiles.map(file => `
                      <div class="evidence-file-item d-flex align-items-center justify-content-between p-2 border rounded mb-2">
                          <div class="d-flex align-items-center">
                              <i class="bi bi-file-earmark text-primary me-2"></i>
                              <div>
                                  <div class="fw-bold">${file.name}</div>
                                  <small class="text-muted">${file.type}</small>
                              </div>
                          </div>
                          <button class="btn btn-sm btn-outline-danger" onclick="removeRiskControlEvidence('${assessmentKey}', '${file.id}')">
                              <i class="bi bi-x"></i>
                          </button>
                      </div>
                  `).join('');
              }
          }
          
          function removeRiskControlEvidence(assessmentKey, fileId) {
              if (assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles) {
                  assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles = 
                      assessmentData.riskControlEffectiveness[assessmentKey].evidenceFiles.filter(f => f.id !== fileId);
                  
                  updateRiskControlEvidenceDisplay(assessmentKey);
                  saveProgress();
                  showToast('Evidence file removed', 'info');
              }
          }
          
          function generateEffectivenessInsights() {
              // Simulate AI analysis for all risk-control relationships
              const assessmentKeys = Object.keys(assessmentData.riskControlEffectiveness || {});
              
              if (assessmentKeys.length === 0) {
                  showToast('No risk-control assessments found for analysis', 'warning');
                  return;
              }
              
              showToast('Generating AI risk-control effectiveness analysis...', 'info');
              
              assessmentKeys.forEach((assessmentKey, index) => {
                  setTimeout(() => {
                      generateRiskControlAIInsights(assessmentKey);
                  }, (index + 1) * 500); // Stagger the analysis
              });
          }
          
          function generateRiskControlAIInsights(assessmentKey) {
              const effectiveness = assessmentData.riskControlEffectiveness[assessmentKey];
              if (!effectiveness || (!effectiveness.designEffectiveness && !effectiveness.operationalEffectiveness)) {
                  return; // Skip assessments without data
              }
              
              const [riskId, controlId] = assessmentKey.split('-');
              const riskData = getRiskById(riskId);
              
              // Generate realistic AI insights based on risk-control assessment context
              const insights = [
                  `Risk appetite analysis indicates this control maintains "${riskData.title}" within acceptable thresholds 94% of the time.`,
                  `Effectiveness testing shows this control reduces "${riskData.title}" impact by 78% when operating as designed.`,
                  `Benchmark analysis: this control-risk pairing performs 22% better than industry peer institutions.`,
                  `Risk scenario modeling confirms control adequacy for "${riskData.title}" under stress conditions.`,
                  `Exception review shows 3 instances where control didn't prevent risk materialization - recommend enhanced procedures.`,
                  `Coverage gap analysis identifies potential blind spots in addressing "${riskData.title}" - consider supplementary controls.`,
                  `Performance trending shows improving effectiveness for "${riskData.title}" mitigation over the last 6 months.`,
                  `Cost-benefit analysis confirms this control provides optimal risk reduction for "${riskData.title}" at current appetite levels.`
              ];
              
              const randomInsight = insights[Math.floor(Math.random() * insights.length)];
              effectiveness.aiInsights = randomInsight;
              
              // Update UI to show AI insights
              const analysisSection = document.querySelector(`[data-assessment-key="${assessmentKey}"] .ai-analysis-section`);
              if (!analysisSection) {
                  // Create AI analysis section if it doesn't exist
                  const interfaceDiv = document.querySelector(`[data-assessment-key="${assessmentKey}"] .assessment-interface`);
                  if (interfaceDiv) {
                      const aiSectionHTML = `
                          <div class="ai-analysis-section">
                              <div class="ai-analysis-header">
                                  <i class="bi bi-robot text-warning"></i>
                                  <h6 class="mb-0">AI Risk-Control Analysis</h6>
                              </div>
                              <div class="ai-analysis-content">
                                  ${randomInsight}
                              </div>
                          </div>
                      `;
                      interfaceDiv.insertAdjacentHTML('beforeend', aiSectionHTML);
                  }
              } else {
                  // Update existing analysis
                  const contentDiv = analysisSection.querySelector('.ai-analysis-content');
                  if (contentDiv) contentDiv.textContent = randomInsight;
              }
              
              saveProgress();
              
              const controlName = getRiskControlName(assessmentKey);
              showToast(`AI analysis completed for ${controlName} → ${riskData.title}`, 'success');
          }
          
          function assessAllControlsOptimal() {
              const assessmentKeys = Object.keys(assessmentData.riskControlEffectiveness || {});
              
              if (assessmentKeys.length === 0) {
                  showToast('No risk-control assessments found', 'warning');
                  return;
              }
              
              showToast('Applying AI optimal risk-control assessments...', 'info');
              
              // Apply optimal assessments based on risk-control context
              assessmentKeys.forEach(assessmentKey => {
                  const [riskId, controlId] = assessmentKey.split('-');
                  const riskData = getRiskById(riskId);
                  const controlDetails = assessmentData.controlMappings[riskId]?.find(c => c.id === controlId);
                  
                  if (controlDetails && riskData) {
                      // AI logic for optimal assessment based on risk context
                      let designRating = 'effective';
                      let operationalRating = 'effective';
                      
                      // High impact risks require more stringent control effectiveness
                      const isHighImpact = riskData.impact === 'High' || riskData.impact === 'Very High';
                      const isHighLikelihood = riskData.likelihood === 'High' || riskData.likelihood === 'Very High';
                      
                      // Manual controls more likely to have operational gaps for high-risk scenarios
                      if (!controlDetails.automated && (isHighImpact || isHighLikelihood) && Math.random() < 0.4) {
                          operationalRating = 'partially';
                      }
                      
                      // Preventive controls might have design challenges for complex risks
                      if (controlDetails.type === 'preventive' && isHighImpact && Math.random() < 0.3) {
                          designRating = 'partially';
                      }
                      
                      // Detective controls might be less effective for high-likelihood risks
                      if (controlDetails.type === 'detective' && isHighLikelihood && Math.random() < 0.25) {
                          designRating = 'partially';
                      }
                      
                      // Update assessments
                      updateRiskControlEffectiveness(assessmentKey, 'design', designRating);
                      updateRiskControlEffectiveness(assessmentKey, 'operational', operationalRating);
                      
                      // Update UI selects
                      const designSelect = document.getElementById(`design-${assessmentKey}`);
                      const operationalSelect = document.getElementById(`operational-${assessmentKey}`);
                      if (designSelect) designSelect.value = designRating;
                      if (operationalSelect) operationalSelect.value = operationalRating;
                  }
              });
              
              showToast(`AI optimal assessment applied to ${assessmentKeys.length} risk-control relationships`, 'success');
          }

          // ========================================
          // RESIDUAL RISK ASSESSMENT FUNCTIONS
          // ========================================

          // Initialize Residual Risk Assessment when entering Pane 5
          function initializeResidualRiskAssessment() {
              console.log('🔄 Initializing Residual Risk Assessment...');
              
              // Clear loading state
              const container = document.getElementById('residual-risk-container');
              if (!container) return;
              
              try {
                  // Get risks with their inherent scores and control effectiveness
                  const risksForAssessment = getResidualAssessmentData();
                  
                  if (risksForAssessment.length === 0) {
                      showEmptyResidualState();
                      return;
                  }
                  
                  // Generate dynamic residual assessment interface
                  container.innerHTML = generateResidualAssessmentHTML(risksForAssessment);
                  
                  // Initialize heat maps and calculations for each risk
                  risksForAssessment.forEach(risk => {
                      initializeRiskHeatMap(risk.id);
                      calculateAndDisplayAIResidual(risk.id);
                  });
                  
                  // Update progress counters
                  updateResidualProgressCounters();
                  
                  // Show summary card
                  document.getElementById('residual-summary-card').style.display = 'block';
                  
                  console.log('✅ Residual Risk Assessment initialized successfully');
                  
              } catch (error) {
                  console.error('❌ Error initializing residual risk assessment:', error);
                  showResidualError('Failed to initialize residual risk assessment');
              }
          }

          // Get assessment data with inherent scores and control effectiveness
          function getResidualAssessmentData() {
              const risks = [];
              
              try {
                  // Get selected risks from previous steps
                  if (assessmentData.selectedRisks && assessmentData.selectedRisks.length > 0) {
                      assessmentData.selectedRisks.forEach(riskId => {
                          const riskData = {
                              id: riskId,
                              title: (typeof getRiskName === 'function') ? getRiskName(riskId) : (riskId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())),
                              category: 'Operational Risk', // Default
                              inherentLikelihood: assessmentData.riskScores?.[riskId]?.likelihood || 4,
                              inherentImpact: assessmentData.riskScores?.[riskId]?.impact || 5,
                              inherentScore: (assessmentData.riskScores?.[riskId]?.likelihood || 4) * (assessmentData.riskScores?.[riskId]?.impact || 5),
                              controlsLinked: getLinkedControlsForRisk(riskId),
                              controlEffectiveness: getControlEffectivenessForRisk(riskId)
                          };
                          
                          risks.push(riskData);
                      });
                  } else {
                      // Fallback: Use default risks if no selected risks
                      console.log('⚠️ No selected risks found, using default data');
                      risks.push({
                          id: 'unauthorized-transfer',
                          title: 'Unauthorized Wire Transfer',
                          category: 'Operational Risk',
                          inherentLikelihood: 4,
                          inherentImpact: 5,
                          inherentScore: 20,
                          controlsLinked: [],
                          controlEffectiveness: { cei: 75, designRating: 3, operationalRating: 3 }
                      });
                  }
              } catch (error) {
                  console.error('❌ Error getting residual assessment data:', error);
                  // Return empty array to trigger empty state
              }
              
              return risks;
          }

          // Get linked controls for a specific risk
          function getLinkedControlsForRisk(riskId) {
              const linkedControls = [];
              
              // Get controls from the control mappings (array format from Phase 3)
              if (assessmentData.controlMappings?.[riskId] && Array.isArray(assessmentData.controlMappings[riskId])) {
                  linkedControls.push(...assessmentData.controlMappings[riskId]);
              } else if (assessmentData.controlMappings?.[riskId]) {
                  // Handle single control mapping format
                  const suggestions = getEnhancedAIControlSuggestions(riskId);
                  const controlData = suggestions.find(c => c.id === assessmentData.controlMappings[riskId]);
                  if (controlData) {
                      linkedControls.push(controlData);
                  }
              }
              
              return linkedControls;
          }

          // Get control effectiveness data for AI calculations
          function getControlEffectivenessForRisk(riskId) {
              const effectiveness = {
                  cei: 75, // Default
                  designRating: 3,
                  operationalRating: 3,
                  automationBonus: false,
                  preventiveWeight: 1.0,
                  coveragePercentage: 100
              };
              
              // Get actual effectiveness data from Phase 4 assessments
              if (assessmentData.controlEffectiveness) {
                  Object.keys(assessmentData.controlEffectiveness).forEach(key => {
                      if (key.includes(riskId)) {
                          const assessment = assessmentData.controlEffectiveness[key];
                          effectiveness.designRating = getEffectivenessScore(assessment.designEffectiveness);
                          effectiveness.operationalRating = getEffectivenessScore(assessment.operationalEffectiveness);
                          effectiveness.cei = Math.min(effectiveness.designRating, effectiveness.operationalRating) * 20; // Convert to percentage
                      }
                  });
              }
              
              return effectiveness;
          }

          // Convert effectiveness text to numeric score
          function getEffectivenessScore(effectiveness) {
              const scoreMap = {
                  'effective': 5,
                  'partially': 4,
                  'ineffective': 2,
                  'na': 3
              };
              return scoreMap[effectiveness] || 3;
          }

          // Generate HTML for residual assessment interface
          function generateResidualAssessmentHTML(risks) {
              let html = '<div class="residual-assessment-cards">';
              
              risks.forEach((risk, index) => {
                  html += generateResidualRiskCard(risk, index);
              });
              
              html += '</div>';
              return html;
          }

          // Generate individual risk assessment card
          function generateResidualRiskCard(risk, index) {
              const aiCalculated = calculateAIResidualScore(risk);
              const withinAppetite = aiCalculated.finalScore <= 15;
              
              return `
                  <div class="residual-assessment-card ${withinAppetite ? '' : 'high-risk'}" id="residual-card-${risk.id}" data-risk-id="${risk.id}">
                      <div class="residual-card-header">
                          <div class="residual-card-title">
                              <h5 class="residual-risk-title">${risk.title}</h5>
                              <div class="ai-calculated-badge" id="ai-badge-${risk.id}">
                                  <i class="bi bi-robot"></i>
                                  AI Calculated: ${aiCalculated.finalScore}
                              </div>
                          </div>
                          
                          <!-- Risk Context & Calculation Display -->
                          <div class="risk-calculation-display">
                              <div class="calculation-step">
                                  <span>Inherent Risk (L${risk.inherentLikelihood} × I${risk.inherentImpact}):</span>
                                  <span class="fw-bold">${risk.inherentScore}</span>
                              </div>
                              <div class="calculation-step">
                                  <span>Control Effectiveness Index (CEI):</span>
                                  <span class="fw-bold">${risk.controlEffectiveness.cei}%</span>
                              </div>
                              <div class="calculation-step">
                                  <span>Mitigation Factor (${aiCalculated.reductionRate}% reduction):</span>
                                  <span class="fw-bold">${aiCalculated.mitigationFactor.toFixed(2)}</span>
                              </div>
                              <div class="calculation-step">
                                  <span>AI Calculated Residual Risk:</span>
                                  <span class="fw-bold text-primary">${aiCalculated.finalScore}</span>
                              </div>
                          </div>
                      </div>
                      
                      <div class="card-body">
                          <div class="row">
                              <!-- Left Column: Heat Map -->
                              <div class="col-md-6">
                                  <div class="residual-heat-map-container">
                                      <h6 class="fw-semibold mb-3">
                                          <i class="bi bi-grid-3x3-gap text-primary me-2"></i>
                                          Residual Risk Heat Map
                                      </h6>
                                      
                                      <!-- 5x5 Heat Map with Perfect Alignment -->
                                      <div class="heat-map-wrapper">
                                          <!-- Impact axis container with title and labels -->
                                          <div class="impact-axis-container">
                                              <div class="impact-axis-title">Impact</div>
                                              <div class="impact-labels-container">
                                                  <div class="impact-label">Critical</div>
                                                  <div class="impact-label">Major</div>
                                                  <div class="impact-label">Moderate</div>
                                                  <div class="impact-label">Minor</div>
                                                  <div class="impact-label">Negligible</div>
                                              </div>
                                          </div>
                                          
                                          <!-- Heat map grid -->
                                          <div class="heat-map-grid-container">
                                              <div class="heat-map-grid" id="heat-map-${risk.id}"></div>
                                          </div>
                                          
                                          <!-- Likelihood axis (horizontal, below grid) -->
                                          <div class="likelihood-labels-container">
                                              <div class="likelihood-axis">
                                                  <small>Rare</small>
                                                  <small>Unlikely</small>
                                                  <small>Possible</small>
                                                  <small>Likely</small>
                                                  <small>Certain</small>
                                              </div>
                                              <div class="likelihood-axis">
                                                  <div class="axis-title">Likelihood</div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- Right Column: Assessment Summary & Override -->
                              <div class="col-md-6">
                                  <div class="assessment-summary">
                                      <h6 class="fw-semibold mb-3">Assessment Summary</h6>
                                      
                                      <div class="mb-3">
                                          <div class="metric-value text-primary" id="selected-score-${risk.id}">
                                              ${aiCalculated.finalScore}
                                          </div>
                                          <div class="metric-label">Selected Risk Score</div>
                                      </div>
                                      
                                      <div class="row mb-3">
                                          <div class="col-4">
                                              <div class="small text-muted">Likelihood</div>
                                              <div class="fw-semibold" id="selected-likelihood-${risk.id}">
                                                  ${aiCalculated.likelihood}
                                              </div>
                                          </div>
                                          <div class="col-4">
                                              <div class="small text-muted">Impact</div>
                                              <div class="fw-semibold" id="selected-impact-${risk.id}">
                                                  ${aiCalculated.impact}
                                              </div>
                                          </div>
                                          <div class="col-4">
                                              <div class="small text-muted">Risk Level</div>
                                              <div class="fw-semibold" id="selected-level-${risk.id}">
                                                  ${getRiskLevelName(aiCalculated.finalScore)}
                                              </div>
                                          </div>
                                      </div>
                                      
                                      <!-- Risk Appetite Status -->
                                      <div class="risk-appetite-indicator ${withinAppetite ? 'within' : 'exceeds'}" id="appetite-${risk.id}">
                                          <i class="bi bi-${withinAppetite ? 'shield-check' : 'exclamation-triangle'}"></i>
                                          <div>
                                              <div class="fw-semibold">${withinAppetite ? 'Within' : 'Exceeds'} Risk Appetite</div>
                                              <div class="small">Threshold: ≤15 | Current: ${aiCalculated.finalScore}</div>
                                          </div>
                                      </div>
                                      
                                      <!-- AI Insights -->
                                      <div class="alert alert-info mt-3">
                                          <i class="bi bi-lightbulb me-2"></i>
                                          <strong>AI Insight:</strong> ${aiCalculated.insight}
                                      </div>
                                  </div>
                              </div>
                          </div>
                          
                          <!-- Override Section -->
                          <div class="override-section">
                              <div class="override-toggle">
                                  <input type="checkbox" id="override-${risk.id}" class="form-check-input" 
                                         onchange="toggleOverride('${risk.id}')">
                                  <label for="override-${risk.id}" class="form-check-label fw-semibold">
                                      Override AI Calculation
                                  </label>
                                  <span class="text-muted ms-2">(Select different heat map cell to override)</span>
                              </div>
                              
                              <div class="override-rationale" id="override-rationale-${risk.id}">
                                  <label for="override-reason-${risk.id}" class="form-label">
                                      <strong>Override Justification</strong> <span class="text-danger">*</span>
                                  </label>
                                  <textarea class="form-control" id="override-reason-${risk.id}" rows="3" 
                                            placeholder="Provide detailed justification for overriding the AI calculation..."
                                            onchange="updateOverrideReason('${risk.id}', this.value)"></textarea>
                                  <div class="form-text">Minimum 50 characters required</div>
                              </div>
                          </div>
                      </div>
                      
                      <!-- Assessment Actions -->
                      <div class="assessment-actions">
                          <div class="assessment-status" id="status-${risk.id}">
                              <i class="bi bi-circle text-warning me-2"></i>
                              <span class="text-muted">AI calculation ready for review</span>
                          </div>
                          <div class="action-buttons">
                              <button class="btn btn-outline-primary me-2" onclick="acceptAICalculation('${risk.id}')">
                                  <i class="bi bi-check me-1"></i>Accept AI Calculation
                              </button>
                              <button class="btn btn-primary" onclick="saveResidualAssessment('${risk.id}')" id="save-${risk.id}">
                                  <i class="bi bi-floppy me-1"></i>Save Assessment
                              </button>
                          </div>
                      </div>
                  </div>
              `;
          }

          // Calculate AI residual score with transparent logic
          function calculateAIResidualScore(risk) {
              const inherentScore = risk.inherentScore;
              const cei = risk.controlEffectiveness.cei;
              
              // Determine reduction rate based on CEI
              let reductionRate;
              if (cei >= 90) reductionRate = 70; // Excellent controls
              else if (cei >= 80) reductionRate = 60; // Strong controls  
              else if (cei >= 70) reductionRate = 45; // Good controls
              else if (cei >= 60) reductionRate = 30; // Fair controls
              else reductionRate = 15; // Poor controls
              
              // Apply mitigation factor
              const mitigationFactor = 1 - (reductionRate / 100);
              const reducedScore = Math.max(1, Math.round(inherentScore * mitigationFactor));
              
              // Convert back to likelihood and impact (approximate)
              const finalScore = Math.min(25, reducedScore);
              const likelihood = Math.min(5, Math.max(1, Math.ceil(Math.sqrt(finalScore))));
              const impact = Math.min(5, Math.max(1, Math.ceil(finalScore / likelihood)));
              
              // Generate insight based on calculation
              let insight;
              if (finalScore <= 5) {
                  insight = `Strong controls have effectively mitigated this risk to an acceptable level. Continue current control activities.`;
              } else if (finalScore <= 10) {
                  insight = `Controls provide good mitigation. Monitor for control degradation and consider minor enhancements.`;
              } else if (finalScore <= 15) {
                  insight = `Risk is at the edge of appetite. Consider strengthening controls or implementing additional measures.`;
              } else {
                  insight = `Risk exceeds appetite even with current controls. Immediate action required to strengthen mitigation.`;
              }
              
              return {
                  finalScore,
                  likelihood,
                  impact,
                  reductionRate,
                  mitigationFactor,
                  insight
              };
          }

          // Initialize heat map for specific risk
          function initializeRiskHeatMap(riskId) {
              const grid = document.getElementById(`heat-map-${riskId}`);
              if (!grid) return;
              
              grid.innerHTML = '';
              
              // Create 25 cells (5x5 grid)
              for (let impact = 5; impact >= 1; impact--) {
                  for (let likelihood = 1; likelihood <= 5; likelihood++) {
                      const score = likelihood * impact;
                      const cell = document.createElement('div');
                      
                      cell.className = `heat-map-cell risk-${score}`;
                      cell.dataset.likelihood = likelihood;
                      cell.dataset.impact = impact;
                      cell.dataset.score = score;
                      cell.dataset.riskId = riskId;
                      cell.textContent = score;
                      cell.title = `Likelihood: ${likelihood}, Impact: ${impact}, Score: ${score}`;
                      
                      cell.addEventListener('click', () => selectResidualScore(riskId, likelihood, impact, score));
                      
                      grid.appendChild(cell);
                  }
              }
              
              // Highlight AI recommendation
              highlightAIRecommendation(riskId);
          }

          // Highlight AI recommended cell
          function highlightAIRecommendation(riskId) {
              const risk = getResidualAssessmentData().find(r => r.id === riskId);
              if (!risk) return;
              
              const aiCalculated = calculateAIResidualScore(risk);
              const grid = document.getElementById(`heat-map-${riskId}`);
              if (!grid) return;
              
              // Find and highlight the recommended cell
              const recommendedCell = grid.querySelector(`[data-score="${aiCalculated.finalScore}"]`);
              if (recommendedCell) {
                  recommendedCell.classList.add('ai-recommended');
              }
          }

          // Handle heat map cell selection
          function selectResidualScore(riskId, likelihood, impact, score) {
              console.log(`📊 Selected residual score for ${riskId}: L${likelihood} × I${impact} = ${score}`);
              
              // Update visual selection
              const grid = document.getElementById(`heat-map-${riskId}`);
              if (grid) {
                  grid.querySelectorAll('.selected').forEach(cell => cell.classList.remove('selected'));
                  const selectedCell = grid.querySelector(`[data-likelihood="${likelihood}"][data-impact="${impact}"]`);
                  if (selectedCell) selectedCell.classList.add('selected');
              }
              
              // Store assessment data
              if (!assessmentData.residualAssessments) assessmentData.residualAssessments = {};
              assessmentData.residualAssessments[riskId] = {
                  likelihood,
                  impact,
                  score,
                  timestamp: new Date().toISOString(),
                  isOverride: true
              };
              
              // Update displays
              updateResidualDisplays(riskId, likelihood, impact, score);
              
              // Enable override mode automatically when user selects different cell
              document.getElementById(`override-${riskId}`).checked = true;
              toggleOverride(riskId);
              
              // Update progress
              updateResidualProgressCounters();
              updateResidualSummary();
          }

          // Update display elements for selected risk
          function updateResidualDisplays(riskId, likelihood, impact, score) {
              document.getElementById(`selected-score-${riskId}`).textContent = score;
              document.getElementById(`selected-likelihood-${riskId}`).textContent = likelihood;
              document.getElementById(`selected-impact-${riskId}`).textContent = impact;
              document.getElementById(`selected-level-${riskId}`).textContent = getRiskLevelName(score);
              
              // Update risk appetite status
              const withinAppetite = score <= 15;
              const appetiteEl = document.getElementById(`appetite-${riskId}`);
              if (appetiteEl) {
                  appetiteEl.className = `risk-appetite-indicator ${withinAppetite ? 'within' : 'exceeds'}`;
                  appetiteEl.innerHTML = `
                      <i class="bi bi-${withinAppetite ? 'shield-check' : 'exclamation-triangle'}"></i>
                      <div>
                          <div class="fw-semibold">${withinAppetite ? 'Within' : 'Exceeds'} Risk Appetite</div>
                          <div class="small">Threshold: ≤15 | Current: ${score}</div>
                      </div>
                  `;
              }
              
              // Update card styling for high risk
              const card = document.getElementById(`residual-card-${riskId}`);
              if (card) {
                  card.classList.toggle('high-risk', !withinAppetite);
              }
          }

          // Get risk level name from score
          function getRiskLevelName(score) {
              if (score <= 5) return 'Low';
              if (score <= 10) return 'Medium-Low';
              if (score <= 15) return 'Medium';
              if (score <= 20) return 'High';
              return 'Critical';
          }

          // Toggle override mode
          function toggleOverride(riskId) {
              const checkbox = document.getElementById(`override-${riskId}`);
              const rationaleSection = document.getElementById(`override-rationale-${riskId}`);
              
              if (checkbox.checked) {
                  rationaleSection.classList.add('active');
              } else {
                  rationaleSection.classList.remove('active');
                  // Clear override rationale
                  document.getElementById(`override-reason-${riskId}`).value = '';
              }
          }

          // Accept AI calculation (non-override)
          function acceptAICalculation(riskId) {
              const risk = getResidualAssessmentData().find(r => r.id === riskId);
              if (!risk) return;
              
              const aiCalculated = calculateAIResidualScore(risk);
              
              // Store assessment as accepted AI calculation
              if (!assessmentData.residualAssessments) assessmentData.residualAssessments = {};
              assessmentData.residualAssessments[riskId] = {
                  likelihood: aiCalculated.likelihood,
                  impact: aiCalculated.impact,
                  score: aiCalculated.finalScore,
                  timestamp: new Date().toISOString(),
                  isOverride: false,
                  acceptedAI: true
              };
              
              // Update visual selection
              selectResidualScore(riskId, aiCalculated.likelihood, aiCalculated.impact, aiCalculated.finalScore);
              
              // Uncheck override
              document.getElementById(`override-${riskId}`).checked = false;
              toggleOverride(riskId);
              
              // Update status
              const statusEl = document.getElementById(`status-${riskId}`);
              if (statusEl) {
                  statusEl.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i><span class="text-success">AI calculation accepted</span>';
              }
              
              showToast(`AI calculation accepted for ${risk.title}`, 'success');
          }

          // Save individual residual assessment
          function saveResidualAssessment(riskId) {
              const assessment = assessmentData.residualAssessments?.[riskId];
              if (!assessment) {
                  showToast('Please select a risk score first', 'warning');
                  return;
              }
              
              // Validate override rationale if needed
              const isOverride = document.getElementById(`override-${riskId}`).checked;
              if (isOverride) {
                  const rationale = document.getElementById(`override-reason-${riskId}`).value;
                  if (rationale.length < 50) {
                      showToast('Override justification must be at least 50 characters', 'error');
                      return;
                  }
                  assessment.overrideReason = rationale;
              }
              
              // Mark as saved
              assessment.saved = true;
              assessment.savedTimestamp = new Date().toISOString();
              
              // Update status
              const statusEl = document.getElementById(`status-${riskId}`);
              if (statusEl) {
                  statusEl.innerHTML = '<i class="bi bi-check-circle text-success me-2"></i><span class="text-success">Assessment saved</span>';
              }
              
              // Update save button
              const saveBtn = document.getElementById(`save-${riskId}`);
              if (saveBtn) {
                  saveBtn.innerHTML = '<i class="bi bi-check me-1"></i>Saved';
                  saveBtn.classList.remove('btn-primary');
                  saveBtn.classList.add('btn-success');
              }
              
              // Update progress
              updateResidualProgressCounters();
              updateResidualSummary();
              
              showToast(`Residual assessment saved successfully`, 'success');
          }

          // Calculate and display AI residual for initial load
          function calculateAndDisplayAIResidual(riskId) {
              const risk = getResidualAssessmentData().find(r => r.id === riskId);
              if (!risk) return;
              
              const aiCalculated = calculateAIResidualScore(risk);
              
              // Auto-select AI calculation initially
              selectResidualScore(riskId, aiCalculated.likelihood, aiCalculated.impact, aiCalculated.finalScore);
              
              // Store as AI recommendation (not override)
              if (assessmentData.residualAssessments?.[riskId]) {
                  assessmentData.residualAssessments[riskId].isOverride = false;
                  assessmentData.residualAssessments[riskId].acceptedAI = true;
              }
          }

          // Update progress counters
          function updateResidualProgressCounters() {
              const totalRisks = getResidualAssessmentData().length;
              const completedRisks = Object.keys(assessmentData.residualAssessments || {}).filter(
                  riskId => assessmentData.residualAssessments[riskId].saved
              ).length;
              
              document.getElementById('residual-total-count').textContent = totalRisks;
              document.getElementById('residual-completed-count').textContent = completedRisks;
          }

          // Update overall residual summary
          function updateResidualSummary() {
              const assessments = Object.values(assessmentData.residualAssessments || {});
              
              let lowCount = 0, mediumCount = 0, highCount = 0;
              let totalReduction = 0;
              
              assessments.forEach(assessment => {
                  if (assessment.score <= 5) lowCount++;
                  else if (assessment.score <= 15) mediumCount++;
                  else highCount++;
                  
                  // Calculate reduction from inherent (placeholder logic)
                  totalReduction += 30; // Average 30% reduction
              });
              
              const avgReduction = assessments.length > 0 ? Math.round(totalReduction / assessments.length) : 0;
              
              document.getElementById('low-risk-count').textContent = lowCount;
              document.getElementById('medium-risk-count').textContent = mediumCount;
              document.getElementById('high-risk-count').textContent = highCount;
              document.getElementById('avg-reduction').textContent = avgReduction + '%';
              
              // Update appetite status
              const appetiteEl = document.getElementById('appetite-status');
              if (appetiteEl) {
                  if (highCount === 0) {
                      appetiteEl.className = 'alert alert-success mb-0';
                      appetiteEl.innerHTML = `
                          <i class="bi bi-shield-check me-2"></i>
                          <strong>Within Risk Appetite</strong><br>
                          <small>All risks below threshold (≤15)</small>
                      `;
                  } else {
                      appetiteEl.className = 'alert alert-danger mb-0';
                      appetiteEl.innerHTML = `
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          <strong>Risks Exceed Appetite</strong><br>
                          <small>${highCount} risk(s) require immediate attention</small>
                      `;
                  }
              }
          }

          // Show detailed calculation modal
          function showDetailedCalculationModal() {
              // Create modal for detailed calculations
              const modalHTML = `
                  <div class="modal fade" id="calculationModal" tabindex="-1">
                      <div class="modal-dialog modal-lg">
                          <div class="modal-content">
                              <div class="modal-header">
                                  <h5 class="modal-title">
                                      <i class="bi bi-calculator me-2"></i>
                                      Detailed AI Calculation Logic
                                  </h5>
                                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                  <h6>Residual Risk Formula</h6>
                                  <div class="calculation-formula mb-4">
                                      <code class="bg-light p-3 rounded d-block">
                                          Residual_Score = Inherent_Score × (1 - (CEI × Quality_Factors))
                                      </code>
                                  </div>
                                  
                                  <h6>Control Effectiveness Index (CEI) Calculation</h6>
                                  <p>CEI = MIN(Design_Effectiveness, Operational_Effectiveness) × 20</p>
                                  <ul>
                                      <li><strong>Effective:</strong> 5 points (100%)</li>
                                      <li><strong>Partially Effective:</strong> 4 points (80%)</li>
                                      <li><strong>Ineffective:</strong> 2 points (40%)</li>
                                      <li><strong>Not Applicable:</strong> 3 points (60%)</li>
                                  </ul>
                                  
                                  <h6>Quality Factor Adjustments</h6>
                                  <ul>
                                      <li><strong>Preventive Controls:</strong> +15% mitigation effectiveness</li>
                                      <li><strong>Automated Controls:</strong> +10% reliability bonus</li>
                                      <li><strong>Multiple Controls:</strong> +5% diversification benefit</li>
                                      <li><strong>Coverage < 100%:</strong> Proportional reduction</li>
                                  </ul>
                                  
                                  <h6>Banking Industry Standards</h6>
                                  <p>This calculation methodology aligns with:</p>
                                  <ul>
                                      <li>Basel III Operational Risk Framework</li>
                                      <li>COSO Enterprise Risk Management</li>
                                      <li>Federal Reserve SR 11-7 Guidance</li>
                                  </ul>
                              </div>
                              <div class="modal-footer">
                                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              </div>
                          </div>
                      </div>
                  </div>
              `;
              
              // Add modal to DOM if not exists
              if (!document.getElementById('calculationModal')) {
                  document.body.insertAdjacentHTML('beforeend', modalHTML);
              }
              
              // Show modal
              const modal = new bootstrap.Modal(document.getElementById('calculationModal'));
              modal.show();
          }

          // Show empty state
          function showEmptyResidualState() {
              const container = document.getElementById('residual-risk-container');
              if (container) {
                  container.innerHTML = `
                      <div class="text-center py-5">
                          <i class="bi bi-calculator display-1 text-muted mb-4"></i>
                          <h4 class="text-muted">No Risks Available</h4>
                          <p class="text-muted mb-4">
                              No risks were found for residual assessment. Please complete the previous steps first.
                          </p>
                          <button class="btn btn-primary" onclick="previousStep()">
                              <i class="bi bi-arrow-left me-2"></i>Return to Previous Step
                          </button>
                      </div>
                  `;
              }
          }

          // Show error state
          function showResidualError(message) {
              const container = document.getElementById('residual-risk-container');
              if (container) {
                  container.innerHTML = `
                      <div class="alert alert-danger">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          <strong>Error:</strong> ${message}
                      </div>
                  `;
              }
          }

          // Update override reason
          function updateOverrideReason(riskId, reason) {
              if (assessmentData.residualAssessments?.[riskId]) {
                  assessmentData.residualAssessments[riskId].overrideReason = reason;
              }
          }

          // Hook into existing step transition to initialize residual assessment
          const originalGoToStep = goToStep;
          goToStep = function(stepNumber) {
              originalGoToStep(stepNumber);
              
              // Initialize residual assessment when entering Pane 5
              if (stepNumber === 5) {
                  setTimeout(() => initializeResidualRiskAssessment(), 100);
              }
          };

          // Hook into nextStep function
          const originalNextStep = nextStep;
          nextStep = function() {
              // Initialize residual assessment when entering Pane 5
              if (currentStep === 4) {
                  originalNextStep();
                  setTimeout(() => initializeResidualRiskAssessment(), 100);
              } else if (currentStep === 5) {
                  // Initialize risk response planning when entering Pane 6
                  originalNextStep();
                  setTimeout(() => initializeRiskResponsePlanning(), 100);
              } else {
                  originalNextStep();
              }
          };

          // =================================================================
          // RISK RESPONSE PLANNING FUNCTIONS (PANE 6)
          // =================================================================

          // Response strategy definitions
          const responseStrategies = {
              accept: {
                  id: 'accept',
                  title: 'Accept Risk',
                  icon: '✓',
                  description: 'Accept the current risk level with existing controls. Monitor regularly.',
                  costRange: '$0 - $5K',
                  timeframe: 'Immediate',
                  effectiveness: '0% reduction',
                  suitableFor: 'Low risks within appetite'
              },
              monitor: {
                  id: 'monitor',
                  title: 'Enhanced Monitoring',
                  icon: '👁',
                  description: 'Implement additional monitoring and reporting without changing controls.',
                  costRange: '$5K - $25K',
                  timeframe: '30 days',
                  effectiveness: '10-20% reduction',
                  suitableFor: 'Medium risks, compliance focus'
              },
              enhance: {
                  id: 'enhance',
                  title: 'Enhance Controls',
                  icon: '🔧',
                  description: 'Strengthen existing controls or implement additional mitigation measures.',
                  costRange: '$25K - $100K',
                  timeframe: '90 days',
                  effectiveness: '30-60% reduction',
                  suitableFor: 'High risks, control gaps'
              },
              transfer: {
                  id: 'transfer',
                  title: 'Transfer Risk',
                  icon: '🔄',
                  description: 'Transfer risk through insurance, outsourcing, or contractual arrangements.',
                  costRange: '$10K - $50K annually',
                  timeframe: '60 days',
                  effectiveness: '70-90% reduction',
                  suitableFor: 'High-impact, insurable risks'
              }
          };

          // Risk response data structure
          let riskResponseData = {
              strategies: {},
              actionItems: {},
              timeline: {
                  immediate: 0,
                  shortTerm: 0,
                  longTerm: 0
              }
          };

          // Initialize Risk Response Planning pane
          function initializeRiskResponsePlanning() {
              console.log('🎯 Initializing Risk Response Planning...');
              
              try {
                  // Load residual risk assessments
                  const residualRisks = getResidualRiskAssessments();
                  
                  if (residualRisks.length === 0) {
                      displayNoResidualRisksMessage();
                      return;
                  }
                  
                  // Generate response cards for each risk
                  generateRiskResponseCards(residualRisks);
                  
                  // Generate AI recommendations
                  generateAIResponseRecommendations(residualRisks);
                  
                  // Update summary displays
                  updateResponseSummary();
                  
                  // Check risk appetite violations
                  checkRiskAppetiteViolations(residualRisks);
                  
                  console.log('✅ Risk Response Planning initialized successfully');
                  
              } catch (error) {
                  console.error('❌ Error initializing Risk Response Planning:', error);
                  showToast('Failed to initialize response planning. Please try again.', 'error');
              }
          }

          // Get residual risk assessments from previous panes
          function getResidualRiskAssessments() {
              const residualRisks = [];
              
              // Get risks from residual assessment data
              if (assessmentData.residualAssessments) {
                  Object.keys(assessmentData.residualAssessments).forEach(riskId => {
                      const residualData = assessmentData.residualAssessments[riskId];
                      const riskInfo = getRiskById(riskId);
                      
                      if (riskInfo && residualData.riskScore) {
                          residualRisks.push({
                              id: riskId,
                              title: riskInfo.title,
                              description: riskInfo.description,
                              category: riskInfo.category,
                              inherentScore: riskInfo.likelihood * riskInfo.impact,
                              residualScore: residualData.riskScore,
                              likelihood: residualData.likelihood,
                              impact: residualData.impact,
                              rationale: residualData.rationale,
                              exceedsAppetite: residualData.riskScore > 15
                          });
                      }
                  });
              }
              
              return residualRisks;
          }

          // Generate response cards for each risk
          function generateRiskResponseCards(risks) {
              const container = document.getElementById('risk-response-container');
              
              let html = '<div class="risk-response-cards">';
              
              risks.forEach((risk, index) => {
                  html += generateRiskResponseCard(risk, index);
              });
              
              html += '</div>';
              
              container.innerHTML = html;
          }

          // Generate individual risk response card
          function generateRiskResponseCard(risk, index) {
              const recommendedStrategy = getAIRecommendedStrategy(risk);
              const currentStrategy = riskResponseData.strategies[risk.id];
              
              return `
                  <div class="risk-response-card" id="response-card-${risk.id}">
                      <div class="risk-response-header">
                          <div class="risk-response-title">
                              <h5 class="mb-0">${risk.title}</h5>
                              <span class="response-risk-score ${getRiskScoreClass(risk.residualScore)}">
                                  Score: ${risk.residualScore}
                              </span>
                          </div>
                          <div class="risk-meta-info">
                              <span><strong>Category:</strong> ${risk.category}</span>
                              <span><strong>Likelihood:</strong> ${risk.likelihood}</span>
                              <span><strong>Impact:</strong> ${risk.impact}</span>
                              ${risk.exceedsAppetite ? '<span class="text-danger"><strong>⚠ Exceeds Appetite</strong></span>' : ''}
                          </div>
                      </div>
                      
                      <div class="response-strategies">
                          <h6 class="mb-3">
                              <i class="bi bi-lightbulb text-warning me-2"></i>
                              Select Response Strategy
                          </h6>
                          
                          <div class="strategy-grid">
                              ${Object.values(responseStrategies).map(strategy => `
                                  <div class="strategy-option ${strategy.id === recommendedStrategy ? 'ai-recommended' : ''} ${currentStrategy === strategy.id ? 'selected' : ''}"
                                       onclick="selectResponseStrategy('${risk.id}', '${strategy.id}')">
                                      <div class="strategy-icon ${strategy.id}">
                                          ${strategy.icon}
                                      </div>
                                      <div class="strategy-title">${strategy.title}</div>
                                      <div class="strategy-description">${strategy.description}</div>
                                      <div class="strategy-metrics">
                                          <div class="metric-item">
                                              <div class="metric-label">Cost</div>
                                              <div class="metric-value">${strategy.costRange}</div>
                                          </div>
                                          <div class="metric-item">
                                              <div class="metric-label">Timeline</div>
                                              <div class="metric-value">${strategy.timeframe}</div>
                                          </div>
                                          <div class="metric-item">
                                              <div class="metric-label">Reduction</div>
                                              <div class="metric-value">${strategy.effectiveness}</div>
                                          </div>
                                      </div>
                                  </div>
                              `).join('')}
                          </div>
                          
                          <!-- AI Insights -->
                          <div class="ai-response-insights">
                              <div class="ai-insights-header">
                                  <i class="bi bi-robot text-primary"></i>
                                  <h6 class="mb-0">AI Strategy Analysis</h6>
                              </div>
                              <div class="ai-insights-content" id="ai-insights-${risk.id}">
                                  ${generateAIInsights(risk, recommendedStrategy)}
                              </div>
                          </div>
                          
                          <!-- Action Items (shown when strategy selected) -->
                          <div class="action-items-panel" id="action-items-${risk.id}" style="display: none;">
                              <div class="action-items-header">
                                  <h6 class="mb-0">
                                      <i class="bi bi-list-task text-success me-2"></i>
                                      Recommended Action Items
                                  </h6>
                              </div>
                              <div class="action-items-list" id="action-list-${risk.id}">
                                  <!-- Populated when strategy selected -->
                              </div>
                          </div>
                      </div>
                  </div>
              `;
          }

          // Get AI recommended strategy based on risk characteristics
          function getAIRecommendedStrategy(risk) {
              // AI logic for strategy recommendation
              if (risk.residualScore <= 5) {
                  return 'accept';
              } else if (risk.residualScore <= 10) {
                  return 'monitor';
              } else if (risk.residualScore <= 18) {
                  return 'enhance';
              } else {
                  return 'transfer';
              }
          }

          // Generate AI insights for risk-strategy combination
          function generateAIInsights(risk, recommendedStrategy) {
              const insights = {
                  accept: `Based on the residual score of ${risk.residualScore}, this risk appears to be within acceptable limits. Regular monitoring is sufficient.`,
                  monitor: `This risk level suggests enhanced monitoring would be appropriate. Consider implementing automated alerts and more frequent reviews.`,
                  enhance: `The residual score of ${risk.residualScore} indicates existing controls may need strengthening. Focus on ${(risk.category || 'operational').toLowerCase()} control improvements.`,
                  transfer: `High residual score of ${risk.residualScore} suggests risk transfer options. Consider insurance coverage or outsourcing arrangements.`
              };
              
              let insight = insights[recommendedStrategy];
              
              // Add risk-specific context
              if (risk.exceedsAppetite) {
                  insight += ' <strong>Priority:</strong> This risk exceeds your organization\'s risk appetite threshold and requires immediate attention.';
              }
              
              return insight;
          }

          // Select response strategy for a risk
          function selectResponseStrategy(riskId, strategyId) {
              console.log(`🎯 Selecting strategy ${strategyId} for risk ${riskId}`);
              
              try {
                  // Update data
                  riskResponseData.strategies[riskId] = strategyId;
                  
                  // Update UI - remove previous selections
                  const card = document.getElementById(`response-card-${riskId}`);
                  const options = card.querySelectorAll('.strategy-option');
                  options.forEach(option => option.classList.remove('selected'));
                  
                  // Add selection to clicked option
                  const selectedOption = card.querySelector(`[onclick*="${strategyId}"]`);
                  if (selectedOption) {
                      selectedOption.classList.add('selected');
                  }
                  
                  // Add visual feedback to card
                  card.classList.add('strategy-selected');
                  
                  // Generate action items for selected strategy
                  generateActionItems(riskId, strategyId);
                  
                  // Update summary displays
                  updateResponseSummary();
                  
                  // Show success feedback
                  showToast(`Response strategy "${responseStrategies[strategyId].title}" selected for risk`, 'success');
                  
              } catch (error) {
                  console.error('❌ Error selecting response strategy:', error);
                  showToast('Failed to select strategy. Please try again.', 'error');
              }
          }

          // Generate action items for selected strategy
          function generateActionItems(riskId, strategyId) {
              const actionItemsPanel = document.getElementById(`action-items-${riskId}`);
              const actionList = document.getElementById(`action-list-${riskId}`);
              
              const actionTemplates = {
                  accept: [
                      { text: 'Document risk acceptance decision with rationale', timeline: 'immediate' },
                      { text: 'Establish quarterly risk monitoring schedule', timeline: 'short-term' },
                      { text: 'Set up automated risk threshold alerts', timeline: 'short-term' }
                  ],
                  monitor: [
                      { text: 'Implement enhanced monitoring dashboards', timeline: 'short-term' },
                      { text: 'Establish weekly risk reporting process', timeline: 'short-term' },
                      { text: 'Train staff on escalation procedures', timeline: 'long-term' }
                  ],
                  enhance: [
                      { text: 'Conduct detailed control gap analysis', timeline: 'immediate' },
                      { text: 'Design and implement control enhancements', timeline: 'long-term' },
                      { text: 'Test enhanced control effectiveness', timeline: 'long-term' }
                  ],
                  transfer: [
                      { text: 'Research insurance coverage options', timeline: 'immediate' },
                      { text: 'Negotiate transfer agreements', timeline: 'short-term' },
                      { text: 'Implement risk transfer mechanisms', timeline: 'long-term' }
                  ]
              };
              
              const actions = actionTemplates[strategyId] || [];
              
              let html = '';
              actions.forEach((action, index) => {
                  html += `
                      <div class="action-item">
                          <div class="action-text">${action.text}</div>
                          <div class="action-timeline ${action.timeline}">${getTimelineLabel(action.timeline)}</div>
                      </div>
                  `;
              });
              
              actionList.innerHTML = html;
              actionItemsPanel.style.display = 'block';
              
              // Store action items
              riskResponseData.actionItems[riskId] = actions;
          }

          // Get timeline label
          function getTimelineLabel(timeline) {
              const labels = {
                  immediate: 'Immediate',
                  'short-term': '30 days',
                  'long-term': '90 days'
              };
              return labels[timeline] || timeline;
          }

          // Update response summary displays
          function updateResponseSummary() {
              // Update strategy counts
              const strategyCounts = {
                  accept: 0,
                  monitor: 0,
                  enhance: 0,
                  transfer: 0
              };
              
              Object.values(riskResponseData.strategies).forEach(strategy => {
                  if (strategyCounts.hasOwnProperty(strategy)) {
                      strategyCounts[strategy]++;
                  }
              });
              
              // Update stat displays
              document.getElementById('accept-count').textContent = strategyCounts.accept;
              document.getElementById('enhance-count').textContent = strategyCounts.enhance;
              
              // Update strategy chart
              updateStrategyChart(strategyCounts);
              
              // Update timeline summary
              updateTimelineSummary();
          }

          // Update strategy distribution chart
          function updateStrategyChart(counts) {
              const chartContainer = document.getElementById('strategy-chart');
              const total = Object.values(counts).reduce((sum, count) => sum + count, 0);
              
              if (total === 0) {
                  chartContainer.innerHTML = '<p class="text-muted text-center">Select response strategies to see distribution</p>';
                  return;
              }
              
              let html = '';
              Object.entries(counts).forEach(([strategy, count]) => {
                  const percentage = total > 0 ? (count / total) * 100 : 0;
                  html += `
                      <div class="strategy-bar">
                          <div class="strategy-bar-label">${responseStrategies[strategy].title}</div>
                          <div class="strategy-bar-fill">
                              <div class="strategy-bar-progress ${strategy}" style="width: ${percentage}%"></div>
                              <div class="strategy-bar-count">${count}</div>
                          </div>
                      </div>
                  `;
              });
              
              chartContainer.innerHTML = html;
          }

          // Check for risk appetite violations
          function checkRiskAppetiteViolations(risks) {
              const violatingRisks = risks.filter(risk => risk.exceedsAppetite);
              const alertElement = document.getElementById('appetite-violation-alert');
              
              if (violatingRisks.length > 0) {
                  alertElement.style.display = 'block';
              } else {
                  alertElement.style.display = 'none';
              }
          }

          // Generate AI response recommendations
          function generateAIResponseRecommendations(risks) {
              // This would contain more sophisticated AI logic
              console.log('🤖 Generating AI response recommendations for', risks.length, 'risks');
          }

          // Display message when no residual risks found
          function displayNoResidualRisksMessage() {
              const container = document.getElementById('risk-response-container');
              container.innerHTML = `
                  <div class="text-center py-5">
                      <div class="mb-4">
                          <i class="bi bi-inbox display-1 text-muted"></i>
                      </div>
                      <h3 class="text-muted">No Residual Risk Assessments Found</h3>
                      <p class="text-muted mb-4">
                          Please complete the residual risk assessment before proceeding to response planning.
                      </p>
                      <button class="btn btn-primary" onclick="goToStep(5)">
                          <i class="bi bi-arrow-left me-2"></i>Return to Residual Assessment
                      </button>
                  </div>
              `;
          }

          // Get risk score CSS class
          function getRiskScoreClass(score) {
              if (score >= 20) return 'critical';
              if (score >= 16) return 'high';
              if (score >= 11) return 'medium';
              return 'low';
          }

          // Generate action plan document
          function generateActionPlan() {
              console.log('📋 Generating comprehensive action plan...');
              
              try {
                  const risks = getResidualRiskAssessments();
                  const strategies = riskResponseData.strategies;
                  const actionItems = riskResponseData.actionItems;
                  
                  // Build action plan content
                  let actionPlan = generateActionPlanContent(risks, strategies, actionItems);
                  
                  // Show action plan modal or download
                  showActionPlanModal(actionPlan);
                  
                  showToast('Action plan generated successfully!', 'success');
                  
              } catch (error) {
                  console.error('❌ Error generating action plan:', error);
                  showToast('Failed to generate action plan. Please try again.', 'error');
              }
          }

          // Export response summary
          function exportResponseSummary() {
              console.log('📤 Exporting response summary...');
              
              try {
                  const summary = generateResponseSummary();
                  
                  // Create downloadable content
                  const blob = new Blob([summary], { type: 'text/plain' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = 'risk-response-summary.txt';
                  a.click();
                  
                  showToast('Response summary exported successfully!', 'success');
                  
              } catch (error) {
                  console.error('❌ Error exporting summary:', error);
                  showToast('Failed to export summary. Please try again.', 'error');
              }
          }

          // Generate action plan content
          function generateActionPlanContent(risks, strategies, actionItems) {
              let content = `
RISK RESPONSE ACTION PLAN
Generated: ${new Date().toLocaleDateString()}
Process: ${assessmentData.processName || 'Wire Transfer Process'}
Business Unit: ${assessmentData.businessUnit || 'Retail Banking'}

=================================================================================
EXECUTIVE SUMMARY
=================================================================================

Total Risks Assessed: ${risks.length}
Risks Exceeding Appetite: ${risks.filter(r => r.exceedsAppetite).length}

Response Strategy Distribution:
`;
              
              const strategyCounts = {};
              Object.values(strategies).forEach(strategy => {
                  strategyCounts[strategy] = (strategyCounts[strategy] || 0) + 1;
              });
              
              Object.entries(strategyCounts).forEach(([strategy, count]) => {
                  content += `- ${responseStrategies[strategy].title}: ${count} risks\n`;
              });
              
              content += `

=================================================================================
DETAILED RISK RESPONSES
=================================================================================

`;
              
              risks.forEach(risk => {
                  const strategy = strategies[risk.id];
                  const actions = actionItems[risk.id] || [];
                  
                  content += `
RISK: ${risk.title}
Category: ${risk.category}
Residual Score: ${risk.residualScore}
Selected Strategy: ${strategy ? responseStrategies[strategy].title : 'Not Selected'}

Action Items:
`;
                  actions.forEach((action, index) => {
                      content += `${index + 1}. ${action.text} (${getTimelineLabel(action.timeline)})\n`;
                  });
                  
                  content += '\n---\n';
              });
              
              return content;
          }

          // Generate response summary for export
          function generateResponseSummary() {
              const risks = getResidualRiskAssessments();
              
              return `Risk Response Summary - ${new Date().toLocaleDateString()}\n\n` +
                     `Process: ${assessmentData.processName || 'Wire Transfer Process'}\n` +
                     `Total Risks: ${risks.length}\n` +
                     `Response Strategies Selected: ${Object.keys(riskResponseData.strategies).length}\n` +
                     `Action Items Generated: ${Object.values(riskResponseData.actionItems).flat().length}\n`;
          }

          // Show action plan in modal
          function showActionPlanModal(content) {
              const modal = document.createElement('div');
              modal.className = 'modal fade';
              modal.innerHTML = `
                  <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                          <div class="modal-header">
                              <h5 class="modal-title">Risk Response Action Plan</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <pre style="white-space: pre-wrap; font-size: 0.875rem;">${content}</pre>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="button" class="btn btn-primary" onclick="downloadActionPlan('${content.replace(/'/g, '\\\'').replace(/\n/g, '\\n')}')">
                                  <i class="bi bi-download me-2"></i>Download
                              </button>
                          </div>
                      </div>
                  </div>
              `;
              
              document.body.appendChild(modal);
              const bootstrapModal = new bootstrap.Modal(modal);
              bootstrapModal.show();
              
              // Clean up when modal is hidden
              modal.addEventListener('hidden.bs.modal', () => {
                  document.body.removeChild(modal);
              });
          }

                     // Download action plan
          function downloadActionPlan(content) {
              const blob = new Blob([content], { type: 'text/plain' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'risk-response-action-plan.txt';
              a.click();
              URL.revokeObjectURL(url);
          }

          // Update timeline summary helper function
          function updateTimelineSummary() {
              let counts = { immediate: 0, shortTerm: 0, longTerm: 0 };
              
              Object.values(riskResponseData.actionItems).forEach(actions => {
                  actions.forEach(action => {
                      if (action.timeline === 'immediate') counts.immediate++;
                      else if (action.timeline === 'short-term') counts.shortTerm++;
                      else if (action.timeline === 'long-term') counts.longTerm++;
                  });
              });
              
              const immediateEl = document.getElementById('immediate-actions');
              const shortTermEl = document.getElementById('short-term-actions');
              const longTermEl = document.getElementById('long-term-actions');
              
              if (immediateEl) immediateEl.textContent = counts.immediate;
              if (shortTermEl) shortTermEl.textContent = counts.shortTerm;
              if (longTermEl) longTermEl.textContent = counts.longTerm;
          }

          // Demo helper functions for testing
          function quickSelectAllRecommendedStrategies() {
              console.log('🎯 Quick selecting all AI recommended strategies...');
              
              const risks = getResidualRiskAssessments();
              let count = 0;
              
              risks.forEach(risk => {
                  const recommendedStrategy = getAIRecommendedStrategy(risk);
                  setTimeout(() => {
                      selectResponseStrategy(risk.id, recommendedStrategy);
                  }, count * 500); // Stagger selections for visual effect
                  count++;
              });
              
              showToast(`Selecting recommended strategies for ${risks.length} risks...`, 'info');
          }

          // Add sample response data for demo purposes
          function addSampleResponseData() {
              console.log('📝 Adding sample response data for demo...');
              
              // Get current residual risks
              const risks = getResidualRiskAssessments();
              
              if (risks.length === 0) {
                  showToast('No residual risks found. Complete previous steps first.', 'warning');
                  return;
              }
              
              // Select strategies for each risk
              risks.forEach((risk, index) => {
                  const strategies = ['accept', 'monitor', 'enhance', 'transfer'];
                  let selectedStrategy;
                  
                  // Logic based on risk score
                  if (risk.residualScore <= 5) selectedStrategy = 'accept';
                  else if (risk.residualScore <= 10) selectedStrategy = 'monitor';
                  else if (risk.residualScore <= 18) selectedStrategy = 'enhance';
                  else selectedStrategy = 'transfer';
                  
                  setTimeout(() => {
                      selectResponseStrategy(risk.id, selectedStrategy);
                  }, index * 300);
              });
              
              showToast('Sample response strategies applied!', 'success');
          }
    </script>
</body>
</html>
  