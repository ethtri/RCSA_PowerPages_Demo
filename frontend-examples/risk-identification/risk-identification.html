<!-- Risk Identification V2 - Clean Implementation -->
<!-- Using Power Pages Native Patterns -->

<!-- CSRF Token for Web API -->
{% if user %}
  <input type="hidden" name="__RequestVerificationToken" value="{{ request.verification_token }}" />
{% endif %}

<!-- Include Bootstrap 5 and Modern Enhancements -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- jQuery for Web API calls (usually included by Power Pages, but adding to be safe) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Include Web API Wrapper -->
{% include 'Portal Web API Wrapper' %}

<!-- Fallback Web API Implementation (in case template doesn't load) -->
<script>
// Check if Web API wrapper loaded successfully
console.log('üîç Checking Web API wrapper availability...');
console.log('üîç webapi object:', typeof webapi !== 'undefined' ? webapi : 'undefined');
console.log('üîç webapi.safeAjax:', typeof webapi !== 'undefined' && webapi.safeAjax ? 'available' : 'missing');
console.log('üîç shell object:', typeof shell !== 'undefined' ? shell : 'undefined');
console.log('üîç shell.getTokenDeferred:', typeof shell !== 'undefined' && shell.getTokenDeferred ? 'available' : 'missing');

// Fallback Web API implementation if the template didn't load
if (typeof webapi === 'undefined' || !webapi.safeAjax) {
  console.warn('üîÑ Web API wrapper not loaded, creating fallback implementation...');
  
  window.webapi = window.webapi || {};
  
  window.webapi.safeAjax = function(options) {
    var deferred = $.Deferred();
    
    // Use Power Pages' built-in token management
    if (typeof shell !== 'undefined' && shell.getTokenDeferred) {
      shell.getTokenDeferred().done(function(token) {
        options.headers = options.headers || {};
        options.headers["__RequestVerificationToken"] = token;
        console.log('‚úÖ Using shell.getTokenDeferred token for Web API call');
        $.ajax(options).done(deferred.resolve).fail(deferred.reject);
      }).fail(function(error) {
        console.error('‚ùå Failed to get token from shell.getTokenDeferred:', error);
        deferred.reject(error);
      });
    } else {
      // Fallback for when shell is not available
      console.warn('‚ö†Ô∏è shell.getTokenDeferred not available, using fallback token method');
      options.headers = options.headers || {};
      var token = $('input[name="__RequestVerificationToken"]').val();
      if (token) {
        options.headers["__RequestVerificationToken"] = token;
        console.log('‚úÖ Using fallback token for Web API call');
      } else {
        console.error('‚ùå No token found for Web API call');
      }
      $.ajax(options).done(deferred.resolve).fail(deferred.reject);
    }
    
    return deferred.promise();
  };
  
  // Convenience methods
  window.webapi.create = function(entitySetName, data, options) {
    return window.webapi.safeAjax($.extend({
      url: '/_api/' + entitySetName,
      type: 'POST',
      contentType: 'application/json; charset=utf-8',
      headers: {
        'OData-Version': '4.0',
        'Prefer': 'return=representation'
      },
      data: JSON.stringify(data)
    }, options));
  };
  
  window.webapi.update = function(entitySetName, id, data, options) {
    return window.webapi.safeAjax($.extend({
      url: '/_api/' + entitySetName + '(' + id + ')',
      type: 'PATCH',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify(data),
      headers: {
        'If-Match': '*'
      }
    }, options));
  };
  
  window.webapi.delete = function(entitySetName, id, options) {
    return window.webapi.safeAjax($.extend({
      url: '/_api/' + entitySetName + '(' + id + ')',
      type: 'DELETE',
      headers: {
        'If-Match': '*'
      }
    }, options));
  };
  
  console.log('‚úÖ Fallback Web API wrapper created successfully');
}
</script>

<style>
  /* CapTech Design System Variables */
  :root {
    --captech-primary: #0066CC;
    --captech-secondary: #004499;
    --captech-success: #28a745;
    --captech-warning: #ffc107;
    --captech-danger: #dc3545;
    --captech-light: #f8f9fa;
    --captech-dark: #343a40;
    --captech-gray-100: #f8f9fa;
    --captech-gray-200: #e9ecef;
    --captech-gray-300: #dee2e6;
    --captech-gray-600: #6c757d;
    --captech-gray-700: #495057;
    --captech-gray-800: #343a40;
    --captech-gray-900: #212529;
  }

  /* Page Header */
  .risk-header {
    background: linear-gradient(135deg, var(--captech-primary) 0%, var(--captech-secondary) 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 2rem;
  }

  /* Process Context Bar */
  .process-context {
    background: var(--captech-light);
    border: 1px solid var(--captech-gray-300);
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
  }

  /* Section Cards */
  .section-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    overflow: hidden;
  }

  .section-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .section-header.existing {
    background: linear-gradient(45deg, #0d6efd, #6610f2);
    color: white;
    border-bottom: none;
  }

  .section-header.ai {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    border-bottom: none;
  }

  .section-header.custom {
    background: linear-gradient(45deg, #ffc107, #fd7e14);
    color: white;
    border-bottom: none;
  }

  .section-body {
    padding: 2rem;
  }

  /* Risk Cards */
  .risk-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    position: relative;
  }

  .risk-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .risk-category-badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .risk-category-operational { background: #e3f2fd; color: #1565c0; }
  .risk-category-technology { background: #f3e5f5; color: #7b1fa2; }
  .risk-category-fraud { background: #ffebee; color: #c62828; }
  .risk-category-compliance { background: #e8f5e8; color: #2e7d32; }
  .risk-category-credit { background: #fff3e0; color: #ef6c00; }

  /* AI Suggestion Cards */
  .ai-risk-card {
    background: #f8fff9;
    border: 2px solid #e8f5e8;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }

  .ai-risk-card.accepted {
    border-color: #28a745;
    background: #e8f5e8;
  }

  .ai-risk-card.rejected {
    opacity: 0.5;
    border-color: #dc3545;
  }

  /* Loading Animation */
  .ai-loading {
    text-align: center;
    padding: 3rem;
  }

  .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
  }

  /* Empty States */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  /* Debug Panel */
  .debug-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 2rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
  }

  /* Edit Form Styling */
  .edit-form {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .edit-form .form-control,
  .edit-form .form-select {
    font-size: 0.9rem;
  }

  .edit-form .form-label {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
  }
</style>

<div class="container-fluid">
  <!-- Page Header -->
  <div class="risk-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1 class="display-5 fw-bold mb-2">Risk Identification</h1>
          <p class="lead mb-0">AI-powered risk discovery with Dataverse integration</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="bg-white bg-opacity-25 rounded-pill px-3 py-1 d-inline-block">
            <i class="fas fa-list-ol me-2"></i>
            Step 2 of 4
          </div>
          <div class="h5 mt-2 mb-0">Risk Identification</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Process Context Bar -->
    <div class="process-context">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="mb-1">Selected Process</h5>
          <div class="d-flex align-items-center gap-3">
            <span class="fw-bold" id="selectedProcessName">Loading...</span>
            <span class="text-muted">|</span>
            <span>Business Unit: <span id="selectedBusinessUnit">Loading...</span></span>
          </div>
        </div>
        <div class="col-md-4 text-md-end">
          <a href="/Process-Selection" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Change Process
          </a>
        </div>
      </div>
    </div>

    <!-- FetchXML Query for Existing Risks -->
    {% comment %} 
    FetchXML query to get ALL active risks, then filter by process in JavaScript
    This avoids the complex parameter passing issues
    {% endcomment %}
    
    {% fetchxml existingRisks %}
      <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
        <entity name="cr129_risk">
          <attribute name="cr129_riskid" />
          <attribute name="cr129_risktitle" />
          <attribute name="cr129_riskcategory" />
          <attribute name="cr129_description" />
          <attribute name="cr129_inherentlikelihood" />
          <attribute name="cr129_inherentimpact" />
          <attribute name="cr129_processname" />
          <attribute name="modifiedon" />
          <filter type="and">
            <condition attribute="statecode" operator="eq" value="0" />
          </filter>
          <order attribute="cr129_risktitle" descending="false" />
        </entity>
      </fetch>
    {% endfetchxml %}

    <!-- Store FetchXML results in hidden divs (like original page) -->
    <div id="allRisksData" style="display: none;">
      {% for risk in existingRisks.results.entities %}
        <div class="risk-data" 
             data-risk-id="{{ risk.cr129_riskid }}"
             data-risk-title="{{ risk.cr129_risktitle | escape }}"
             data-risk-category="{{ risk.cr129_riskcategory.label | default: 'Operational' | escape }}"
             data-risk-category-value="{{ risk.cr129_riskcategory.value | default: '100000000' }}"
             data-risk-description="{{ risk.cr129_description | default: 'No description available' | escape }}"
             data-risk-likelihood="{{ risk.cr129_inherentlikelihood | default: '' }}"
             data-risk-impact="{{ risk.cr129_inherentimpact | default: '' }}"
             data-risk-modified="{{ risk.modifiedon | date: '%Y-%m-%d' | default: '' }}"
             data-process-id="{{ risk.cr129_processname.id | default: '' }}"
             data-process-name="{{ risk.cr129_processname.name | default: 'Unknown Process' | escape }}">
        </div>
      {% endfor %}
    </div>
    
    <script>
      // Parse risks from hidden divs (more reliable than JavaScript arrays)
      window.dataverseRisks = [];
      document.querySelectorAll('#allRisksData .risk-data').forEach(element => {
        const risk = {
          id: element.dataset.riskId,
          title: element.dataset.riskTitle,
          category: element.dataset.riskCategory,
          categoryValue: element.dataset.riskCategoryValue,
          description: element.dataset.riskDescription,
          likelihood: parseInt(element.dataset.riskLikelihood) || 3,
          impact: parseInt(element.dataset.riskImpact) || 3,
          modifiedOn: element.dataset.riskModified,
          processId: element.dataset.processId,
          processName: element.dataset.processName
        };
        window.dataverseRisks.push(risk);
      });
      console.log('Loaded ' + window.dataverseRisks.length + ' risks from Dataverse');
    </script>

    <!-- Section 1: Existing Risks from Dataverse -->
    <div class="section-card">
      <div class="section-header existing">
        <div>
          <h3 class="h4 mb-0">
            <i class="bi bi-database me-2"></i>Existing Risks
          </h3>
          <p class="mb-0 opacity-75">Risks already identified for this process</p>
        </div>
        <span class="badge bg-white text-primary" id="existingRiskCount">Loading...</span>
      </div>
      <div class="section-body">
        <div id="existingRisksContainer">
          <!-- This will be populated by the entity list -->
          {% comment %} 
          Note: In production, we would use an entity list here:
          {% entitylist id: 'risk-list-id' %}{% endentitylist %}
          For now, we'll use FetchXML and render manually
          {% endcomment %}
          
          <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 2: AI Risk Suggestions -->
    <div class="section-card">
      <div class="section-header ai">
        <div>
          <h3 class="h4 mb-0">
            <i class="bi bi-magic me-2"></i>AI Risk Suggestions
          </h3>
          <p class="mb-0 opacity-75">Powered by OpenAI</p>
        </div>
        <button class="btn btn-white btn-sm" onclick="loadAISuggestions()">
          <i class="bi bi-arrow-clockwise me-1"></i>Refresh
        </button>
      </div>
      <div class="section-body">
        <div id="aiSuggestionsContainer">
          <div class="ai-loading">
            <div class="spinner-border text-success mb-3" role="status">
              <span class="visually-hidden">Loading AI suggestions...</span>
            </div>
            <p class="text-muted">Analyzing process for potential risks...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3: Add Custom Risk -->
    <div class="section-card">
      <div class="section-header custom">
        <div>
          <h3 class="h4 mb-0">
            <i class="bi bi-plus-circle me-2"></i>Custom Risks
          </h3>
          <p class="mb-0 opacity-75">Manually identify additional risks</p>
        </div>
        <button type="button" class="btn btn-white btn-sm" onclick="showAddRiskModal(); return false;">
          <i class="bi bi-plus-circle me-1"></i>Add New Risk
        </button>
      </div>
      <div class="section-body">
        <div id="customRisksContainer">
          <div class="empty-state">
            <i class="bi bi-plus-circle text-muted"></i>
            <h5 class="mt-3">No Custom Risks Added</h5>
            <p class="text-muted">Click "Add New Risk" in the section header to create custom risks for this process.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Continue Button -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <a href="/Process-Selection" class="btn btn-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back
          </a>
          <button type="button" id="continueBtn" class="btn btn-primary btn-lg" onclick="continueToControlMapping()">
            Continue to Control Mapping
            <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Risk Modal with Direct Form -->
<div class="modal fade" id="editRiskModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Risk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Direct form rendering - no iframe needed -->
        <div id="editRiskFormContainer">
          <!-- Form will be loaded here when modal opens -->
          {% comment %} 
          Note: In production, you would render the form here:
          {% entityform id: "4037ea60-e65d-f011-bec1-7c1e521687a7" %}
          
          For now, we'll use inline editing or Web API
          {% endcomment %}
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading form...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Risk Modal -->
<div class="modal fade" id="addRiskModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Risk</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addRiskForm" novalidate>
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="newRiskTitle" class="form-label">Risk Title *</label>
                <input type="text" class="form-control" id="newRiskTitle" name="newRiskTitle" 
                       placeholder="Enter a clear, descriptive risk title">
                <div class="invalid-feedback" id="newRiskTitle-error"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="newRiskCategory" class="form-label">Category *</label>
                <select class="form-select" id="newRiskCategory" name="newRiskCategory">
                  <option value="">Select category...</option>
                  <option value="0">Operational</option>
                  <option value="1">Fraud</option>
                  <option value="2">Technology</option>
                  <option value="3">Credit</option>
                  <option value="4">Compliance</option>
                </select>
                <div class="invalid-feedback" id="newRiskCategory-error"></div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="newRiskDescription" class="form-label">Description *</label>
            <textarea class="form-control" id="newRiskDescription" name="newRiskDescription" rows="3"
                      placeholder="Describe the risk, its potential causes, and impact"></textarea>
            <div class="invalid-feedback" id="newRiskDescription-error"></div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newRiskLikelihood" class="form-label">Likelihood (1-5) *</label>
                <select class="form-select" id="newRiskLikelihood" name="newRiskLikelihood">
                  <option value="">Select likelihood...</option>
                  <option value="1">1 - Very Low (0-5%)</option>
                  <option value="2">2 - Low (6-25%)</option>
                  <option value="3">3 - Medium (26-50%)</option>
                  <option value="4">4 - High (51-75%)</option>
                  <option value="5">5 - Very High (76-100%)</option>
                </select>
                <div class="invalid-feedback" id="newRiskLikelihood-error"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="newRiskImpact" class="form-label">Impact (1-5) *</label>
                <select class="form-select" id="newRiskImpact" name="newRiskImpact">
                  <option value="">Select impact...</option>
                  <option value="1">1 - Very Low (Minimal)</option>
                  <option value="2">2 - Low (Minor)</option>
                  <option value="3">3 - Medium (Moderate)</option>
                  <option value="4">4 - High (Major)</option>
                  <option value="5">5 - Very High (Severe)</option>
                </select>
                <div class="invalid-feedback" id="newRiskImpact-error"></div>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Note:</strong> This risk will be associated with the selected process: 
            <span id="modalProcessName" class="fw-bold"></span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveNewRisk()">
          <i class="bi bi-check-circle me-1"></i>Add Risk
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Clean up session storage to ensure proper source tagging
function cleanupSessionStorage() {
  const existingRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  let needsUpdate = false;
  
  const cleanedRisks = existingRisks.map(risk => {
    if (!risk.source) {
      needsUpdate = true;
      // If it has isCustom: true, it's a custom risk
      if (risk.isCustom) {
        return { ...risk, source: 'custom' };
      }
      // Otherwise, it's likely an existing risk that was stored
      else {
        return { ...risk, source: 'existing' };
      }
    }
    return risk;
  });
  
  if (needsUpdate) {
    console.log('üßπ Cleaning up session storage - adding source tags to', existingRisks.length, 'risks');
    sessionStorage.setItem('rcsa_custom_risks', JSON.stringify(cleanedRisks));
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Risk Identification V2 loaded - Starting diagnostic');
  
  // Diagnostic information
  console.log('üîç Dataverse risks available:', window.dataverseRisks ? window.dataverseRisks.length : 'undefined');
  console.log('üîç Session storage process:', sessionStorage.getItem('rcsa_selected_process_name'));
  console.log('üîç Page URL:', window.location.href);
  
  // Clean up session storage first
  cleanupSessionStorage();
  
  // Add global error handler to catch any errors that might cause page refresh
  window.addEventListener('error', function(e) {
    console.error('üö® Global error caught:', e.error);
    console.error('üö® Error details:', e.message, e.filename, e.lineno, e.colno);
  });
  
  // Prevent any form submissions that might cause page refresh
  document.addEventListener('submit', function(e) {
    console.log('üö® Form submission intercepted:', e.target);
    e.preventDefault();
    return false;
  });
  
  // Load process context from session storage
  loadProcessContext();
  
  // Load existing risks
  console.log('üìã Starting to load existing risks...');
  loadExistingRisks();
  
  // Load custom risks
  console.log('üìã Starting to load custom risks...');
  loadCustomRisks();
  
  // Load AI suggestions after a delay
  console.log('ü§ñ Scheduling AI suggestions...');
  setTimeout(() => {
    console.log('ü§ñ Loading AI suggestions now...');
    loadAISuggestions();
  }, 2000);
  
  console.log('‚úÖ Risk Identification V2 initialization complete');
});

// Global variable to store custom risks
window.customRisks = [];

// Test function to check modal availability
window.testModal = function() {
  console.log('üß™ Testing modal availability...');
  console.log('üîç Modal element:', document.getElementById('addRiskModal'));
  console.log('üîç Form element:', document.getElementById('addRiskForm'));
  console.log('üîç Bootstrap available?', typeof bootstrap !== 'undefined');
  console.log('üîç Modal HTML:', document.getElementById('addRiskModal')?.outerHTML.substring(0, 200) + '...');
  
  const modalElement = document.getElementById('addRiskModal');
  if (modalElement) {
    console.log('‚úÖ Modal found, attempting to show...');
    try {
      if (typeof bootstrap !== 'undefined') {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('‚úÖ Bootstrap modal opened');
      } else {
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        console.log('‚úÖ Manual modal opened');
      }
    } catch (error) {
      console.error('‚ùå Error opening modal:', error);
    }
  } else {
    console.error('‚ùå Modal element not found');
  }
};

// Load process context from session storage
function loadProcessContext() {
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  const processName = sessionStorage.getItem('rcsa_selected_process_name');
  const businessUnit = sessionStorage.getItem('rcsa_selected_business_unit');
  
  console.log('üîç Process context:', { processId, processName, businessUnit });
  
  if (processName) {
    document.getElementById('selectedProcessName').textContent = processName;
    document.getElementById('selectedBusinessUnit').textContent = businessUnit || 'Not specified';
  } else {
    // No process selected, redirect back
    console.warn('‚ö†Ô∏è No process selected, redirecting to Process Selection');
    window.location.href = '/Process-Selection';
  }
}

// Get mock risks for a specific process (for demo purposes when no Dataverse data)
function getMockRisksForProcess(processId) {
  const mockData = {
    // Use actual process IDs or names that might be in the system
    'default': [
      {
        id: 'mock-1',
        title: 'Operational Risk - System Downtime',
        category: 'operational',
        description: 'Risk of system unavailability affecting business operations',
        likelihood: 3,
        impact: 4,
        processId: processId,
        source: 'mock'
      },
      {
        id: 'mock-2', 
        title: 'Compliance Risk - Regulatory Changes',
        category: 'compliance',
        description: 'Risk of non-compliance due to evolving regulatory requirements',
        likelihood: 2,
        impact: 3,
        processId: processId,
        source: 'mock'
      }
    ]
  };
  
  // Return default mock data for any process
  return mockData['default'] || [];
}

// Load existing risks from Dataverse
function loadExistingRisks() {
  const container = document.getElementById('existingRisksContainer');
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  
  console.log('üîç Loading risks for process:', processId);
  console.log('üîç All Dataverse risks available:', window.dataverseRisks ? window.dataverseRisks.length : 0);
  
  // Filter risks by selected process
  let risks = [];
  if (window.dataverseRisks && window.dataverseRisks.length > 0) {
    // Filter by process ID - handle both direct ID match and lookup reference match
    risks = window.dataverseRisks.filter(risk => {
      // Try multiple matching strategies
      const directMatch = risk.processId === processId;
      const nameMatch = risk.processName === processId; 
      const lookupMatch = risk['cr129_processname.id'] === processId;
      const matches = directMatch || nameMatch || lookupMatch;
      
      if (matches) {
        console.log(`‚úÖ Risk "${risk.title}" matches process "${processId}"`);
      }
      return matches;
    });
    console.log('üîç Filtered risks for process:', risks.length);
  }
  
  // If no Dataverse data available, show realistic mock data
  if (!window.dataverseRisks || window.dataverseRisks.length === 0) {
    console.log('üìã No Dataverse data available, using mock data for demo');
    risks = getMockRisksForProcess(processId);
  }
  
  // If filtered to 0 but we have Dataverse data, the process might not have risks yet
  if (risks.length === 0 && window.dataverseRisks && window.dataverseRisks.length > 0) {
    console.log('üìã No risks found for this specific process in Dataverse');
  }
  
  // Simulate loading delay for better UX
  setTimeout(() => {
    if (risks.length > 0) {
      container.innerHTML = risks.map(risk => {
        // Map category values to display names
        const categoryMap = {
          'operational': 'operational',
          'technology': 'technology',
          'fraud': 'fraud',
          'compliance': 'compliance',
          'credit': 'credit',
          '100000000': 'operational',
          '100000001': 'technology',
          '100000002': 'fraud',
          '100000003': 'compliance',
          '100000004': 'credit'
        };
        
        const categoryDisplay = categoryMap[risk.categoryValue] || categoryMap[risk.category] || 'operational';
        
        return `
          <div class="risk-card">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="h6 mb-0">${risk.title}</h5>
              <span class="risk-category-badge risk-category-${categoryDisplay}">
                ${risk.category || categoryDisplay}
              </span>
            </div>
            <p class="text-muted small mb-2">${risk.description}</p>
            <div class="d-flex justify-content-between align-items-center">
              <div class="small">
                <span class="me-3">Likelihood: ${risk.likelihood}/5</span>
                <span>Impact: ${risk.impact}/5</span>
              </div>
              <button class="btn btn-outline-primary btn-sm" onclick="editRisk('${risk.id}')">
                <i class="bi bi-pencil me-1"></i>Edit
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      document.getElementById('existingRiskCount').textContent = risks.length;
      
      // Show data source in debug
      if (window.dataverseRisks && window.dataverseRisks.length > 0) {
        console.log('‚úÖ Displaying real Dataverse risks');
      } else {
        console.log('üìå Displaying mock risks (no Dataverse data found)');
      }
    } else {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-inbox text-muted"></i>
          <h5 class="mt-3">No Existing Risks</h5>
          <p class="text-muted">No risks have been previously identified for this process.</p>
        </div>
      `;
      document.getElementById('existingRiskCount').textContent = '0';
    }
  }, 1000);
}

// Load AI suggestions (mock implementation)
function loadAISuggestions() {
  const container = document.getElementById('aiSuggestionsContainer');
  const processName = sessionStorage.getItem('rcsa_selected_process_name') || 'Selected Process';
  
  console.log('ü§ñ Generating AI suggestions for process:', processName);
  
  // Simulate AI processing
  setTimeout(() => {
    const suggestions = [
      {
        id: 'ai-1',
        title: 'Data Security Breach',
        category: 'technology',
        description: `Risk of unauthorized access to sensitive data in ${processName}`,
        likelihood: 2,
        impact: 4,
        rationale: 'AI analysis indicates elevated cybersecurity risks in this process type'
      },
      {
        id: 'ai-2',
        title: 'Process Automation Failure',
        category: 'operational',
        description: `Risk of automated systems failing during ${processName} execution`,
        likelihood: 3,
        impact: 3,
        rationale: 'Machine learning models predict potential system integration points of failure'
      },
      {
        id: 'ai-3',
        title: 'Regulatory Compliance Gap',
        category: 'compliance',
        description: `Risk of non-compliance with regulations affecting ${processName}`,
        likelihood: 2,
        impact: 4,
        rationale: 'AI analysis of regulatory changes suggests potential compliance gaps'
      }
    ];
    
    container.innerHTML = `
      <div class="alert alert-info mb-3">
        <i class="bi bi-lightbulb me-2"></i>
        <strong>AI Analysis Complete!</strong> Based on your process, we've identified ${suggestions.length} potential risks.
      </div>
      ${suggestions.map(risk => `
        <div class="ai-risk-card" id="ai-risk-${risk.id}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="h6 mb-0">${risk.title}</h5>
            <span class="risk-category-badge risk-category-${risk.category}">
              ${risk.category}
            </span>
          </div>
          <p class="text-muted small mb-2">${risk.description}</p>
          <div class="bg-light rounded p-2 mb-3">
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              <strong>AI Rationale:</strong> ${risk.rationale}
            </small>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <div class="small">
              <span class="me-3">Suggested L: ${risk.likelihood}/5</span>
              <span>Suggested I: ${risk.impact}/5</span>
            </div>
            <div>
              <button class="btn btn-success btn-sm me-1" onclick="acceptRisk('${risk.id}')">
                <i class="bi bi-check me-1"></i>Accept
              </button>
              <button class="btn btn-warning btn-sm me-1" onclick="modifyRisk('${risk.id}')">
                <i class="bi bi-pencil me-1"></i>Modify
              </button>
              <button class="btn btn-danger btn-sm" onclick="rejectRisk('${risk.id}')">
                <i class="bi bi-x me-1"></i>Reject
              </button>
            </div>
          </div>
        </div>
      `).join('')}
    `;
  }, 2000);
}

// Risk action handlers
function editRisk(riskId) {
  console.log('Edit risk:', riskId);
  
  // Option 1: Use the EditRisk form in a modal (recommended for production)
  if (useModalForm()) {
    openEditRiskModal(riskId);
    return;
  }
  
  // Option 2: Inline editing (current implementation)
  // Find the risk data - handle case where dataverseRisks is undefined
  const risks = window.dataverseRisks || [];
  const risk = risks.find(r => r.id === riskId) || 
                { id: riskId, title: 'Mock Risk', description: 'Mock description', likelihood: 3, impact: 3 };
  
  // Create inline edit form
  const riskCard = document.querySelector(`[onclick="editRisk('${riskId}')"]`).closest('.risk-card');
  
  // Store original HTML for cancel
  const originalHTML = riskCard.innerHTML;
  // Store it as a data attribute to avoid escaping issues
  riskCard.setAttribute('data-original-html', originalHTML);
  
  // Replace with edit form
  riskCard.innerHTML = `
    <div class="edit-form">
      <div class="mb-3">
        <label class="form-label fw-bold">Risk Title</label>
        <input type="text" class="form-control" id="edit-title-${riskId}" value="${risk.title}">
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">Description</label>
        <textarea class="form-control" id="edit-desc-${riskId}" rows="3">${risk.description}</textarea>
      </div>
      <div class="row mb-3">
        <div class="col-6">
          <label class="form-label fw-bold">Likelihood (1-5)</label>
          <select class="form-select" id="edit-likelihood-${riskId}">
            <option value="1" ${risk.likelihood == 1 ? 'selected' : ''}>1 - Very Low</option>
            <option value="2" ${risk.likelihood == 2 ? 'selected' : ''}>2 - Low</option>
            <option value="3" ${risk.likelihood == 3 ? 'selected' : ''}>3 - Medium</option>
            <option value="4" ${risk.likelihood == 4 ? 'selected' : ''}>4 - High</option>
            <option value="5" ${risk.likelihood == 5 ? 'selected' : ''}>5 - Very High</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label fw-bold">Impact (1-5)</label>
          <select class="form-select" id="edit-impact-${riskId}">
            <option value="1" ${risk.impact == 1 ? 'selected' : ''}>1 - Very Low</option>
            <option value="2" ${risk.impact == 2 ? 'selected' : ''}>2 - Low</option>
            <option value="3" ${risk.impact == 3 ? 'selected' : ''}>3 - Medium</option>
            <option value="4" ${risk.impact == 4 ? 'selected' : ''}>4 - High</option>
            <option value="5" ${risk.impact == 5 ? 'selected' : ''}>5 - Very High</option>
          </select>
        </div>
      </div>
      <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-secondary btn-sm" onclick="cancelEdit('${riskId}')">
          <i class="bi bi-x me-1"></i>Cancel
        </button>
        <button class="btn btn-primary btn-sm" onclick="saveRisk('${riskId}')">
          <i class="bi bi-check me-1"></i>Save
        </button>
      </div>
    </div>
  `;
  
  // Focus on title input
  document.getElementById(`edit-title-${riskId}`).focus();
}

// Check if we should use modal form
function useModalForm() {
  // You can toggle this to switch between inline and modal editing
  return false; // Using inline editing to avoid page refresh issues
}

// Open EditRisk form in modal
function openEditRiskModal(riskId) {
  console.log('Opening edit modal for risk:', riskId);
  
  // Option 1: If you have the form rendered on the page with Liquid
  // The form would need to dynamically update its record ID
  
  // Option 2: For now, show a message about the form
  const formContainer = document.getElementById('editRiskFormContainer');
  formContainer.innerHTML = `
    <div class="alert alert-info">
      <h5>Edit Risk Form</h5>
      <p>To enable this form, add the following to this modal:</p>
      <code>{% entityform id: "4037ea60-e65d-f011-bec1-7c1e521687a7" %}</code>
      <hr>
      <p><strong>Risk ID:</strong> ${riskId}</p>
      <p>The form will load the risk data and allow editing.</p>
      <button class="btn btn-primary mt-3" onclick="saveViaWebAPI('${riskId}')">
        Save via Web API Instead
      </button>
    </div>
  `;
  
  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('editRiskModal'));
  modal.show();
}

// Alternative: Save via Web API (if enabled)
function saveViaWebAPI(riskId) {
  alert(`Would save risk ${riskId} via Power Pages Web API.\n\nTo enable:\n1. Go to Site Settings\n2. Enable Web API for cr129_risk table\n3. Implement the API call here`);
  
  // Example Web API code (when enabled):
  /*
  const data = {
    cr129_risktitle: "Updated Title",
    cr129_description: "Updated Description"
  };
  
  webapi.safeAjax({
    type: "PATCH",
    url: `/_api/cr129_risks(${riskId})`,
    contentType: "application/json",
    data: JSON.stringify(data),
    success: function() {
      alert("Risk updated!");
      location.reload();
    }
  });
  */
}

// Cancel editing
function cancelEdit(riskId) {
  const riskCard = document.querySelector('.edit-form').closest('.risk-card');
  const originalHTML = riskCard.getAttribute('data-original-html');
  if (originalHTML) {
    riskCard.innerHTML = originalHTML;
  } else {
    // Fallback: just reload the page
    loadExistingRisks();
  }
}

// Save risk changes using Web API
function saveRisk(riskId) {
  const title = document.getElementById(`edit-title-${riskId}`).value;
  const description = document.getElementById(`edit-desc-${riskId}`).value;
  const likelihood = document.getElementById(`edit-likelihood-${riskId}`).value;
  const impact = document.getElementById(`edit-impact-${riskId}`).value;
  
  console.log('üîç DEBUG: Saving risk via Web API:', { riskId, title, description, likelihood, impact });
  console.log('üîç DEBUG: webapi available?', typeof webapi !== 'undefined');
  console.log('üîç DEBUG: webapi.safeAjax available?', typeof webapi !== 'undefined' && webapi.safeAjax);
  console.log('üîç DEBUG: shell available?', typeof shell !== 'undefined');
  console.log('üîç DEBUG: shell.getTokenDeferred available?', typeof shell !== 'undefined' && shell.getTokenDeferred);
  console.log('üîç DEBUG: jQuery available?', typeof $ !== 'undefined');
  console.log('üîç DEBUG: Request token:', document.querySelector('input[name="__RequestVerificationToken"]')?.value);
  console.log('üîç DEBUG: Current user:', '{{ user.contactid | escape }}');
  
  // Show loading state
  const saveBtn = document.querySelector(`[onclick="saveRisk('${riskId}')"]`);
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
  saveBtn.disabled = true;
  
  // Prepare data for Web API
  const data = {
    cr129_risktitle: title,
    cr129_description: description,
    cr129_inherentlikelihood: parseInt(likelihood),
    cr129_inherentimpact: parseInt(impact)
  };
  
  // Try to use Web API if available
  if (typeof webapi !== 'undefined' && webapi.safeAjax) {
    // Use the corrected Web API wrapper with proper token handling
    webapi.update('cr129_risks', riskId, data)
      .done(function(response) {
        console.log('‚úÖ Risk saved successfully:', response);
        
        // Show success message
        showSuccessToast(`Risk "${title}" updated successfully!`);
        
        // Update local data
        const risks = window.dataverseRisks || [];
        const risk = risks.find(r => r.id === riskId);
        if (risk) {
          risk.title = title;
          risk.description = description;
          risk.likelihood = parseInt(likelihood);
          risk.impact = parseInt(impact);
        }
        
        // Refresh the display
        setTimeout(() => {
          loadExistingRisks();
        }, 500);
      })
      .fail(function(xhr, status, error) {
        console.error('‚ùå Error saving risk:', {
          status: xhr.status,
          statusText: xhr.statusText,
          responseText: xhr.responseText,
          error: error
        });
        
        // Restore button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        // Show detailed error information
        if (xhr.status === 401) {
          alert(`Web API Authentication Error (401)\n\nPlease ensure:\n1. Web API is enabled in Site Settings\n2. Table permissions are configured\n3. You are properly authenticated\n\nChanges saved locally only.`);
        } else if (xhr.status === 403) {
          alert(`Web API Permission Error (403)\n\nPlease ensure:\n1. Table permissions allow Web API access\n2. Your user role has proper permissions\n\nChanges saved locally only.`);
        } else {
          alert(`Web API Error (${xhr.status})\n\n${xhr.statusText}\n\nChanges saved locally only.`);
        }
        
        // For now, just update locally and show success
        console.log('Falling back to local update only');
        updateRiskLocally();
      });
  } else {
    // Fallback if Web API wrapper not available
    console.log('Web API wrapper not available, updating locally only');
    updateRiskLocally();
  }
  
  // Local update function
  function updateRiskLocally() {
    // Update local data
    const risks = window.dataverseRisks || [];
    const risk = risks.find(r => r.id === riskId);
    if (risk) {
      risk.title = title;
      risk.description = description;
      risk.likelihood = parseInt(likelihood);
      risk.impact = parseInt(impact);
    }
    
    // Show success message
    alert(`Risk "${title}" has been updated!\n\nNote: Changes are saved locally. To persist to database, Web API must be enabled.`);
    
    // Refresh the display
    loadExistingRisks();
  }
}

// Helper function to show success toast
function showSuccessToast(message) {
  // Create toast element
  const toastHtml = `
    <div class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-check-circle me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  // Add to page
  let toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toastContainer';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(toastContainer);
  }
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  // Show toast
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement);
  toast.show();
  
  // Remove after hidden
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

function acceptRisk(riskId) {
  console.log('Accept risk:', riskId);
  const card = document.getElementById(`ai-risk-${riskId}`);
  if (card) {
    card.classList.add('accepted');
    // In production, this would save to Dataverse
  }
}

function modifyRisk(riskId) {
  console.log('Modify risk:', riskId);
  // In production, this would open a form with pre-filled data
  alert('Modify functionality would open a pre-filled form here');
}

function rejectRisk(riskId) {
  console.log('Reject risk:', riskId);
  const card = document.getElementById(`ai-risk-${riskId}`);
  if (card) {
    card.classList.add('rejected');
  }
}

// Load custom risks from session storage and Dataverse
function loadCustomRisks() {
  const container = document.getElementById('customRisksContainer');
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  
  console.log('Loading custom risks for process:', processId);
  
  // Load from session storage (newly added in this session)
  const sessionCustomRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  
  // Filter by current process AND only show risks with source 'custom'
  const processCustomRisks = sessionCustomRisks.filter(risk => 
    risk.processId === processId && risk.source === 'custom'
  );
  
  console.log('üìã Found', processCustomRisks.length, 'custom risks for process');
  console.log('üìã All session risks:', sessionCustomRisks.length);
  
  window.customRisks = processCustomRisks;
  
  if (processCustomRisks.length > 0) {
    displayCustomRisks(processCustomRisks);
  } else {
    // Show empty state
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-plus-circle text-muted"></i>
        <h5 class="mt-3">No Custom Risks Added</h5>
        <p class="text-muted">Click "Add New Risk" in the section header to create custom risks for this process.</p>
      </div>
    `;
  }
}

// Display custom risks
function displayCustomRisks(risks) {
  const container = document.getElementById('customRisksContainer');
  
  const risksHtml = risks.map(risk => {
    const categoryMap = {
      '100000000': 'operational',
      '100000001': 'technology',
      '100000002': 'fraud',
      '100000003': 'compliance',
      '100000004': 'credit'
    };
    
    const categoryNames = {
      '100000000': 'Operational',
      '100000001': 'Technology',
      '100000002': 'Fraud',
      '100000003': 'Compliance',
      '100000004': 'Credit'
    };
    
    const categoryClass = categoryMap[risk.category] || 'operational';
    const categoryName = categoryNames[risk.category] || 'Operational';
    
    return `
      <div class="risk-card" id="custom-risk-${risk.id}">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <h5 class="h6 mb-0">${risk.title}</h5>
          <div class="d-flex align-items-center gap-2">
            <span class="risk-category-badge risk-category-${categoryClass}">
              ${categoryName}
            </span>
            <span class="badge bg-info">Custom</span>
          </div>
        </div>
        <p class="text-muted small mb-2">${risk.description}</p>
        <div class="d-flex justify-content-between align-items-center">
          <div class="small">
            <span class="me-3">Likelihood: ${risk.likelihood}/5</span>
            <span>Impact: ${risk.impact}/5</span>
          </div>
          <div class="btn-group">
            <button class="btn btn-outline-primary btn-sm" onclick="editCustomRisk('${risk.id}')">
              <i class="bi bi-pencil me-1"></i>Edit
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteCustomRisk('${risk.id}')">
              <i class="bi bi-trash me-1"></i>Delete
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Add the risks and a button to add more
  container.innerHTML = risksHtml + `
    <div class="text-center mt-3">
      <button class="btn btn-outline-primary" onclick="showAddRiskModal()">
        <i class="bi bi-plus-circle me-2"></i>Add Another Risk
      </button>
    </div>
  `;
}

// Show add risk modal
function showAddRiskModal() {
  console.log('üî• showAddRiskModal called - button clicked!');
  
  try {
    const processName = sessionStorage.getItem('rcsa_selected_process_name');
    
    // Debug: Check what's available in the DOM
    console.log('üîç Checking DOM elements...');
    console.log('üîç Modal element:', document.getElementById('addRiskModal'));
    console.log('üîç Form element:', document.getElementById('addRiskForm'));
    console.log('üîç All elements with "Risk" in ID:', 
      Array.from(document.querySelectorAll('[id*="Risk"]')).map(el => ({id: el.id, tagName: el.tagName})));
    
    // Wait for modal to be available
    const modalElement = document.getElementById('addRiskModal');
    if (!modalElement) {
      console.error('‚ùå Modal element not found!');
      console.log('üîç Document HTML contains modal?', document.documentElement.innerHTML.includes('addRiskModal'));
      alert('Error: Modal not found. Please refresh the page and try again.');
      return;
    }
    
    console.log('‚úÖ Modal element found:', modalElement);
    
    // Try to open modal first, then check for form
    console.log('üîç Bootstrap available?', typeof bootstrap !== 'undefined');
    
    if (typeof bootstrap !== 'undefined') {
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
      console.log('‚úÖ Bootstrap Modal show() called');
    } else {
      // Fallback: manually show modal
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
      console.log('‚úÖ Manual modal show() called');
    }
    
    // Wait a bit for modal to render, then setup form fields
    setTimeout(() => {
      console.log('üîç Setting up modal without form dependency...');
      
      // Check if form fields exist (they should based on your debug output)
      const titleField = document.getElementById('newRiskTitle');
      const categoryField = document.getElementById('newRiskCategory');
      const descriptionField = document.getElementById('newRiskDescription');
      const likelihoodField = document.getElementById('newRiskLikelihood');
      const impactField = document.getElementById('newRiskImpact');
      
      console.log('üîç Form fields check:', {
        title: !!titleField,
        category: !!categoryField,
        description: !!descriptionField,
        likelihood: !!likelihoodField,
        impact: !!impactField
      });
      
      if (!titleField || !categoryField || !descriptionField || !likelihoodField || !impactField) {
        console.error('‚ùå Some form fields not found!');
        alert('Error: Form fields not found. Please close and try again.');
        return;
      }
      
      console.log('‚úÖ All form fields found');
      
      // Update modal content
      const modalProcessName = document.getElementById('modalProcessName');
      if (modalProcessName) {
        modalProcessName.textContent = processName || 'Selected Process';
      }
      
      // Reset form fields manually (since form.reset() won't work)
      titleField.value = '';
      categoryField.value = '';
      descriptionField.value = '';
      likelihoodField.value = '';
      impactField.value = '';
      
      // Clear any previous validation errors
      document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
      document.querySelectorAll('.form-control, .form-select').forEach(el => {
        el.classList.remove('is-invalid');
      });
      
      console.log('‚úÖ Modal setup complete - form fields reset');
    }, 200);
    
  } catch (error) {
    console.error('‚ùå Error in showAddRiskModal:', error);
    alert('Error opening modal: ' + error.message);
  }
}

// Custom form validation
function validateRiskForm() {
  let isValid = true;
  
  // Clear previous errors
  document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
  document.querySelectorAll('.form-control, .form-select').forEach(el => {
    el.classList.remove('is-invalid');
  });
  
  // Validate title
  const title = document.getElementById('newRiskTitle').value.trim();
  if (!title) {
    document.getElementById('newRiskTitle').classList.add('is-invalid');
    document.getElementById('newRiskTitle-error').textContent = 'Risk title is required';
    isValid = false;
  } else if (title.length < 5) {
    document.getElementById('newRiskTitle').classList.add('is-invalid');
    document.getElementById('newRiskTitle-error').textContent = 'Risk title must be at least 5 characters';
    isValid = false;
  }
  
  // Validate category
  const category = document.getElementById('newRiskCategory').value;
  if (!category) {
    document.getElementById('newRiskCategory').classList.add('is-invalid');
    document.getElementById('newRiskCategory-error').textContent = 'Category is required';
    isValid = false;
  }
  
  // Validate description
  const description = document.getElementById('newRiskDescription').value.trim();
  if (!description) {
    document.getElementById('newRiskDescription').classList.add('is-invalid');
    document.getElementById('newRiskDescription-error').textContent = 'Description is required';
    isValid = false;
  } else if (description.length < 10) {
    document.getElementById('newRiskDescription').classList.add('is-invalid');
    document.getElementById('newRiskDescription-error').textContent = 'Description must be at least 10 characters';
    isValid = false;
  }
  
  // Validate likelihood
  const likelihood = document.getElementById('newRiskLikelihood').value;
  if (!likelihood) {
    document.getElementById('newRiskLikelihood').classList.add('is-invalid');
    document.getElementById('newRiskLikelihood-error').textContent = 'Likelihood is required';
    isValid = false;
  }
  
  // Validate impact
  const impact = document.getElementById('newRiskImpact').value;
  if (!impact) {
    document.getElementById('newRiskImpact').classList.add('is-invalid');
    document.getElementById('newRiskImpact-error').textContent = 'Impact is required';
    isValid = false;
  }
  
  return isValid;
}

// Save new custom risk
function saveNewRisk() {
  console.log('üî• saveNewRisk called - button clicked!');
  
  // Work directly with form fields since form element doesn't exist
  console.log('üîç Working without form element - checking fields directly...');
  
  // Check if form fields exist
  const titleField = document.getElementById('newRiskTitle');
  const categoryField = document.getElementById('newRiskCategory');
  const descriptionField = document.getElementById('newRiskDescription');
  const likelihoodField = document.getElementById('newRiskLikelihood');
  const impactField = document.getElementById('newRiskImpact');
  
  console.log('üîç Form fields check:', {
    title: !!titleField,
    category: !!categoryField,
    description: !!descriptionField,
    likelihood: !!likelihoodField,
    impact: !!impactField
  });
  
  if (!titleField || !categoryField || !descriptionField || !likelihoodField || !impactField) {
    console.error('‚ùå Some form fields not found!');
    alert('Error: Form fields not found. Please close the modal and try again.');
    return;
  }
  
  console.log('‚úÖ All form fields found - proceeding with save');
  
  // Continue with the rest of the function
  processSaveNewRisk();
}

// Process the actual save (separated for clarity)
function processSaveNewRisk() {
  console.log('üîÑ Processing save without form element...');
  
  // Validate form
  if (!validateRiskForm()) {
    console.log('‚ùå Form validation failed');
    return;
  }
  
  console.log('‚úÖ Form validation passed');
  
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  const processName = sessionStorage.getItem('rcsa_selected_process_name');
  
  // Get form data
  const formData = {
    title: document.getElementById('newRiskTitle').value.trim(),
    category: document.getElementById('newRiskCategory').value,
    description: document.getElementById('newRiskDescription').value.trim(),
    likelihood: parseInt(document.getElementById('newRiskLikelihood').value),
    impact: parseInt(document.getElementById('newRiskImpact').value)
  };
  
  console.log('üìù Creating new custom risk:', formData);
  
  // Show loading state
  const saveBtn = document.querySelector('#addRiskModal .btn-primary');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Creating...';
  saveBtn.disabled = true;
  
  // Create risk data for Dataverse
  const riskData = {
    cr129_risktitle: formData.title,
    cr129_description: formData.description,
    cr129_riskcategory: parseInt(formData.category),
    cr129_inherentlikelihood: formData.likelihood,
    cr129_inherentimpact: formData.impact,
    'cr129_processname@odata.bind': `/cr129_procs('${processId}')`
  };
  
  // Try to save to Dataverse via Web API
  if (typeof webapi !== 'undefined' && webapi.safeAjax) {
    console.log('üîÑ Attempting Web API create...');
    console.log('üîÑ Risk data:', riskData);
    console.log('üîÑ Endpoint: /_api/cr129_risks');
    
    webapi.create('cr129_risks', riskData)
      .done(function(response) {
        console.log('‚úÖ Risk created successfully in Dataverse:', response);
        
        // Create local risk object
        const newRisk = {
          id: response && response.cr129_riskid ? response.cr129_riskid : 'temp-' + Date.now(),
          title: formData.title,
          category: formData.category,
          description: formData.description,
          likelihood: formData.likelihood,
          impact: formData.impact,
          processId: processId,
          processName: processName,
          isCustom: true,
          source: 'custom',
          createdAt: new Date().toISOString()
        };
        
        // Add to local storage and display
        addCustomRiskToStorage(newRisk);
        
        // Show success message
        showSuccessToast(`Risk "${formData.title}" created successfully!`);
        
        // Close modal and refresh display
        bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
        loadCustomRisks();
      })
      .fail(function(xhr, status, error) {
        console.error('‚ùå Error creating risk:', xhr.status, xhr.statusText);
        console.error('‚ùå Full error details:', { xhr, status, error });
        console.error('‚ùå Response text:', xhr.responseText);
        console.error('‚ùå Response headers:', xhr.getAllResponseHeaders());
        
        // Try to parse error response
        try {
          const errorResponse = JSON.parse(xhr.responseText);
          console.error('‚ùå Parsed error response:', errorResponse);
        } catch (e) {
          console.error('‚ùå Could not parse error response as JSON');
        }
        
        // Fallback: Save locally only
        console.log('Falling back to local storage only');
        
        const newRisk = {
          id: 'custom-' + Date.now(),
          title: formData.title,
          category: formData.category,
          description: formData.description,
          likelihood: formData.likelihood,
          impact: formData.impact,
          processId: processId,
          processName: processName,
          isCustom: true,
          source: 'custom',
          createdAt: new Date().toISOString()
        };
        
        addCustomRiskToStorage(newRisk);
        
        // Show warning message
        showWarningToast(`Risk "${formData.title}" saved locally. Database save failed: ${xhr.status} ${xhr.statusText}`);
        
        // Close modal and refresh display
        bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
        loadCustomRisks();
      })
      .always(function() {
        // Restore button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      });
  } else {
    // Web API not available, save locally only
    console.log('Web API not available, saving locally only');
    
    const newRisk = {
      id: 'custom-' + Date.now(),
      title: formData.title,
      category: formData.category,
      description: formData.description,
      likelihood: formData.likelihood,
      impact: formData.impact,
      processId: processId,
      processName: processName,
      isCustom: true,
      createdAt: new Date().toISOString()
    };
    
    addCustomRiskToStorage(newRisk);
    
    // Show info message
    showInfoToast(`Risk "${formData.title}" saved locally. Web API not available.`);
    
    // Close modal and refresh display
    bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
    loadCustomRisks();
    
    // Restore button
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// Add custom risk to session storage
function addCustomRiskToStorage(risk) {
  const existingRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  existingRisks.push(risk);
  sessionStorage.setItem('rcsa_custom_risks', JSON.stringify(existingRisks));
  
  // Update global variable
  window.customRisks = existingRisks.filter(r => r.processId === risk.processId);
}

// Edit custom risk
function editCustomRisk(riskId) {
  const risk = window.customRisks.find(r => r.id === riskId);
  if (!risk) {
    console.error('Risk not found:', riskId);
    return;
  }
  
  // Populate form with existing data
  document.getElementById('newRiskTitle').value = risk.title;
  document.getElementById('newRiskCategory').value = risk.category;
  document.getElementById('newRiskDescription').value = risk.description;
  document.getElementById('newRiskLikelihood').value = risk.likelihood;
  document.getElementById('newRiskImpact').value = risk.impact;
  
  // Update modal title and button
  document.querySelector('#addRiskModal .modal-title').textContent = 'Edit Risk';
  document.querySelector('#addRiskModal .btn-primary').innerHTML = '<i class="bi bi-check-circle me-1"></i>Update Risk';
  
  // Set up form for editing
  const form = document.getElementById('addRiskForm');
  form.onsubmit = function(e) {
    e.preventDefault();
    console.log('Edit form submit event triggered');
    updateCustomRisk(riskId);
  };
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('addRiskModal'));
  modal.show();
}

// Update custom risk
function updateCustomRisk(riskId) {
  console.log('updateCustomRisk called for:', riskId);
  const form = document.getElementById('addRiskForm');
  
  if (!form) {
    console.error('Form not found! addRiskForm element is null');
    alert('Error: Form not found. Please try again.');
    return;
  }
  
  console.log('Form found:', form);
  console.log('Form validation passed (handled by browser)');
  
  // Get form data
  const formData = {
    title: document.getElementById('newRiskTitle').value.trim(),
    category: document.getElementById('newRiskCategory').value,
    description: document.getElementById('newRiskDescription').value.trim(),
    likelihood: parseInt(document.getElementById('newRiskLikelihood').value),
    impact: parseInt(document.getElementById('newRiskImpact').value)
  };
  
  console.log('Updating custom risk:', riskId, formData);
  
  // Show loading state
  const saveBtn = document.querySelector('#addRiskModal .btn-primary');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Updating...';
  saveBtn.disabled = true;
  
  // Update risk data for Dataverse
  const riskData = {
    cr129_risktitle: formData.title,
    cr129_description: formData.description,
    cr129_riskcategory: parseInt(formData.category),
    cr129_inherentlikelihood: formData.likelihood,
    cr129_inherentimpact: formData.impact
  };
  
  // Try to update in Dataverse via Web API
  if (typeof webapi !== 'undefined' && webapi.safeAjax && !riskId.startsWith('custom-')) {
    webapi.update('cr129_risks', riskId, riskData)
      .done(function(response) {
        console.log('‚úÖ Risk updated successfully in Dataverse');
        
        // Update local storage
        updateCustomRiskInStorage(riskId, formData);
        
        // Show success message
        showSuccessToast(`Risk "${formData.title}" updated successfully!`);
        
        // Close modal and refresh display
        bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
        resetAddRiskModal();
        loadCustomRisks();
      })
      .fail(function(xhr, status, error) {
        console.error('‚ùå Error updating risk:', xhr.status, xhr.statusText);
        
        // Fallback: Update locally only
        updateCustomRiskInStorage(riskId, formData);
        
        // Show warning message
        showWarningToast(`Risk "${formData.title}" updated locally. Database update failed: ${xhr.status} ${xhr.statusText}`);
        
        // Close modal and refresh display
        bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
        resetAddRiskModal();
        loadCustomRisks();
      })
      .always(function() {
        // Restore button
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
      });
  } else {
    // Local-only risk or Web API not available
    updateCustomRiskInStorage(riskId, formData);
    
    // Show info message
    showInfoToast(`Risk "${formData.title}" updated locally.`);
    
    // Close modal and refresh display
    bootstrap.Modal.getInstance(document.getElementById('addRiskModal')).hide();
    resetAddRiskModal();
    loadCustomRisks();
    
    // Restore button
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// Update custom risk in storage
function updateCustomRiskInStorage(riskId, formData) {
  const existingRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  const riskIndex = existingRisks.findIndex(r => r.id === riskId);
  
  if (riskIndex !== -1) {
    existingRisks[riskIndex] = {
      ...existingRisks[riskIndex],
      title: formData.title,
      category: formData.category,
      description: formData.description,
      likelihood: formData.likelihood,
      impact: formData.impact,
      updatedAt: new Date().toISOString()
    };
    
    sessionStorage.setItem('rcsa_custom_risks', JSON.stringify(existingRisks));
    
    // Update global variable
    const processId = sessionStorage.getItem('rcsa_selected_process_id');
    window.customRisks = existingRisks.filter(r => r.processId === processId);
  }
}

// Delete custom risk
function deleteCustomRisk(riskId) {
  const risk = window.customRisks.find(r => r.id === riskId);
  if (!risk) {
    console.error('Risk not found:', riskId);
    return;
  }
  
  // Confirm deletion
  if (!confirm(`Are you sure you want to delete the risk "${risk.title}"?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  console.log('Deleting custom risk:', riskId);
  
  // Show loading state
  const riskCard = document.getElementById(`custom-risk-${riskId}`);
  if (riskCard) {
    riskCard.style.opacity = '0.5';
    riskCard.style.pointerEvents = 'none';
  }
  
  // Try to delete from Dataverse via Web API
  if (typeof webapi !== 'undefined' && webapi.safeAjax && !riskId.startsWith('custom-')) {
    webapi.delete('cr129_risks', riskId)
      .done(function(response) {
        console.log('‚úÖ Risk deleted successfully from Dataverse');
        
        // Remove from local storage
        removeCustomRiskFromStorage(riskId);
        
        // Show success message
        showSuccessToast(`Risk "${risk.title}" deleted successfully!`);
        
        // Refresh display
        loadCustomRisks();
      })
      .fail(function(xhr, status, error) {
        console.error('‚ùå Error deleting risk:', xhr.status, xhr.statusText);
        
        // Fallback: Remove locally only
        removeCustomRiskFromStorage(riskId);
        
        // Show warning message
        showWarningToast(`Risk "${risk.title}" removed locally. Database deletion failed: ${xhr.status} ${xhr.statusText}`);
        
        // Refresh display
        loadCustomRisks();
      });
  } else {
    // Local-only risk or Web API not available
    removeCustomRiskFromStorage(riskId);
    
    // Show info message
    showInfoToast(`Risk "${risk.title}" removed locally.`);
    
    // Refresh display
    loadCustomRisks();
  }
}

// Remove custom risk from storage
function removeCustomRiskFromStorage(riskId) {
  const existingRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  const filteredRisks = existingRisks.filter(r => r.id !== riskId);
  sessionStorage.setItem('rcsa_custom_risks', JSON.stringify(filteredRisks));
  
  // Update global variable
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  window.customRisks = filteredRisks.filter(r => r.processId === processId);
}

// Reset add risk modal to default state
function resetAddRiskModal() {
  document.querySelector('#addRiskModal .modal-title').textContent = 'Add New Risk';
  document.querySelector('#addRiskModal .btn-primary').innerHTML = '<i class="bi bi-check-circle me-1"></i>Add Risk';
  
  // Reset form submit handler to default
  const form = document.getElementById('addRiskForm');
  form.onsubmit = function(e) {
    e.preventDefault();
    console.log('Add form submit event triggered');
    saveNewRisk();
  };
}

// Helper function to show warning toast
function showWarningToast(message) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-warning border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-exclamation-triangle me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  showToast(toastHtml);
}

// Helper function to show info toast
function showInfoToast(message) {
  const toastHtml = `
    <div class="toast align-items-center text-white bg-info border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">
          <i class="bi bi-info-circle me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  showToast(toastHtml);
}

// Generic toast display function
function showToast(toastHtml) {
  let toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toastContainer';
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(toastContainer);
  }
  
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  
  const toastElement = toastContainer.lastElementChild;
  const toast = new bootstrap.Toast(toastElement);
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

function continueToControlMapping() {
  console.log('üîÑ Preparing to continue to Control Mapping...');
  
  // Get current process ID
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  console.log('üîç Current process ID:', processId);
  
  // Collect all risks that should be passed to Control Mapping
  const risksToPass = [];
  
  // 1. ALL EXISTING RISKS (always included)
  console.log('üìã Collecting existing risks...');
  if (window.dataverseRisks && window.dataverseRisks.length > 0) {
    const existingRisks = window.dataverseRisks.filter(risk => risk.processId === processId);
    console.log('üìã Found', existingRisks.length, 'existing risks for process');
    risksToPass.push(...existingRisks.map(risk => ({
      ...risk,
      source: 'existing'
    })));
  } else {
    // Use mock existing risks if no real data
    console.log('üìã Using mock existing risks');
    const mockExistingRisks = [
      {
        id: 'mock-1',
        title: 'Wire Transfer Fraud (Mock)',
        category: 'fraud',
        description: 'Risk of unauthorized wire transfers due to compromised credentials',
        likelihood: 3,
        impact: 5,
        processId: processId,
        source: 'existing'
      },
      {
        id: 'mock-2',
        title: 'System Downtime (Mock)',
        category: 'operational',
        description: 'Wire transfer system unavailability affecting customer transactions',
        likelihood: 2,
        impact: 4,
        processId: processId,
        source: 'existing'
      }
    ];
    risksToPass.push(...mockExistingRisks);
  }
  
  // 2. ACCEPTED AI SUGGESTIONS (only those marked as accepted)
  console.log('üìã Collecting accepted AI suggestions...');
  const acceptedAiRisks = [];
  const aiRiskCards = document.querySelectorAll('.ai-risk-card.accepted');
  aiRiskCards.forEach(card => {
    const riskId = card.id.replace('ai-risk-', '');
    console.log('üìã Found accepted AI risk:', riskId);
    
    // Create AI risk object (you may need to adjust this based on your AI risk structure)
    const aiRisk = {
      id: `ai-${riskId}`,
      title: card.querySelector('h5').textContent,
      description: card.querySelector('p.text-muted').textContent,
      category: card.querySelector('.risk-category-badge').textContent.trim(),
      likelihood: 3, // Default or extract from UI
      impact: 3, // Default or extract from UI
      processId: processId,
      source: 'ai-accepted'
    };
    acceptedAiRisks.push(aiRisk);
  });
  console.log('üìã Found', acceptedAiRisks.length, 'accepted AI risks');
  risksToPass.push(...acceptedAiRisks);
  
  // 3. CUSTOM RISKS (those added by user)
  console.log('üìã Collecting custom risks...');
  if (window.customRisks && window.customRisks.length > 0) {
    const customRisks = window.customRisks.filter(risk => 
      risk.processId === processId && risk.source === 'custom'
    );
    console.log('üìã Found', customRisks.length, 'custom risks');
    risksToPass.push(...customRisks);
  }
  
  // Update session storage with all risks to pass
  console.log('üìã Total risks to pass to Control Mapping:', risksToPass.length);
  console.log('üìã Breakdown:', {
    existing: risksToPass.filter(r => r.source === 'existing').length,
    aiAccepted: risksToPass.filter(r => r.source === 'ai-accepted').length,
    custom: risksToPass.filter(r => r.source === 'custom').length
  });
  
  // Get all risks from session storage and update
  const allRisks = JSON.parse(sessionStorage.getItem('rcsa_custom_risks') || '[]');
  
  // Remove existing risks for this process
  const otherProcessRisks = allRisks.filter(risk => risk.processId !== processId);
  
  // Add all risks to pass
  const updatedRisks = [...otherProcessRisks, ...risksToPass];
  
  // Save to session storage
  sessionStorage.setItem('rcsa_custom_risks', JSON.stringify(updatedRisks));
  console.log('‚úÖ Updated session storage with', updatedRisks.length, 'total risks');
  
  // Always continue - no validation needed since existing risks are always included
  console.log('‚úÖ Continuing to Control Mapping with', risksToPass.length, 'risks');
  window.location.href = '/Control-Mapping-Overview';
}

// Test Web API setup
function testWebApi() {
  console.log('üß™ COMPREHENSIVE WEB API DIAGNOSTIC TEST');
  console.log('==========================================');
  
  // 1. Check basic availability
  console.log('1. BASIC AVAILABILITY CHECK:');
  console.log('üîç webapi object:', typeof webapi !== 'undefined' ? webapi : 'Not available');
  console.log('üîç webapi.safeAjax:', typeof webapi !== 'undefined' && webapi.safeAjax ? 'Available' : 'Not available');
  console.log('üîç shell object:', typeof shell !== 'undefined' ? shell : 'Not available');
  console.log('üîç shell.getTokenDeferred:', typeof shell !== 'undefined' && shell.getTokenDeferred ? 'Available' : 'Not available');
  console.log('üîç jQuery:', typeof $ !== 'undefined' ? $.fn.jquery : 'Not available');
  console.log('üîç Request token:', document.querySelector('input[name="__RequestVerificationToken"]')?.value || 'Not found');
  
  // 2. Test GET request first
  console.log('\n2. TESTING GET REQUEST:');
  if (typeof webapi !== 'undefined' && webapi.safeAjax) {
    webapi.safeAjax({
      url: "/_api/cr129_risks",
      type: "GET",
      contentType: "application/json; charset=utf-8"
    })
    .done(function(response) {
      console.log('‚úÖ GET request successful:', response);
      
      // 3. Test simple POST without relationships
      console.log('\n3. TESTING SIMPLE POST (no relationships):');
             const simpleData = {
         cr129_risktitle: "Test Risk - " + new Date().toISOString(),
         cr129_description: "Test description",
         cr129_riskcategory: 0, // Operational (0-4 range)
         cr129_inherentlikelihood: 3,
         cr129_inherentimpact: 3
       };
      
             webapi.safeAjax({
         url: "/_api/cr129_risks",
         type: "POST",
         contentType: "application/json; charset=utf-8",
         headers: {
           'OData-Version': '4.0',
           'Prefer': 'return=representation'
         },
         data: JSON.stringify(simpleData)
       })
      .done(function(response) {
        console.log('‚úÖ Simple POST successful:', response);
        alert('‚úÖ Simple POST works! The issue is with relationships.');
        
                 // Clean up - delete the test record
         if (response && response.cr129_riskid) {
           webapi.safeAjax({
             url: "/_api/cr129_risks(" + response.cr129_riskid + ")",
             type: "DELETE",
             headers: { 'If-Match': '*' }
           })
           .done(function() {
             console.log('üóëÔ∏è Test record cleaned up');
           });
         }
      })
      .fail(function(xhr, status, error) {
        console.error('‚ùå Simple POST failed:', {
          status: xhr.status,
          statusText: xhr.statusText,
          responseText: xhr.responseText,
          headers: xhr.getAllResponseHeaders()
        });
        alert(`‚ùå Simple POST failed: ${xhr.status} ${xhr.statusText}\n\nCheck console for details.`);
      });
      
    })
    .fail(function(xhr, status, error) {
      console.error('‚ùå GET request failed:', {
        status: xhr.status,
        statusText: xhr.statusText,
        responseText: xhr.responseText,
        headers: xhr.getAllResponseHeaders()
      });
      alert(`‚ùå GET request failed: ${xhr.status} ${xhr.statusText}\n\nBasic Web API access is blocked.`);
    });
  } else {
    console.error('‚ùå webapi.safeAjax not available');
    alert('‚ùå webapi.safeAjax not available. Web API wrapper failed to load.');
  }
}

// Test Web API with relationship (the failing scenario)
function testWebApiWithRelationship() {
  console.log('üß™ TESTING WEB API WITH RELATIONSHIP');
  console.log('====================================');
  
  const processId = sessionStorage.getItem('rcsa_selected_process_id');
  console.log('üîç Process ID:', processId);
  
  if (!processId) {
    alert('‚ùå No process selected. Please select a process first.');
    return;
  }
  
     const dataWithRelationship = {
     cr129_risktitle: "Test Risk with Relationship - " + new Date().toISOString(),
     cr129_description: "Test description with relationship",
     cr129_riskcategory: 0, // Operational (0-4 range)
     cr129_inherentlikelihood: 3,
     cr129_inherentimpact: 3,
     'cr129_processname@odata.bind': `/cr129_procs('${processId}')`
   };
  
  console.log('üîç Data being sent:', dataWithRelationship);
  
     webapi.safeAjax({
     url: "/_api/cr129_risks",
     type: "POST",
     contentType: "application/json; charset=utf-8",
     headers: {
       'OData-Version': '4.0',
       'Prefer': 'return=representation'
     },
     data: JSON.stringify(dataWithRelationship)
   })
  .done(function(response) {
    console.log('‚úÖ POST with relationship successful:', response);
    alert('‚úÖ POST with relationship works!');
    
         // Clean up
     if (response && response.cr129_riskid) {
       webapi.safeAjax({
         url: "/_api/cr129_risks(" + response.cr129_riskid + ")",
         type: "DELETE",
         headers: { 'If-Match': '*' }
       })
       .done(function() {
         console.log('üóëÔ∏è Test record cleaned up');
       });
     }
  })
  .fail(function(xhr, status, error) {
    console.error('‚ùå POST with relationship failed:', {
      status: xhr.status,
      statusText: xhr.statusText,
      responseText: xhr.responseText,
      headers: xhr.getAllResponseHeaders()
    });
    
    // Parse error response
    try {
      const errorResponse = JSON.parse(xhr.responseText);
      console.error('‚ùå Parsed error:', errorResponse);
      alert(`‚ùå POST with relationship failed: ${xhr.status} ${xhr.statusText}\n\nError: ${errorResponse.error.message}`);
    } catch (e) {
      alert(`‚ùå POST with relationship failed: ${xhr.status} ${xhr.statusText}\n\nCheck console for details.`);
    }
  });
}
</script> 